<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Clube do Cavalo – eventos, associados, diretoria e parcerias.">
  <meta property="og:image" content="https://clubedocavalobonfim.com.br/assets/img/logo_CCBMG.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://clubedocavalobonfim.com.br/assets/css/custom.css">
  <script src="https://sdk.mercadopago.com/js/v2"></script>

  <link rel="icon" type="image/png" href="assets/img/logo_CCBMG.png">
  <link rel="shortcut icon" href="assets/img/logo_CCBMG.png" type="image/png">

  <style>
    .bg-primary { background-color: #111279 !important; }
    .btn-primary { background-color: #111279 !important; border-color: #111279 !important; }
    .btn-outline-primary { color: #111279 !important; border-color: #111279 !important; }
    .text-primary { color: #111279 !important; }
    .plan-card:hover { box-shadow: 0 .5rem 1rem rgba(0,0,0,.08); }
    .badge-save { background:#2a9d8f; }
    .brand-logo{ height: 36px; width:auto; margin-right:.5rem; object-fit:contain; filter:brightness(0) invert(1); }
    @media (min-width: 992px){ .brand-logo{ height:42px; } }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <img class="brand-logo" src="assets/img/logo_CCBMG.png?v=ccbmg-2025-09-10d" alt="Logo Clube do Cavalo">
    <a class="navbar-brand fw-bold" href="index.html">Clube do Cavalo - Bonfim MG</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Alternar navegação">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="events.html">Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="partners.html">Parcerias</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Fotos</a></li>
        <li class="nav-item"><a class="nav-link" href="board.html">Diretoria</a></li>
        <li class="nav-item"><a class="nav-link" href="sobre.html">Sobre o Clube</a></li>
        <li class="nav-item"><a class="btn btn-light text-primary ms-lg-3" href="login.html">Área do Associado</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container my-4">
  <h1 class="h4 mb-1">Pagamento da Associação</h1>
  <!-- CPF -->
  <p id="cpfInfo" class="small text-secondary mb-1 d-none"></p>
  <!-- Nome do titular (novo) -->
  <p id="titularInfo" class="small text-secondary mb-2 d-none"></p>

  <p class="text-muted">Selecione o período desejado e conclua o pagamento para ativar sua associação.</p>

  <div class="mb-3">
    <button id="btnVoltar" class="btn btn-outline-secondary">← Voltar</button>
  </div>

  <!-- Planos -->
  <div class="row g-3" id="planos">
    <div class="col-md-4">
      <label class="card h-100 p-0 plan-card">
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="plano" id="planoMensal" value="mensal">
            <label class="form-check-label fw-semibold" for="planoMensal">Mensal</label>
          </div>
          <div class="mt-2">
            <div class="fs-4 fw-bold">R$ 30</div>
            <div class="text-muted small">Renovação a cada mês</div>
          </div>
        </div>
      </label>
    </div>

    <div class="col-md-4">
      <label class="card h-100 p-0 plan-card">
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="plano" id="planoTrimestral" value="trimestral">
            <label class="form-check-label fw-semibold" for="planoTrimestral">Trimestral</label>
          </div>
          <div class="mt-2">
            <div class="d-flex align-items-center gap-2">
              <div class="fs-4 fw-bold">R$ 85</div>
              <span class="badge badge-save">-4%</span>
            </div>
            <div class="text-muted small">Você economiza em relação ao mensal</div>
          </div>
        </div>
      </label>
    </div>

    <div class="col-md-4">
      <label class="card h-100 p-0 plan-card">
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="plano" id="planoSemestral" value="semestral">
            <label class="form-check-label fw-semibold" for="planoSemestral">Semestral</label>
          </div>
          <div class="mt-2">
            <div class="d-flex align-items-center gap-2">
              <div class="fs-4 fw-bold">R$ 170</div>
              <span class="badge badge-save">-8%</span>
            </div>
            <div class="text-muted small">Mais economia por semestre</div>
          </div>
        </div>
      </label>
    </div>
  </div>

  <!-- Ações -->
  <div class="card mt-3">
    <div class="card-body">
      <div id="selecionado" class="mb-3 text-secondary">Nenhum plano selecionado.</div>

      <div class="d-grid gap-2 d-none" id="actionsRow">
        <button id="btnCartao" class="btn btn-primary">Pagar com Cartão</button>
        <button id="btnPix" class="btn btn-outline-primary">Gerar PIX (código e QR)</button>
        <button id="btnBoleto" class="btn btn-outline-secondary">Gerar Boleto</button>
      </div>

      <p class="text-muted mt-3 mb-0" id="msg"></p>
    </div>
  </div>

  <!-- Resultado PIX/BOLETO -->
  <div id="offlineResult" class="mt-3"></div>

  <div id="paymentBrick_container" class="mt-3"></div>

  <div class="alert alert-secondary mt-3 mb-0 small" role="note">
    <strong>Quer plano anual ou outras condições (ex.: familiar, infantil, etc)?</strong>
    <a class="link-underline link-underline-opacity-0" href="https://wa.me/5531986685028?text=Olá!%20Gostaria%20de%20conversar%20sobre%20planos%20da%20associação%20do%20Clube%20do%20Cavalo." target="_blank" rel="noopener">
      Entre em contato com a Diretoria do Clube para combinar a melhor opção.
    </a>
  </div>
</main>

<footer class="mt-5 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> — Promovendo a cultura equestre.</div>
    <div class="text-secondary small text-center">© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gestão de Clubes e Associações Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    doc, getDoc, setDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // ====== CHAVE DO MP (Teste) ======
  const MP_PUBLIC_KEY = "APP_USR-ca3cc7b3-cb84-446e-b162-b2bdf9a94a48"; // substitua se necessário

  // ====== API BASE (seu backend na Vercel) ======
  const API_BASE = "https://ccbmg-payments-api.vercel.app";

  // Elementos
  const selecionadoEl = document.getElementById("selecionado");
  const msg           = document.getElementById("msg");
  const cpfInfo       = document.getElementById("cpfInfo");
  const titularInfo   = document.getElementById("titularInfo");
  const radios        = Array.from(document.querySelectorAll('input[name="plano"]'));
  const brickDiv      = document.getElementById("paymentBrick_container");
  const btnVoltar     = document.getElementById("btnVoltar");
  const actionsRow    = document.getElementById("actionsRow");
  const btnCartao     = document.getElementById("btnCartao");
  const btnPix        = document.getElementById("btnPix");
  const btnBoleto     = document.getElementById("btnBoleto");
  const offlineDiv    = document.getElementById("offlineResult");

  let uid = null;
  let userEmail = null;
  let userCPF = null;
  let userFullName = null;
  let firstName = null;
  let lastName = null;
  let planoSelecionado = null;

  // Controle MP Brick
  let bricksBuilder = null;
  let paymentBrickController = null;

  // Controle de fatura (invoice) para redirecionamento automático
  let currentInvoiceId = null;
  let stopInvoiceWatch = null;

  const LABELS = {
    mensal: "Mensal — R$ 30",
    trimestral: "Trimestral — R$ 85 (4% off)",
    semestral: "Semestral — R$ 170 (8% off)",
  };
  const PRICE = { mensal:30, trimestral:85, semestral:170 };

  btnVoltar.addEventListener("click", async () => {
    try { await signOut(auth); } catch(e){ console.warn(e); }
    window.location.href = "index.html";
  });

  // ===== Assinatura da fatura criada no backend =====
  function watchInvoice(invoiceId){
    if (!uid || !invoiceId) return;
    currentInvoiceId = invoiceId;
    // limpa listener anterior
    if (stopInvoiceWatch) { stopInvoiceWatch(); stopInvoiceWatch = null; }
    const invRef = doc(db, "users", uid, "financeInvoices", invoiceId);
    stopInvoiceWatch = onSnapshot(invRef, (snap) => {
      const d = snap.data() || {};
      const st = String(d.status || "").toLowerCase();
      if (st === "pago") {
        if (stopInvoiceWatch) { stopInvoiceWatch(); stopInvoiceWatch = null; }
        window.location.href = "pay-success.html";
      }
    });
  }

  // Handlers dos botões
  if (btnCartao) {
    btnCartao.addEventListener("click", async (e)=>{
      e.preventDefault();
      await renderPaymentBrick();
      brickDiv.scrollIntoView({ behavior: "smooth" });
    });
  }
  if (btnPix) {
    btnPix.addEventListener("click", async (e)=>{
      e.preventDefault();
      await gerarPix();
    });
  }
  if (btnBoleto) {
    btnBoleto.addEventListener("click", async (e)=>{
      e.preventDefault();
      await gerarBoleto();
    });
  }

  function maskCPF(v){
    const s = String(v || "").replace(/\D/g,"").slice(0,11);
    if (s.length < 11) return s;
    return s.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4");
  }

  function showCPFInfo(){
    if (userCPF) {
      cpfInfo.textContent = `CPF do associado: ${maskCPF(userCPF)}`;
      cpfInfo.classList.remove("d-none");
    } else {
      cpfInfo.textContent = "CPF do associado: (não informado)";
      cpfInfo.classList.remove("d-none");
    }
  }

  function showTitularInfo(){
    if (userFullName) {
      titularInfo.textContent = `Titular (nome cadastrado): ${userFullName}`;
      titularInfo.classList.remove("d-none");
    } else {
      titularInfo.textContent = "Titular (nome cadastrado): (não informado)";
      titularInfo.classList.remove("d-none");
    }
  }

  function splitName(fullName){
    const s = String(fullName || "").trim().replace(/\s+/g," ");
    if (!s) return { first: null, last: null };
    const parts = s.split(" ");
    if (parts.length === 1) return { first: parts[0], last: "" };
    const last = parts.pop();
    const first = parts.join(" ");
    return { first, last };
  }

  function atualizarUIPlano(){
    if (offlineDiv) offlineDiv.innerHTML = "";
    if (brickDiv)   brickDiv.innerHTML   = "";
    if (!planoSelecionado) {
      selecionadoEl.textContent = "Nenhum plano selecionado.";
      if (actionsRow) actionsRow.classList.add("d-none");
      return;
    }
    selecionadoEl.textContent = `Plano selecionado: ${LABELS[planoSelecionado]}`;
    if (actionsRow) actionsRow.classList.remove("d-none");

    // Troca de plano: encerra watcher da fatura anterior
    if (stopInvoiceWatch) { stopInvoiceWatch(); stopInvoiceWatch = null; }
    currentInvoiceId = null;
  }

  function renderPixUI(data){
    const a = data?.next_action || {};
    const code = a.copy_and_paste || a.qr || "";
    const qr64 = a.qr_base64 || "";
    const link = a.link || "";

    offlineDiv.innerHTML = `
      <div class="card">
        <div class="card-body">
          <h6 class="mb-2">PIX gerado</h6>
          ${qr64 ? `<img alt="QR PIX" class="img-fluid mb-2" src="data:image/png;base64,${qr64}">` : ""}
          ${code ? `
            <label class="form-label small text-secondary">Código copia e cola</label>
            <div class="input-group mb-2">
              <input id="pixCode" class="form-control" value="${code}" readonly>
              <button class="btn btn-outline-secondary" type="button" id="btnCopyPix">Copiar</button>
            </div>
          ` : ""}
          ${link ? `<a class="btn btn-sm btn-outline-primary" href="${link}" target="_blank" rel="noopener">Abrir no banco</a>` : ""}
          <p class="small text-muted mt-2 mb-0">Assim que o PIX for aprovado, seu acesso será liberado automaticamente.</p>
        </div>
      </div>`;
    const copyBtn = document.getElementById("btnCopyPix");
    if (copyBtn) copyBtn.onclick = () => {
      const inp = document.getElementById("pixCode");
      inp.select(); inp.setSelectionRange(0, 99999);
      document.execCommand("copy");
      copyBtn.textContent = "Copiado!";
      setTimeout(() => copyBtn.textContent = "Copiar", 1500);
    };
  }

  function renderBoletoUI(data){
    const a = data?.next_action || {};
    const barcode = a.barcode || "";
    const link = a.link || "";
    offlineDiv.innerHTML = `
      <div class="card">
        <div class="card-body">
          <h6 class="mb-2">Boleto gerado</h6>
          ${barcode ? `
            <label class="form-label small text-secondary">Linha digitável</label>
            <div class="input-group mb-2">
              <input id="boletoCode" class="form-control" value="${barcode}" readonly>
              <button class="btn btn-outline-secondary" type="button" id="btnCopyBoleto">Copiar</button>
            </div>
          ` : ""}
          ${link ? `<a class="btn btn-sm btn-outline-primary" href="${link}" target="_blank" rel="noopener">Abrir boleto (PDF)</a>` : ""}
          <p class="small text-muted mt-2 mb-0">Após a compensação bancária, seu acesso será liberado automaticamente.</p>
        </div>
      </div>`;
    const copyBtn = document.getElementById("btnCopyBoleto");
    if (copyBtn) copyBtn.onclick = () => {
      const inp = document.getElementById("boletoCode");
      inp.select(); inp.setSelectionRange(0, 99999);
      document.execCommand("copy");
      copyBtn.textContent = "Copiado!";
      setTimeout(() => copyBtn.textContent = "Copiar", 1500);
    };
  }

  async function gerarPix(){
    if (!planoSelecionado) return;
    msg.textContent = "Gerando PIX...";
    if (offlineDiv) offlineDiv.innerHTML = "";
    if (brickDiv)   brickDiv.innerHTML   = "";
    try {
      const resp = await fetch(`${API_BASE}/api/mp/pay`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          uid,
          planType: planoSelecionado,
          // invoiceId não é necessário: backend cria e nos devolve o ID
          formData: { payment_method_id: "pix", payment_type_id: "pix" }
        })
      });
      const data = await resp.json();
      if (!resp.ok) throw data;

      // passa a ouvir a fatura criada pelo backend
      if (data.invoice_id) watchInvoice(data.invoice_id);

      renderPixUI(data);
      msg.textContent = "";
      offlineDiv.scrollIntoView({ behavior: "smooth", block: "start" });
    } catch(e){
      console.error("API /pay PIX error:", e);
      alert(e?.error || "Falha ao gerar PIX.");
      msg.textContent = "";
    }
  }

  async function gerarBoleto(){
    if (!planoSelecionado) return;
    msg.textContent = "Gerando boleto...";
    if (offlineDiv) offlineDiv.innerHTML = "";
    if (brickDiv)   brickDiv.innerHTML   = "";
    try {
      const resp = await fetch(`${API_BASE}/api/mp/pay`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          uid,
          planType: planoSelecionado,
          // invoiceId não é necessário: backend cria e nos devolve o ID
          formData: { payment_method_id: "bolbradesco", payment_type_id: "ticket" }
        })
      });
      const data = await resp.json();
      if (!resp.ok) throw data;

      // passa a ouvir a fatura criada pelo backend
      if (data.invoice_id) watchInvoice(data.invoice_id);

      renderBoletoUI(data);
      msg.textContent = "";
      offlineDiv.scrollIntoView({ behavior: "smooth", block: "start" });
    } catch(e){
      console.error("API /pay boleto error:", e);
      alert(e?.error || "Falha ao gerar boleto.");
      msg.textContent = "";
    }
  }

  // Observa estado do auth e carrega dados do usuário (CPF + nome)
  onAuthStateChanged(auth, async (user)=>{
    if (!user){ window.location.href = "./login.html"; return; }
    uid = user.uid;
    userEmail = user.email || "comprador+teste@ccbmg.dev";
    userFullName = user.displayName || null;

    // Busca dados adicionais no Firestore (users/{uid})
    try {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const d = snap.data() || {};
        const rawCPF = d.cpf || d.cpfCnpj || d.documento || "";
        userCPF = String(rawCPF || "").replace(/\D/g,"") || null;

        if (!userFullName) {
          userFullName = d.name || d.nome || d.nomeCompleto || d.fullName || null;
        }
      }
    } catch(e){
      console.warn("Falha ao buscar dados do usuário:", e);
    } finally {
      const names = splitName(userFullName || "");
      firstName = names.first || "";
      lastName = names.last || "";
      showCPFInfo();
      showTitularInfo();
    }
  });

  radios.forEach(radio=>{
    radio.addEventListener("change", ()=>{
      if (radio.checked) planoSelecionado = radio.value;
      atualizarUIPlano();
    });
  });

  // Brick apenas para cartão
  async function renderPaymentBrick(){
    if (!planoSelecionado) return;
    const amount = PRICE[planoSelecionado];

    if (!bricksBuilder) {
      const mp = new MercadoPago(MP_PUBLIC_KEY, { locale: "pt-BR" });
      bricksBuilder = mp.bricks();
    }
    if (paymentBrickController) {
      paymentBrickController.unmount();
      paymentBrickController = null;
    }
    if (brickDiv) brickDiv.innerHTML = "";
    if (offlineDiv) offlineDiv.innerHTML = "";
    msg.textContent = "Carregando formas de pagamento...";

    // identificação e nome para passar ao Brick
    const payerIdentification = userCPF ? { type: "CPF", number: userCPF } : undefined;
    const payerInit = {
      email: userEmail || "comprador+teste@ccbmg.dev",
      entityType: "individual",
      ...(payerIdentification ? { identification: payerIdentification } : {})
    };
    if (firstName) payerInit.firstName = firstName;
    if (lastName)  payerInit.lastName  = lastName;
    if (!firstName && userFullName) payerInit.name = userFullName;

    paymentBrickController = await bricksBuilder.create("payment", "paymentBrick_container", {
      initialization: {
        amount,
        payer: payerInit
      },
      customization: {
        paymentMethods: {
          creditCard: "all",
          debitCard:  "all"
          // não inclua 'ticket' nem 'bankTransfer'
        }
      },
      callbacks: {
        onReady: () => { msg.textContent = ""; },
        onError: (error) => { console.error(error); alert("Falha ao carregar o pagamento."); },
        onSubmit: async ({ formData }) => {
          try {
            const payerFromForm = (formData.payer || {});
            const finalPayer = {
              ...payerFromForm,
              email: payerFromForm.email || userEmail || "comprador+teste@ccbmg.dev",
              entityType: payerFromForm.entityType || "individual",
              identification: payerFromForm.identification || (userCPF ? { type: "CPF", number: userCPF } : undefined),
              firstName: payerFromForm.firstName || firstName || undefined,
              lastName:  payerFromForm.lastName  || lastName  || undefined,
              name:      payerFromForm.name      || userFullName || undefined
            };

            const payload = {
              uid,
              planType: planoSelecionado,
              payer: finalPayer,
              formData
            };

            const resp = await fetch(`${API_BASE}/api/mp/pay`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await resp.json();

            if (!resp.ok) {
              console.error("API /pay error:", data?.error || data, data?.debug || "");
              alert(data?.error || "Falha no pagamento.");
              return;
            }

            // Se aprovado na hora (cartão), redireciona
            if (data.status === "approved") {
              window.location.href = "pay-success.html";
            } else {
              // Se ainda pendente, assiste a fatura criada no backend
              if (data.invoice_id) watchInvoice(data.invoice_id);
              alert(`Status do pagamento: ${data.status}${data.status_detail ? " — " + data.status_detail : ""}`);
            }
          } catch (e) {
            console.error(e);
            alert("Erro ao processar o pagamento.");
          }
        }
      }
    });
  }
</script>
</body>
</html>
