<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/img/logo_CCBMG.png">
  <link rel="shortcut icon" href="assets/img/logo_CCBMG.png" type="image/png">

  <!-- Anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Classificados ‚Äî Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Classificados do Clube do Cavalo ‚Äî an√∫ncios p√∫blicos de compra, venda e servi√ßos.">
  <meta property="og:image" content="https://clubedocavalobonfim.com.br/assets/img/logo_CCBMG.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Se preferir, pode remover o querystring ?v=... -->
  <link rel="stylesheet" href="assets/css/custom.css?v=ccbmg-2025-09-10d">

  <style>
    :root{ --brand:#111279; }
    .bg-primary { background-color: var(--brand) !important; }
    .btn-primary { background-color: var(--brand) !important; border-color: var(--brand) !important; }
    .btn-outline-primary { color: var(--brand) !important; border-color: var(--brand) !important; }
    .text-primary { color: var(--brand) !important; }

    .brand-logo{ height:36px; width:auto; margin-right:.5rem; object-fit:contain; filter:brightness(0) invert(1); }
    @media (min-width: 992px){ .brand-logo{ height:42px; } }

    .card-classificado { transition: transform .08s ease; }
    .card-classificado:hover { transform: translateY(-4px); box-shadow: 0 .6rem 1.4rem rgba(0,0,0,.12); }

    .price { font-weight:700; font-size:1.05rem; }
    .no-data { opacity: .8; }

    /* Carrossel dos cards (lista) ‚Äî mant√©m cover */
    .cls-carousel .carousel-item img{
      width:100%; height:220px; object-fit:cover; display:block;
      border-radius:.5rem;
    }
    .cls-carousel .carousel-indicators [data-bs-target]{
      width:8px; height:8px; border-radius:50%;
    }
    @media (max-width:575.98px){
      .hero-cta .btn{ width:100%; }
      .cls-carousel .carousel-item img{ height:200px; }
    }

    /* ===== Banner Destaques (mosaico) ===== */
    .carousel-banner{ position:relative; border-radius:16px; overflow:hidden; }
    .banner-mosaic{
      display:grid; gap:6px;
      height: clamp(200px, 28vw, 320px);
      grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr;
      background:#f8f9fa;
    }
    .banner-mosaic .big{ grid-column:1; grid-row:1 / span 2; }
    .banner-mosaic .small.top{ grid-column:2; grid-row:1; }
    .banner-mosaic .small.bottom{ grid-column:2; grid-row:2; }

    /* >>> IMAGEM COMO FUNDO (contain, sem corte) */
    .tile-img{
      width:100%; height:100%;
      background-size: contain;              /* garante imagem inteira */
      background-position: center center;    /* centraliza */
      background-repeat: no-repeat;          /* sem repeti√ß√£o */
      background-color:#f8f9fa;              /* cor das faixas */
    }

    .tile-overlay{
      position:absolute; inset:auto 0 0 0; padding:.75rem .9rem;
      background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 100%);
      color:#fff; display:flex; flex-direction:column; gap:.35rem;
      z-index:5;
    }
    .badge-soft{ background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.35); }

    .banner-carousel .carousel-control-prev, 
    .banner-carousel .carousel-control-next,
    #destaquesCarousel .carousel-control-prev, 
    #destaquesCarousel .carousel-control-next{
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
      z-index:1;
    }
    #destaquesCarousel .carousel-indicators [data-bs-target]{ background:#6c757d; }
    #destaquesCarousel .carousel-indicators .active{ background:#212529; }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container d-flex align-items-center justify-content-between flex-nowrap">
    <a class="navbar-brand d-flex align-items-center fw-bold text-truncate" href="index.html">
      <img class="brand-logo" src="assets/img/logo_CCBMG.png?v=ccbmg-2025-09-10d" alt="Logo Clube do Cavalo">
      <span class="brand-title">Clube do Cavalo - Bonfim MG</span>
    </a>
    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
            aria-controls="nav" aria-expanded="false" aria-label="Alternar navega√ß√£o">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
        <li class="nav-item"><a class="nav-link" href="events.html">Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="partners.html">Parcerias</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Fotos</a></li>
        <li class="nav-item"><a class="nav-link" href="board.html">Diretoria</a></li>
        <li class="nav-item"><a class="nav-link" href="sobre.html">Sobre o Clube</a></li>
        <li class="nav-item mt-2 mt-lg-0">
          <a id="btnAssociado" class="btn btn-light text-primary ms-lg-3 w-100 w-lg-auto" href="./login.html">√Årea do Associado</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- HEADER -->
<header class="bg-light py-4 border-bottom">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between gap-3">
      <div>
        <h1 class="h3 mb-1">Classificados do Clube</h1>
        <p class="mb-0 text-muted">An√∫ncios p√∫blicos de compra, venda e servi√ßos. Somente associados podem publicar.</p>
      </div>
    </div>
  </div>
</header>

<!-- ===== BANNER DE DESTAQUES ===== -->
<main class="container my-3">
  <section class="mt-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 m-0">üî∞Nossos Destaques</h2>
    </div>

    <div id="deckLoading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status"></div>
      <div class="mt-2 text-secondary small">Carregando destaques‚Ä¶</div>
    </div>

    <div id="deckEmpty" class="text-center text-muted py-5 d-none">Nenhum destaque dispon√≠vel no momento.</div>

    <div id="destaquesCarouselWrap" class="d-none">
      <div id="destaquesCarousel" class="carousel slide banner-carousel" data-bs-ride="carousel" data-bs-interval="5000">
        <div class="carousel-indicators" id="carIndicators"></div>
        <div class="carousel-inner" id="carInner"></div>

        <button class="carousel-control-prev" type="button" data-bs-target="#destaquesCarousel" data-bs-slide="prev" aria-label="Anterior">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#destaquesCarousel" data-bs-slide="next" aria-label="Pr√≥ximo">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
        </button>
      </div>
    </div>

    <div id="deckError" class="alert alert-danger d-none mt-3"></div>
  </section>
</main>

<!-- CONTE√öDO PRINCIPAL -->
<main class="py-3">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-4 gap-3 flex-column flex-md-row">
      <div class="d-flex gap-2 w-100" style="max-width:600px;">
        <input type="text" id="searchInput" class="form-control" placeholder="Buscar por t√≠tulo, descri√ß√£o, anunciante ou valor...">
      </div>
      <div class="text-end text-muted small">Exibindo an√∫ncios p√∫blicos ativos e aprovados.</div>
    </div>

    <div id="lista-classificados" class="row g-4"></div>

    <div id="no-data" class="text-center mt-4 no-data d-none">
      <p class="mb-2">N√£o h√° classificados publicados no momento.</p>
      <p class="small text-muted">Verifique mais tarde ou pe√ßa a um associado para publicar.</p>
    </div>
  </div>

  <section class="container py-4">
    <h5>Disclaimer</h5>
    <p class="small text-muted mb-2">
      O Clube do Cavalo ‚Äì Bonfim MG atua exclusivamente como plataforma de integra√ß√£o entre anunciantes e interessados, servindo como meio de divulga√ß√£o de produtos, servi√ßos e oportunidades.
      Todo o conte√∫do dos an√∫ncios, incluindo produtos, servi√ßos, pre√ßos, informa√ß√µes e negocia√ß√µes realizadas por meio deste site, √© de <strong>responsabilidade exclusiva dos anunciantes</strong>.
      O Clube do Cavalo n√£o participa das transa√ß√µes, n√£o realiza vendas, pagamentos ou entregas, e n√£o se responsabiliza por quaisquer danos, preju√≠zos ou conflitos decorrentes do uso da plataforma.
    </p>
    <p class="small text-muted">
      Esta isen√ß√£o de responsabilidade est√° em conformidade com a legisla√ß√£o brasileira aplic√°vel, incluindo:
      <ul class="small text-muted mb-0">
        <li>Art. 14, ¬ß3¬∫, do <strong>C√≥digo de Defesa do Consumidor (Lei n¬∫ 8.078/1990)</strong>;</li>
        <li>Art. 19 do <strong>Marco Civil da Internet (Lei n¬∫ 12.965/2014)</strong>;</li>
        <li>Art. 7¬∫ do <strong>C√≥digo de Defesa do Consumidor</strong>.</li>
      </ul>
    </p>
  </section>
</main>

<!-- RODAP√â -->
<footer class="mt-5 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> ‚Äî Promovendo a cultura equestre.</div>
    <div class="text-secondary small text-center">¬© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gest√£o de Clubes e Associa√ß√µes Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { db } from './firebase.js';
  import {
    collection,
    query,
    onSnapshot,
    where,
    orderBy,
    getDocs
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const listaEl   = document.getElementById('lista-classificados');
  const noDataEl  = document.getElementById('no-data');
  const searchInput = document.getElementById('searchInput');

  /* ===== Banner refs ===== */
  const deckLoading = document.getElementById("deckLoading");
  const deckEmpty = document.getElementById("deckEmpty");
  const deckError = document.getElementById("deckError");
  const carWrap = document.getElementById("destaquesCarouselWrap");
  const carInner = document.getElementById("carInner");
  const carIndicators = document.getElementById("carIndicators");

  let allDocs = [];

  function formatPrice(value) {
    if (value === null || value === undefined || value === '') return '';
    const n = Number(value);
    return Number.isFinite(n)
      ? n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
      : String(value);
  }

  function escapeHtml(text) {
    if (!text && text !== 0) return '';
    return String(text)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function getSeller(d){
    const raw =
      d.ownerName ?? d.anuncianteNome ?? d.sellerName ?? d.userName ?? d.ownerEmail ?? '';
    let seller = (raw ?? '').toString().trim();
    if (!seller && d.ownerUid) {
      const uid = String(d.ownerUid);
      seller = `Usu√°rio ${uid.slice(-6)}`;
    }
    return seller;
  }

  /* carrossel interno dos cards da lista (mantido) */
  function buildCarouselHTML(urls, idBase) {
    if (!urls || !urls.length) {
      return `
        <div class="mb-2">
          <img src="assets/img/placeholder_classified.jpg" loading="lazy" class="w-100" style="height:220px;object-fit:contain;border-radius:.5rem" alt="Sem imagem">
        </div>
      `;
    }
    const carouselId = `carousel-${idBase}`;
    const indicators = urls.map((_, i) => `
      <button type="button" data-bs-target="#${carouselId}" data-bs-slide-to="${i}"
        class="${i===0?'active':''}" aria-current="${i===0?'true':''}" aria-label="Slide ${i+1}"></button>
    `).join('');

    const slides = urls.map((src, i) => `
      <div class="carousel-item ${i===0?'active':''}">
        <img src="${escapeHtml(src)}" loading="lazy" class="d-block w-100" alt="Imagem ${i+1}">
      </div>
    `).join('');

    return `
      <div id="${carouselId}" class="carousel slide mb-3 cls-carousel" data-bs-ride="false">
        ${urls.length > 1 ? `<div class="carousel-indicators">${indicators}</div>` : ``}
        <div class="carousel-inner">${slides}</div>
        ${urls.length > 1 ? `
          <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev" aria-label="Imagem anterior">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next" aria-label="Pr√≥xima imagem">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
          </button>` : ``}
      </div>
    `;
  }

  /* ===== Banner (n√£o corta) ===== */
  function pickFeaturedFlag(doc){
    return (doc?.destaque === true) || (doc?.featured === true) || (doc?.isFeatured === true);
  }
  function pickActiveFlag(doc){
    const inactive = (doc?.active === false) || (doc?.ativo === false);
    return !inactive;
  }
  function collectImages(obj){
    let arr = [];
    if (Array.isArray(obj?.imageUrls)) arr = obj.imageUrls;
    else if (Array.isArray(obj?.images)) arr = obj.images;
    else if (obj?.imageUrl) arr = [obj.imageUrl];
    else if (obj?.img) arr = [obj.img];

    arr = arr
      .map(v => {
        if (!v) return null;
        if (typeof v === "string") return v.trim();
        if (typeof v === "object" && v.url) return String(v.url).trim();
        return null;
      })
      .filter(Boolean)
      .filter(u => /^https?:\/\//i.test(u) || /^data:image\//i.test(u));

    if (!arr.length) arr = ["assets/img/placeholder_classified.jpg"];
    return arr.slice(0,3);
  }
  function primaryImage(obj){
    const imgs = collectImages(obj);
    return imgs[0];
  }
  function whatsUrl(v){
    const w = (v||"").toString().replace(/\D/g,"");
    return w ? `https://wa.me/${w}?text=${encodeURIComponent("Ol√°! Vi seu an√∫ncio no Clube do Cavalo.")}` : "";
  }
  function toEpoch(x){
    try{
      if (!x) return 0;
      if (x.toDate) return x.toDate().getTime();
      const d = new Date(x);
      return isNaN(d.getTime()) ? 0 : d.getTime();
    }catch{ return 0; }
  }

  async function fetchFeaturedClassificados(){
    const candidates = ["memberClassifieds","classificados","classifieds"];
    let rows = [];
    for (const col of candidates){
      try{
        const snap = await getDocs(collection(db, col));
        if (!snap.empty){
          const part = snap.docs.map(d=>({ id:d.id, ...d.data() }))
            .filter(r => pickActiveFlag(r) && (r?.approved === true) && pickFeaturedFlag(r))
            .map(r => ({ ...r,
              __type:"Classificado",
              __imgs: collectImages(r),
              __img: primaryImage(r),
              __wpp: whatsUrl(r.whatsapp || r.contato),
              __created: toEpoch(r.createdAt),
              __price: r.price ?? r.valor ?? r.preco ?? r.priceBRL
            }));
          rows = rows.concat(part);
        }
      }catch(e){ /* tenta pr√≥ximo */ }
    }
    return rows.sort((a,b)=> b.__created - a.__created);
  }

  // Usa DIV com background-size: contain (sem corte)
  function renderSlideHTML(it){
    const title = escapeHtml(it.title || it.titulo || "‚Äî");
    const imgs = it.__imgs?.length ? it.__imgs.slice(0,3) : [it.__img];
    while (imgs.length < 3) imgs.push(imgs[imgs.length-1]);

    const priceStr = (it.__price!=null && it.__price!=="")
      ? (Number(it.__price)===Number(it.__price)
          ? Number(it.__price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})
          : escapeHtml(String(it.__price)))
      : "";

    return `
      <div class="carousel-item">
        <div class="carousel-banner shadow-sm">
          <div class="banner-mosaic">
            <div class="tile-img big" style="background-image:url('${escapeHtml(imgs[0])}')" aria-label="${title}"></div>
            <div class="tile-img small top" style="background-image:url('${escapeHtml(imgs[1])}')" aria-label="${title}"></div>
            <div class="tile-img small bottom" style="background-image:url('${escapeHtml(imgs[2])}')" aria-label="${title}"></div>
          </div>
          <div class="tile-overlay">
            <div class="small fw-semibold text-truncate" title="${title}">${title}</div>
            ${priceStr ? `
              <div class="d-flex align-items-center gap-2">
                <span class="fw-semibold">${priceStr}</span>
                ${it.__wpp ? `<a class="btn btn-sm btn-success no-slide" target="_blank" href="${it.__wpp}">Chamar WhatsApp</a>` : ""}
              </div>` : `
              <div class="d-flex align-items-center gap-2">
                ${it.__wpp ? `<a class="btn btn-sm btn-success no-slide" target="_blank" href="${it.__wpp}">Chamar WhatsApp</a>` : ""}
              </div>`
            }
          </div>
        </div>
      </div>`;
  }

  function buildHighlightsCarousel(items){
    if(!items.length) return;

    carIndicators.innerHTML = items.map((_,i)=>`
      <button type="button" data-bs-target="#destaquesCarousel" data-bs-slide-to="${i}" ${i===0?'class="active" aria-current="true"':''} aria-label="Slide ${i+1}"></button>
    `).join("");

    carInner.innerHTML = items.map((it,i)=>{
      const html = renderSlideHTML(it);
      return i===0 ? html.replace('class="carousel-item"', 'class="carousel-item active"') : html;
    }).join("");

    carWrap.classList.remove("d-none");

    new bootstrap.Carousel('#destaquesCarousel', {
      interval: 5000, ride: 'carousel', pause: false, touch: true, wrap: true
    });

    ['click','pointerdown','mousedown','touchstart'].forEach(ev =>
      carInner.addEventListener(ev, (e)=> {
        if (e.target.closest('.no-slide')) e.stopPropagation();
      }, {capture:true, passive:false})
    );
  }

  async function loadHighlights(){
    try{
      deckLoading.classList.remove("d-none");
      deckEmpty.classList.add("d-none");
      deckError.classList.add("d-none");
      carWrap.classList.add("d-none");
      carIndicators.innerHTML = "";
      carInner.innerHTML = "";

      const classifs = await fetchFeaturedClassificados();
      deckLoading.classList.add("d-none");

      if (!classifs.length){ deckEmpty.classList.remove("d-none"); return; }

      buildHighlightsCarousel(classifs);
    }catch(e){
      console.error(e);
      deckLoading.classList.add("d-none");
      deckError.textContent = "N√£o foi poss√≠vel carregar os destaques.";
      deckError.classList.remove("d-none");
    }
  }

  /* ====== LISTA PADR√ÉO ====== */
  function showList(docs, filter='') {
    listaEl.innerHTML = '';
    const f = (t) => (t ?? '').toString().toLowerCase();
    const needle = f(filter);

    const filtered = docs.filter(d => {
      const valorTxt = formatPrice(d.valor ?? d.price ?? d.preco ?? d.priceBRL ?? '');
      const seller   = getSeller(d);
      const titulo   = d.title ?? d.titulo ?? '';
      const desc     = d.description ?? d.descricao ?? '';
      return (
        f(titulo).includes(needle) ||
        f(desc).includes(needle) ||
        f(seller).includes(needle) ||
        f(valorTxt).includes(needle)
      );
    });

    if (filtered.length === 0) {
      noDataEl.classList.remove('d-none');
      return;
    }
    noDataEl.classList.add('d-none');

    filtered.forEach(d => {
      const card = renderClassificado(d);
      if (card) listaEl.appendChild(card);
    });
  }

  function renderClassificado(d) {
    const titulo    = escapeHtml(d.title ?? d.titulo ?? 'Sem t√≠tulo');
    const descricao = escapeHtml(d.description ?? d.descricao ?? '');
    const contato   = escapeHtml(d.whatsapp ?? d.contato ?? '');
    const valorRaw  = (d.valor ?? d.price ?? d.preco ?? d.priceBRL ?? null);
    const valorBRL  = formatPrice(valorRaw);
    const seller    = escapeHtml(getSeller(d));

    const createdAt = d.createdAt && typeof d.createdAt.toDate === 'function'
      ? d.createdAt.toDate()
      : (d.createdAt instanceof Date ? d.createdAt : null);

    const dataLine = createdAt
      ? new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' }).format(createdAt)
      : '';

    const rawImages = Array.isArray(d.imageUrls) ? d.imageUrls
                     : Array.isArray(d.images)    ? d.images
                     : [];
    const images = rawImages.slice(0, 10);

    const col = document.createElement('div');
    col.className = 'col-12 col-md-6 col-lg-4';

    col.innerHTML = `
      <div class="card h-100 card-classificado">
        <div class="card-body d-flex flex-column">

          <div class="mb-2">
            <h5 class="card-title mb-1">${titulo}</h5>
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-1">
              <small class="text-muted">Anunciante: <strong>${seller}</strong></small>
              ${valorBRL ? `<div class="price text-primary">${valorBRL}</div>` : ``}
            </div>
          </div>

          ${buildCarouselHTML(images, d.id)}

          <p class="card-text mb-3" style="white-space:pre-wrap">${descricao}</p>

          <div class="mt-auto d-flex justify-content-between align-items-center flex-column flex-sm-row gap-2">
            ${contato
              ? `<a class="btn btn-success btn-sm" href="https://wa.me/${contato.replace(/\D/g,'')}" target="_blank" rel="noopener noreferrer">Chamar no WhatsApp</a>`
              : `<span class="small text-muted">Contato n√£o informado</span>`
            }
            <div class="small text-muted">${dataLine}</div>
          </div>
        </div>
      </div>
    `;
    return col;
  }

  function watchClassificadosRealtime() {
    const colRef = collection(db, 'memberClassifieds');
    const q = query(
      colRef,
      where('active', '==', true),
      where('approved', '==', true),
      where('paymentStatus', '!=', 'pending'),
      orderBy('paymentStatus'),
      orderBy('createdAt', 'desc')
    );

    return onSnapshot(q, (snapshot) => {
      allDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      showList(allDocs, searchInput.value);
    }, (err) => {
      console.error('Erro ao ler classificados:', err);
    });
  }

  // Inicializa
  let unsubscribe = null;
  document.addEventListener('DOMContentLoaded', () => {
    unsubscribe = watchClassificadosRealtime();
    loadHighlights();
  });

  searchInput.addEventListener('input', () => {
    showList(allDocs, searchInput.value);
  });

  window.addEventListener('unload', () => { if (typeof unsubscribe === 'function') unsubscribe(); });
</script>
</body>
</html>
