<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets\img\logo_CCBMG.png">
  <link rel="shortcut icon" href="assets\img\logo_CCBMG.png" type="image/png">

  <!-- Anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Classificados — Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Classificados do Clube do Cavalo — anúncios públicos de compra, venda e serviços.">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/custom.css?v=ccbmg-2025-09-10d">

  <style>
    :root{ --brand:#111279; }
    .bg-primary { background-color: var(--brand) !important; }
    .btn-primary { background-color: var(--brand) !important; border-color: var(--brand) !important; }
    .btn-outline-primary { color: var(--brand) !important; border-color: var(--brand) !important; }
    .text-primary { color: var(--brand) !important; }

    .brand-logo{ height:36px; width:auto; margin-right:.5rem; object-fit:contain; filter:brightness(0) invert(1); }
    @media (min-width: 992px){ .brand-logo{ height:42px; } }

    .card-classificado { transition: transform .08s ease; }
    .card-classificado:hover { transform: translateY(-4px); box-shadow: 0 .6rem 1.4rem rgba(0,0,0,.12); }

    .price { font-weight:700; font-size:1.05rem; }
    .no-data { opacity: .8; }

    /* Carrossel */
    .cls-carousel .carousel-item img{
      width:100%; height:220px; object-fit:cover; display:block;
      border-radius:.5rem;
    }
    .cls-carousel .carousel-indicators [data-bs-target]{
      width:8px; height:8px; border-radius:50%;
    }

    @media (max-width:575.98px){
      .hero-cta .btn{ width:100%; }
      .cls-carousel .carousel-item img{ height:200px; }
    }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container d-flex align-items-center justify-content-between flex-nowrap">
    <a class="navbar-brand d-flex align-items-center fw-bold text-truncate" href="index.html">
      <img class="brand-logo" src="assets/img/logo_CCBMG.png?v=ccbmg-2025-09-10d" alt="Logo Clube do Cavalo">
      <span class="brand-title">Clube do Cavalo - Bonfim MG</span>
    </a>
    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
            aria-controls="nav" aria-expanded="false" aria-label="Alternar navegação">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
        <li class="nav-item"><a class="nav-link active" href="classificados.html">Classificados</a></li>
        <li class="nav-item"><a class="nav-link" href="events.html">Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="partners.html">Parcerias</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Fotos</a></li>
        <li class="nav-item"><a class="nav-link" href="board.html">Diretoria</a></li>
        <li class="nav-item mt-2 mt-lg-0">
          <a id="btnAssociado" class="btn btn-light text-primary ms-lg-3 w-100 w-lg-auto" href="./login.html">Área do Associado</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- HEADER -->
<header class="bg-light py-4 border-bottom">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between gap-3">
      <div>
        <h1 class="h3 mb-1">Classificados do Clube</h1>
        <p class="mb-0 text-muted">Anúncios públicos de compra, venda e serviços. Somente associados podem publicar.</p>
      </div>
    </div>
  </div>
</header>

<!-- CONTEÚDO PRINCIPAL -->
<main class="py-5">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-4 gap-3 flex-column flex-md-row">
      <div class="d-flex gap-2 w-100" style="max-width:600px;">
        <input type="text" id="searchInput" class="form-control" placeholder="Buscar por título, descrição, anunciante ou valor...">
      </div>
      <div class="text-end text-muted small">Exibindo anúncios públicos ativos e aprovados.</div>
    </div>

    <div id="lista-classificados" class="row g-4"></div>

    <div id="no-data" class="text-center mt-4 no-data d-none">
      <p class="mb-2">Não há classificados publicados no momento.</p>
      <p class="small text-muted">Verifique mais tarde ou peça a um associado para publicar.</p>
    </div>
  </div>

  <section class="container py-4">
    <h5>Disclaimer</h5>
    <p class="small text-muted mb-2">
      O Clube do Cavalo – Bonfim MG atua exclusivamente como plataforma de integração entre anunciantes e interessados, servindo como meio de divulgação de produtos, serviços e oportunidades.
      Todo o conteúdo dos anúncios, incluindo produtos, serviços, preços, informações e negociações realizadas por meio deste site, é de <strong>responsabilidade exclusiva dos anunciantes</strong>.
      O Clube do Cavalo não participa das transações, não realiza vendas, pagamentos ou entregas, e não se responsabiliza por quaisquer danos, prejuízos ou conflitos decorrentes do uso da plataforma.
    </p>
    <p class="small text-muted">
      Esta isenção de responsabilidade está em conformidade com a legislação brasileira aplicável, incluindo:
      <ul class="small text-muted mb-0">
        <li>Art. 14, §3º, do <strong>Código de Defesa do Consumidor (Lei nº 8.078/1990)</strong>;</li>
        <li>Art. 19 do <strong>Marco Civil da Internet (Lei nº 12.965/2014)</strong>;</li>
        <li>Art. 7º do <strong>Código de Defesa do Consumidor</strong>.</li>
      </ul>
    </p>
  </section>
</main>

<!-- RODAPÉ -->
<footer class="mt-5 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> — Promovendo a cultura equestre.</div>
    <div class="text-secondary small text-center">© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gestão de Associações Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { db } from './firebase.js';
  import {
    collection,
    query,
    onSnapshot,
    where,
    orderBy
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const listaEl   = document.getElementById('lista-classificados');
  const noDataEl  = document.getElementById('no-data');
  const searchInput = document.getElementById('searchInput');

  let allDocs = [];

  // Formata BRL
  function formatPrice(value) {
    if (value === null || value === undefined || value === '') return '';
    const n = Number(value);
    return Number.isFinite(n)
      ? n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
      : String(value);
  }

  // Escape simples
  function escapeHtml(text) {
    if (!text && text !== 0) return '';
    return String(text)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // Nome do anunciante (com fallbacks)
  function getSeller(d){
    const raw =
      d.ownerName ??
      d.anuncianteNome ??
      d.sellerName ??
      d.userName ??
      d.ownerEmail ??
      '';

    let seller = (raw ?? '').toString().trim();
    if (!seller && d.ownerUid) {
      const uid = String(d.ownerUid);
      seller = `Usuário ${uid.slice(-6)}`;
    }
    return seller;
  }

  // Constrói o HTML do carrossel a partir de uma lista de URLs
  function buildCarouselHTML(urls, idBase) {
    if (!urls || !urls.length) {
      // fallback sem fotos
      return `
        <div class="mb-2">
          <img src="assets/img/placeholder_classified.jpg" loading="lazy" class="w-100" style="height:220px;object-fit:cover;border-radius:.5rem" alt="Sem imagem">
        </div>
      `;
    }

    const carouselId = `carousel-${idBase}`;
    const indicators = urls.map((_, i) => `
      <button type="button" data-bs-target="#${carouselId}" data-bs-slide-to="${i}"
        class="${i===0?'active':''}" aria-current="${i===0?'true':''}" aria-label="Slide ${i+1}"></button>
    `).join('');

    const slides = urls.map((src, i) => `
      <div class="carousel-item ${i===0?'active':''}">
        <img src="${escapeHtml(src)}" loading="lazy" class="d-block w-100" alt="Imagem ${i+1}">
      </div>
    `).join('');

    return `
      <div id="${carouselId}" class="carousel slide mb-3 cls-carousel" data-bs-ride="false">
        ${urls.length > 1 ? `<div class="carousel-indicators">${indicators}</div>` : ``}
        <div class="carousel-inner">${slides}</div>
        ${urls.length > 1 ? `
          <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev" aria-label="Imagem anterior">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next" aria-label="Próxima imagem">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
          </button>` : ``}
      </div>
    `;
  }

  // Card do classificado
  function renderClassificado(d) {
    const titulo    = escapeHtml(d.title ?? d.titulo ?? 'Sem título');
    const descricao = escapeHtml(d.description ?? d.descricao ?? '');
    const contato   = escapeHtml(d.whatsapp ?? d.contato ?? '');
    const valorRaw  = (d.valor ?? d.price ?? d.preco ?? d.priceBRL ?? null);
    const valorBRL  = formatPrice(valorRaw);
    const seller    = escapeHtml(getSeller(d));

    const createdAt = d.createdAt && typeof d.createdAt.toDate === 'function'
      ? d.createdAt.toDate()
      : (d.createdAt instanceof Date ? d.createdAt : null);

    const dataLine = createdAt
      ? new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' }).format(createdAt)
      : '';

    // Imagens: aceita imageUrls[] (novo) ou images[]
    const rawImages = Array.isArray(d.imageUrls) ? d.imageUrls
                     : Array.isArray(d.images)    ? d.images
                     : [];
    // garante no máximo 10 para não poluir (pode ajustar)
    const images = rawImages.slice(0, 10);

    const col = document.createElement('div');
    col.className = 'col-12 col-md-6 col-lg-4';

    col.innerHTML = `
      <div class="card h-100 card-classificado">
        <div class="card-body d-flex flex-column">

          <div class="mb-2">
            <h5 class="card-title mb-1">${titulo}</h5>
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-1">
              <small class="text-muted">Anunciante: <strong>${seller}</strong></small>
              ${valorBRL ? `<div class="price text-primary">${valorBRL}</div>` : ``}
            </div>
          </div>

          ${buildCarouselHTML(images, d.id)}

          <p class="card-text mb-3" style="white-space:pre-wrap">${descricao}</p>

          <div class="mt-auto d-flex justify-content-between align-items-center flex-column flex-sm-row gap-2">
            ${contato
              ? `<a class="btn btn-success btn-sm" href="https://wa.me/${contato.replace(/\D/g,'')}" target="_blank" rel="noopener noreferrer">Chamar no WhatsApp</a>`
              : `<span class="small text-muted">Contato não informado</span>`
            }
            <div class="small text-muted">${dataLine}</div>
          </div>
        </div>
      </div>
    `;
    return col;
  }

  // Lista com filtro (no cliente, apenas busca textual)
  function showList(docs, filter='') {
    listaEl.innerHTML = '';
    const f = (t) => (t ?? '').toString().toLowerCase();
    const needle = f(filter);

    const filtered = docs.filter(d => {
      const valorTxt = formatPrice(d.valor ?? d.price ?? d.preco ?? d.priceBRL ?? '');
      const seller   = getSeller(d);
      const titulo   = d.title ?? d.titulo ?? '';
      const desc     = d.description ?? d.descricao ?? '';
      return (
        f(titulo).includes(needle) ||
        f(desc).includes(needle) ||
        f(seller).includes(needle) ||
        f(valorTxt).includes(needle)
      );
    });

    if (filtered.length === 0) {
      noDataEl.classList.remove('d-none');
      return;
    }
    noDataEl.classList.add('d-none');

    filtered.forEach(d => {
      const card = renderClassificado(d);
      if (card) listaEl.appendChild(card);
    });
  }

  // Snapshot em tempo real — tudo filtrado no servidor:
  //  - active == true
  //  - approved == true
  //  - paymentStatus != 'pending'  (requer orderBy no mesmo campo)
  function watchClassificadosRealtime() {
    const colRef = collection(db, 'memberClassifieds');
    const q = query(
      colRef,
      where('active', '==', true),
      where('approved', '==', true),
      where('paymentStatus', '!=', 'pending'),
      orderBy('paymentStatus'),        // exigência do Firestore para '!='
      orderBy('createdAt', 'desc')     // ordenação secundária por data
    );

    return onSnapshot(q, (snapshot) => {
      allDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      showList(allDocs, searchInput.value);
    }, (err) => {
      console.error('Erro ao ler classificados:', err);
    });
  }

  // Inicializa
  let unsubscribe = null;
  document.addEventListener('DOMContentLoaded', () => {
    unsubscribe = watchClassificadosRealtime();
  });

  // Filtro de busca
  searchInput.addEventListener('input', () => {
    showList(allDocs, searchInput.value);
  });

  // Cleanup
  window.addEventListener('unload', () => { if (typeof unsubscribe === 'function') unsubscribe(); });
</script>
</body>
</html>
