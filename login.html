<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Anti-cache básico -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Login — Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Acesso à Área do Associado do Clube do Cavalo de Bonfim MG.">
  <meta property="og:image" content="https://clubedocavalobonfim.com.br/assets/img/logo_CCBMG.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/custom.css?v=login-2025-09-10a">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets\img\logo_CCBMG.png">
  <link rel="shortcut icon" href="assets\img\logo_CCBMG.png" type="image/png">

  <style>
    :root{ --brand:#111279; }
    .bg-primary{ background-color:var(--brand)!important; }
    .btn-primary{ background-color:var(--brand)!important; border-color:var(--brand)!important; }
    .btn-outline-primary{ color:var(--brand)!important; border-color:var(--brand)!important; }
    .text-primary{ color:var(--brand)!important; }

    /* Navbar sempre clicável e sem quebra */
    .navbar{ position:relative; z-index:1020; }
    .navbar .container{ justify-content:space-between; flex-wrap:nowrap; }
    .navbar-brand{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:65vw; }
    .navbar-toggler{ margin-left:auto; }
    .navbar .btn{ pointer-events:auto; }

    /* Layout do miolo sem “buracos” */
    main{ padding-top:1.25rem; padding-bottom:1.25rem; }
    .login-wrap{
      min-height: clamp(60vh, 72vh, 80vh); /* ocupa bem a tela, sem sobras */
      display:flex; align-items:center; justify-content:center;
    }
    .login-card{ width:100%; max-width:420px; }
    .brand-logo{ height:36px; width:auto; margin-right:.5rem; object-fit:contain; filter:brightness(0) invert(1); }
    @media (min-width: 992px){ .brand-logo{ height:42px; } }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <img class="brand-logo" src="assets/img/logo_CCBMG.png?v=ccbmg-2025-09-10d" alt="Logo Clube do Cavalo">
    <a class="navbar-brand fw-bold text-truncate" href="index.html">Clube do Cavalo - Bonfim MG</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
            aria-controls="nav" aria-expanded="false" aria-label="Alternar navegação">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
        <li class="nav-item"><a class="nav-link" href="classificados.html">Classificados</a></li>
        <li class="nav-item"><a class="nav-link" href="events.html">Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="partners.html">Parcerias</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Fotos</a></li>
        <li class="nav-item"><a class="nav-link" href="board.html">Diretoria</a></li>
        <li class="nav-item"><a class="nav-link" href="sobre.html">Sobre o Clube</a></li>
        <li class="nav-item mt-2 mt-lg-0">
          <a class="btn btn-light text-primary ms-lg-3 w-100 w-lg-auto" href="login.html?logout=1">Área do Associado</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<main class="container">
  <div class="login-wrap">
    <div class="login-card">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h1 class="h4 text-center mb-4 text-primary">Área do Associado</h1>

          <!-- CPF -->
          <div class="mb-3">
            <label for="cpf" class="form-label">CPF</label>
            <input type="text" id="cpf" class="form-control" placeholder="000.000.000-00"
                   inputmode="numeric" autocomplete="username" maxlength="14" />
          </div>

          <!-- Senha -->
          <div class="mb-3">
            <label for="password" class="form-label">Senha</label>
            <input type="password" id="password" class="form-control"
                   placeholder="Sua senha" autocomplete="current-password" />
          </div>

          <button id="loginBtn" class="btn btn-primary w-100">Entrar</button>
          <p id="msg" class="text-muted mt-3 text-center small"></p>

          <div class="d-flex justify-content-end mt-2">
            <a href="reset_senha.html" class="small text-decoration-none">Esqueci minha senha</a>
          </div>

          <a href="signup.html" class="btn btn-outline-secondary mt-2 w-100">Criar uma conta</a>
          <a href="index.html" class="btn btn-outline-secondary mt-2 w-100">Voltar</a>
        </div>
      </div>
    </div>
  </div>
</main>

<footer class="mt-5 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> — Promovendo a cultura equestre.</div>
    <div class="text-secondary small text-center">© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gestão de Associações Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  // Importa tudo do seu firebase.js (mantém sua lógica original)
  import * as fb from "./firebase.js";

  // ---------- DOM ----------
  const cpfEl  = document.getElementById("cpf");
  const passEl = document.getElementById("password");
  const btn    = document.getElementById("loginBtn");
  const msg    = document.getElementById("msg");

  // Fecha o menu mobile ao clicar (evita overlay travando clique)
  document.querySelectorAll('#nav a, #nav button').forEach(el=>{
    el.addEventListener('click', ()=>{
      const c = document.getElementById('nav');
      if (c?.classList.contains('show')) new bootstrap.Collapse(c).hide();
    });
  });

  // ---------- CPF utils ----------
  const onlyDigits = (s)=> (s||"").replace(/\D/g,"");
  function formatCPF(v){
    const d = onlyDigits(v).slice(0,11);
    const p1=d.slice(0,3), p2=d.slice(3,6), p3=d.slice(6,9), p4=d.slice(9,11);
    return [p1, p2 && '.'+p2, p3 && '.'+p3, p4 && '-'+p4].filter(Boolean).join('');
  }
  function isValidCPF(cpfDigits){
    const cpf = onlyDigits(cpfDigits);
    if (!cpf || cpf.length!==11) return false;
    if (/^(\d)\1{10}$/.test(cpf)) return false;
    let s=0; for(let i=0;i<9;i++) s+= +cpf[i]*(10-i);
    let d1=(s*10)%11; if(d1===10) d1=0; if(d1!== +cpf[9]) return false;
    s=0; for(let i=0;i<10;i++) s+= +cpf[i]*(11-i);
    let d2=(s*10)%11; if(d2===10) d2=0; return d2=== +cpf[10];
  }
  const cpfToEmail = (cpfDigits)=> `${onlyDigits(cpfDigits)}@cpf.local`;

  cpfEl.addEventListener("input", () => {
    const pos = cpfEl.selectionStart, before = cpfEl.value;
    cpfEl.value = formatCPF(before);
    const delta = cpfEl.value.length - before.length;
    try { cpfEl.selectionStart = cpfEl.selectionEnd = Math.max(0, (pos||0)+delta); } catch {}
  });

  // ---------- Persistência local ----------
  async function ensureLocalPersistence(){
    try {
      if (fb?.setPersistence && fb?.browserLocalPersistence && fb?.auth) {
        await fb.setPersistence(fb.auth, fb.browserLocalPersistence);
      }
    } catch (e) { console.warn("Persistência local:", e); }
  }

  // ---------- Roteamento pós-auth ----------
  function deriveStatus(p){
    const s = String(p?.status || p?.situacao || p?.sit || "")
      .normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();
    const pendingByStatus  = /pend/.test(s);
    const inactiveByStatus = pendingByStatus || /inativ|suspens|bloquead/.test(s);
    let active = !inactiveByStatus;
    if (typeof p?.isActive === "boolean") active = active && p.isActive;
    if (typeof p?.ativo    === "boolean") active = active && p.ativo;
    const pending = pendingByStatus || !!(p?.pendenciasFinanceiras ?? p?.hasPendingPayments ?? p?.pendingPayments ?? p?.pendencias ?? false);
    return { active, pending };
  }
  function goTo(path, params={}) {
    const url = new URL(path, location.href);
    Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,v));
    location.href = url.toString();
  }
// ========= Busca do perfil com diagnóstico =========
  async function fetchUserProfile(uid){
    if (!fb?.db || !fb?.doc || !fb?.getDoc) {
      return { exists:false, data:null, errorCode:"no-sdk" };
    }
    try {
      const ref  = fb.doc(fb.db, "users", uid);
      const snap = await fb.getDoc(ref);
      return { exists: snap.exists(), data: snap.exists() ? snap.data() : null, errorCode: null };
    } catch(e){
      const code = (e && e.code) ? String(e.code) : "unknown";
      console.warn("Erro ao buscar perfil do usuário:", e);
      return { exists:false, data:null, errorCode: code };
    }
  }
// ========= Decisão pós-auth com tratamento seguro =========
  async function routeAuthenticatedUser(user){
    const { exists, data:profile, errorCode } = await fetchUserProfile(user.uid);

    // Se não existe DOC, autocriamos um perfil mínimo (permitido pelas suas rules)
    if (!exists) {
      try {
        const ref = fb.doc(fb.db, "users", user.uid);
        await fb.setDoc(ref, {
          uid: user.uid,
          email: user.email || null,
          // NÃO definimos role/status aqui (deixa virem do admin depois)
          createdAt: fb.serverTimestamp(),
          updatedAt: fb.serverTimestamp()
        }, { merge: true });

        // Recarrega o perfil após criar
        const again = await fetchUserProfile(user.uid);
        if (!again.exists) {
          alert("Login OK, mas não foi possível inicializar seu cadastro. Tente novamente ou fale com a diretoria.");
          return;
        }
        const { active, pending } = deriveStatus(again.data || {});
        if (!active) { goTo("./pay.html",{reason:"inactive"}); return; }
        if (pending) { goTo("./pay.html",{reason:"pending"});  return; }
        goTo("./pg_associado.html");
        return;
      } catch (e) {
        // Se der erro de permissão aqui, suas rules não permitem create (mas permitem!)
        alert("Seu login foi reconhecido, mas houve erro ao criar seu cadastro: " + (e?.code || e?.message || e));
        return;
      }
    }

    // Doc existe: segue o fluxo normal
    const { active, pending } = deriveStatus(profile || {});
    if (!active) { goTo("./pay.html",{reason:"inactive"}); return; }
    if (pending) { goTo("./pay.html",{reason:"pending"});  return; }
    goTo("./pg_associado.html");
  }


  // ---------- Suporte ?logout=1 ----------
  const qs = new URLSearchParams(location.search);
  const requestedLogout = qs.get("logout")==="1";
  if (requestedLogout && fb?.auth && typeof fb?.onAuthStateChanged==="function"){
    fb.onAuthStateChanged(fb.auth, async (user)=>{
      try { if (user && typeof fb?.signOut==="function") await fb.signOut(fb.auth); }
      catch(e){ console.warn("logout forçado:", e); }
      finally{
        const clean = new URL(location.href); clean.searchParams.delete("logout");
        history.replaceState({}, "", clean.pathname);
        setTimeout(()=> cpfEl?.focus(), 0);
      }
    });
  }

  // ---------- Auto-redirect se já estiver logado ----------
  if (fb?.onAuthStateChanged && fb?.auth){
    fb.onAuthStateChanged(fb.auth, (user)=>{
      if (requestedLogout) return; // se veio de logout, não redireciona
      if (user) routeAuthenticatedUser(user);
    });
  }

  // ---------- Login ----------
  btn.addEventListener("click", async ()=>{
    btn.disabled = true; msg.textContent = "Entrando...";
    try{
      const cpf = cpfEl.value, senha = passEl.value;
      if (!isValidCPF(cpf)) { msg.textContent=""; alert("CPF inválido. Verifique e tente novamente."); cpfEl.focus(); return; }
      await ensureLocalPersistence();
      const email = cpfToEmail(cpf);

      if (typeof fb?.doLogin === "function") {
        await fb.doLogin(email, senha);
      } else if (fb?.signInWithEmailAndPassword && fb?.auth) {
        await fb.signInWithEmailAndPassword(fb.auth, email, senha);
      } else {
        throw new Error("Funções de login não disponíveis. Exporte-as em firebase.js.");
      }

      const user = fb?.auth?.currentUser;
      if (user) { await routeAuthenticatedUser(user); }
      else { msg.textContent = "Autenticado. Redirecionando..."; }
    } catch(e){
      msg.textContent = "";
      if ((e?.code||"") === "auth/user-not-found"){ goTo("./signup.html"); return; }
      alert("Erro no login: " + (e?.message || e));
    } finally{ btn.disabled = false; }
  });

  // Enter para enviar
  [cpfEl, passEl].forEach(el => el.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") btn.click(); }));

  // Foco inicial no CPF (quando não houver logout forçado)
  if (!requestedLogout) setTimeout(()=> cpfEl?.focus(), 50);
</script>
</body>
</html>
