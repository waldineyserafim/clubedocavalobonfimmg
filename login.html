<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Clube do Cavalo – eventos, associados, diretoria e parcerias.">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="assets/css/custom.css">
  <style>
    .bg-primary { background-color: #264653 !important; }
    .btn-primary { background-color: #264653 !important; border-color: #264653 !important; }
    .btn-outline-primary { color: #264653 !important; border-color: #264653 !important; }
    .text-primary { color: #264653 !important; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Clube do Cavalo - Bonfim MG</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Alternar navegação">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="events.html">Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Fotos</a></li>
        <li class="nav-item"><a class="nav-link" href="board.html">Diretoria</a></li>
        <li class="nav-item"><a class="nav-link" href="partners.html">Parcerias</a></li>
        <li class="nav-item"><a class="btn btn-light text-primary ms-lg-3" href="login.html">Área do Associado</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="d-flex align-items-center justify-content-center min-vh-50" style="padding-top: 4.5rem;">
  <div class="w-100" style="max-width: 420px;">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <h1 class="h4 text-center mb-4 text-primary">Área do Associado</h1>

        <!-- ALTERADO: Campo de CPF no lugar do E-mail -->
        <div class="mb-3">
          <label for="cpf" class="form-label">CPF</label>
          <input type="text" id="cpf" class="form-control" placeholder="000.000.000-00" 
          inputmode="numeric" autocomplete="username" maxlength="14"/>
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">Senha</label>
          <input type="password" id="password" class="form-control" 
          placeholder="Sua senha" autocomplete="current-password" />
        </div>

        <button id="loginBtn" class="btn btn-primary w-100">Entrar</button>
        <p id="msg" class="text-muted mt-3 text-center"></p>

        <a href="signup.html" class="btn btn-outline-secondary mt-2 w-100">Criar um conta</a>

        <a href="index.html" class="btn btn-outline-secondary mt-2 w-100">Voltar</a>
  </div>
</main>

<footer class="mt-5 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div>
      <strong>Clube do Cavalo - Bonfim MG</strong> — Promovendo a cultura equestre.
    </div>
    <div class="text-secondary small">© 2025 Clube do Cavalo. Todos os direitos reservados.</div>
  </div>
</footer>

  <script type="module">
    import { doLogin } from "./firebase.js";

    // ALTERADO: agora usamos cpfEl no lugar de emailEl
    const cpfEl  = document.getElementById("cpf");
    const passEl = document.getElementById("password");
    const btn    = document.getElementById("loginBtn");
    const msg    = document.getElementById("msg");

    // ========= Utilitários de CPF (NOVO) =========
    function onlyDigits(str) {
      return (str || "").replace(/\D/g, "");
    }

    function formatCPF(value) {
      const d = onlyDigits(value).slice(0, 11);
      const p1 = d.slice(0,3);
      const p2 = d.slice(3,6);
      const p3 = d.slice(6,9);
      const p4 = d.slice(9,11);
      let out = "";
      if (p1) out = p1;
      if (p2) out += "." + p2;
      if (p3) out += "." + p3;
      if (p4) out += "-" + p4;
      return out;
    }

    function isValidCPF(cpfDigits) {
      const cpf = onlyDigits(cpfDigits);
      if (!cpf || cpf.length !== 11) return false;
      if (/^(\d)\1{10}$/.test(cpf)) return false;
      let sum = 0;
      for (let i = 0; i < 9; i++) sum += parseInt(cpf[i], 10) * (10 - i);
      let d1 = (sum * 10) % 11; if (d1 === 10) d1 = 0;
      if (d1 !== parseInt(cpf[9], 10)) return false;
      sum = 0;
      for (let i = 0; i < 10; i++) sum += parseInt(cpf[i], 10) * (11 - i);
      let d2 = (sum * 10) % 11; if (d2 === 10) d2 = 0;
      if (d2 !== parseInt(cpf[10], 10)) return false;
      return true;
    }

    function cpfToEmail(cpfDigits) {
      const clean = onlyDigits(cpfDigits);
      return `${clean}@cpf.local`;
    }

    // Formatação automática conforme digita (NOVO)
    cpfEl.addEventListener("input", () => {
      const posBefore = cpfEl.selectionStart;
      const valueBefore = cpfEl.value;
      cpfEl.value = formatCPF(cpfEl.value);
      const delta = cpfEl.value.length - valueBefore.length;
      const newPos = Math.max(0, (posBefore || 0) + delta);
      try {
        cpfEl.selectionStart = cpfEl.selectionEnd = newPos;
      } catch (_) { /* alguns browsers podem não permitir ajuste */ }
    });

    // ========= Fluxo de Login (ajustado) =========
    btn.addEventListener("click", async () => {
      btn.disabled = true;
      msg.textContent = "Entrando...";
      try {
        const cpfRaw = cpfEl.value;
        const senha  = passEl.value;

        // Validação de CPF antes de prosseguir (NOVO)
        if (!isValidCPF(cpfRaw)) {
          msg.textContent = "";
          alert("CPF inválido. Verifique e tente novamente.");
          cpfEl.focus();
          return;
        }

        // Mapeia CPF -> e-mail fictício para usar o Auth por e-mail/senha
        const emailFake = cpfToEmail(cpfRaw);

        // Mantém seu doLogin sem mudanças
        const role = await doLogin(emailFake, senha);

        // Redirecione conforme o papel, se quiser.
        if (role === "admin") {
          window.location.href = "./dashboard.html"; // ou ./admin.html
        } else if (role === "operacional") {
          window.location.href = "./dashboard.html"; // ou ./operacional.html
        } else {
          window.location.href = "./dashboard.html";
        }
      } catch (e) {
        msg.textContent = "";
        alert("Erro no login: " + (e?.message || e));
      } finally {
        btn.disabled = false;
      }
    });

    // Atalho: tecla Enter para enviar (ALTERADO: usa cpfEl)
    [cpfEl, passEl].forEach(el => {
      el.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") btn.click();
      });
    });
  </script>
</body>
</html>