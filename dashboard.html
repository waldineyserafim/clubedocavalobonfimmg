<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Clube do Cavalo – eventos, associados, diretoria e parcerias.">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="assets/css/custom.css">
  <style>
    .bg-primary { background-color: #264653 !important; }
    .btn-primary { background-color: #264653 !important; border-color: #264653 !important; }
    .btn-outline-primary { color: #264653 !important; border-color: #264653 !important; }
    .text-primary { color: #264653 !important; }
    body { padding-bottom: 4rem; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Clube do Cavalo - Bonfim MG</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Alternar navegação">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="events.html">Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Fotos</a></li>
        <li class="nav-item"><a class="nav-link" href="board.html">Diretoria</a></li>
        <li class="nav-item"><a class="nav-link" href="partners.html">Parcerias</a></li>
        <li class="nav-item"><a class="btn btn-light text-primary ms-lg-3" href="login.html">Área do Associado</a></li>
      </ul>
    </div>
  </div>
</nav>

<header class="d-flex justify-content-between align-items-center mb-4 p-3">
  <h1 class="brand h3 m-0"></h1>
  <div>
    <span id="userInfo" class="me-3 text-muted"></span>
    <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Sair</button>
  </div>
</header>

<!-- Bloco ADMIN -->
<section class="card p-3 mb-3" data-role="admin">
  <h3 class="h5">Administração</h3>
  <p>Gestão de usuários e permissões.</p>

  <!-- Lista de usuários (somente admin vê) -->
  <div class="table-responsive">
    <table class="table table-bordered table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>Nome</th>
          <th>CPF</th>
          <th>Telefone</th>
          <th>Endereço</th>
          <th>Status</th>
          <th style="width:120px;">Ação</th>
        </tr>
      </thead>
      <tbody id="userList">
        <tr><td colspan="6">Carregando...</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- Bloco OPERACIONAL -->
<section class="card p-3 mb-3" data-role="operacional">
  <h3 class="h5">Operacional</h3>
  <p>Rotinas operacionais do clube.</p>
</section>

<!-- Bloco ASSOCIADO -->
<section class="card p-3 mb-3" data-role="associado">
  <h3 class="h5">Associado</h3>
  <p>Informações e benefícios para associados.</p>
</section>

<script type="module">
  // Mantém alinhado ao firebase.js (v11.0.1)
  import { requireAuth, doLogout, db } from "./firebase.js";
  import { collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  requireAuth();

  const userInfo  = document.getElementById("userInfo");
  const logoutBtn = document.getElementById("logoutBtn");
  const userList  = document.getElementById("userList");

  // Aguarda requireAuth popular as variáveis globais e busca o NOME no Firestore
  const t = setInterval(async () => {
    if (window.__userRole && window.__userEmail && window.__userUid) {
      const role = String(window.__userRole).toLowerCase();

      // Busca o documento do usuário para obter o 'nome'
      try {
        const ref = doc(db, "users", window.__userUid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? snap.data() : {};
        const nome = data?.nome || window.__userEmail; // fallback para o e-mail fake, se não houver nome
        userInfo.textContent = `Logado como: ${nome} | Perfil: ${role}`;
      } catch (_) {
        // fallback silencioso
        userInfo.textContent = `Logado como: ${window.__userEmail} | Perfil: ${role}`;
      }

      applyRoleVisibility(role);

      if (role === "admin") {
        carregarUsuarios().catch(err => {
          console.error(err);
          userList.innerHTML = `<tr><td colspan="6" class="text-danger">Erro ao carregar usuários: ${err?.message || err}</td></tr>`;
        });
      }
      clearInterval(t);
    }
  }, 50);

  function applyRoleVisibility(roleLower) {
    document.querySelectorAll("[data-role]").forEach((el) => {
      const allowed = String(el.getAttribute("data-role") || "").toLowerCase();
      el.style.display = (allowed === roleLower) ? "" : "none";
    });
  }

  logoutBtn.addEventListener("click", () => doLogout());

  // ===== Somente ADMIN =====
  async function carregarUsuarios() {
    userList.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";

    const snap = await getDocs(collection(db, "users"));

    if (snap.empty) {
      userList.innerHTML = "<tr><td colspan='6'>Nenhum usuário cadastrado.</td></tr>";
      return;
    }

    let html = "";
    snap.forEach((docSnap) => {
      const u = docSnap.data() || {};
      const status = u.status || "Anuidade Pendente";
      const isAtivo = status === "Ativo";
      const btnText = isAtivo ? "Inativar" : "Ativar";
      const btnClass = isAtivo ? "btn-outline-danger" : "btn-success";

      html += `
        <tr data-row-uid="${docSnap.id}">
          <td>${u.nome || "-"}</td>
          <td>${u.cpf || "-"}</td>
          <td>${u.telefone || "-"}</td>
          <td>${u.endereco || "-"}</td>
          <td class="status-cell">${status}</td>
          <td class="text-center">
            <button class="btn btn-sm ${btnClass} toggle-status-btn"
                    data-uid="${docSnap.id}"
                    data-status="${status}">
              ${btnText}
            </button>
          </td>
        </tr>`;
    });
    userList.innerHTML = html;

    // evento dos botões (toggle)
    document.querySelectorAll(".toggle-status-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const uid = btn.dataset.uid;
        const current = btn.dataset.status || "Anuidade Pendente";
        const next = current === "Ativo" ? "Anuidade Pendente" : "Ativo";

        btn.disabled = true; // UI otimista
        try {
          await updateDoc(doc(db, "users", uid), { status: next });

          // Atualiza UI da linha
          const row = document.querySelector(`tr[data-row-uid="${uid}"]`);
          const cell = row?.querySelector(".status-cell");
          if (cell) cell.textContent = next;

          // Atualiza botão (texto, classe e dataset)
          btn.dataset.status = next;
          if (next === "Ativo") {
            btn.textContent = "Inativar";
            btn.classList.remove("btn-success");
            btn.classList.add("btn-outline-danger");
          } else {
            btn.textContent = "Ativar";
            btn.classList.remove("btn-outline-danger");
            btn.classList.add("btn-success");
          }
        } catch (err) {
          console.error(err);
          alert("Não foi possível atualizar o status. Verifique as regras do Firestore.");
        } finally {
          btn.disabled = false;
        }
      });
    });
  }
</script>
</body>

<footer class="mt-5 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div>
      <strong>Clube do Cavalo - Bonfim MG</strong> — Promovendo a cultura equestre.
    </div>
    </div>
        <div class="text-secondary small text-center">© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gestão de Associações Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>
</html>
