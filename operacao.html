<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Anti-cache leve para CSS/imagens -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Painel Administração — Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Gestão de associados, produtos, serviços e classificados.">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/custom.css?v=op-2025-09-10b">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets\img\logo_CCBMG.png">
  <link rel="shortcut icon" href="assets\img\logo_CCBMG.png" type="image/png">

  <style>
    :root{ --brand:#111279; --accent:#2a9d8f; }
    .bg-primary{ background-color:var(--brand)!important; }
    .btn-primary{ background-color:var(--brand)!important; border-color:var(--brand)!important; }
    .btn-outline-primary{ color:var(--brand)!important; border-color:var(--brand)!important; }
    .text-primary{ color:var(--brand)!important; }

    .navbar .container{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .navbar-brand{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    header { background:#f8f9fa; border-bottom:1px solid #e9ecef; }
    header .container{ padding-top:1rem; padding-bottom:1rem; }
    @media (min-width:768px){ header .container{ padding-top:1.25rem; padding-bottom:1.25rem; } }

    .tabs-sticky{ position:sticky; top:56px; z-index:1020; background:#fff; border-bottom:1px solid #e9ecef; }
    @media (min-width:992px){ .tabs-sticky{ top:64px; } }

    .badge-role{ background:var(--accent); }
    .form-help{ font-size:.875rem; color:#6c757d; }

    .list-header, .list-row{ display:grid; gap:12px; align-items:center; }
    .users-header, .user-row{ display:grid; grid-template-columns: 1fr 160px 160px; gap:12px; align-items:center; }
    .users-header{ font-weight:600; color:#495057; border-bottom:1px solid #e9ecef; padding-bottom:.5rem; }
    .user-row{ padding:.5rem 0; border-bottom:1px dashed #e9ecef; }
    .user-name{ background:none; border:0; padding:0; text-align:left; font-weight:600; color:#0d6efd; cursor:pointer; }
    .user-status .badge{ min-width:90px; }
    .user-details{ border-left:3px solid #e9ecef; margin-left:.25rem; padding-left:.75rem; }
    @media (max-width:767.98px){
      .users-header, .user-row{ grid-template-columns: 1fr 110px 110px; }
      .user-details{ margin-left:0; border-left:0; border-top:1px solid #e9ecef; padding:.75rem 0 0; }
    }

    .items4-header, .item4-row{ grid-template-columns: 1fr 160px 140px 180px; }
    .items5-header, .item5-row{ grid-template-columns: 1fr 160px 240px 120px 160px; }

    .list-header{ font-weight:600; color:#495057; border-bottom:1px solid #e9ecef; padding-bottom:.5rem; }
    .list-row{ padding:.5rem 0; border-bottom:1px dashed #e9ecef; }
    .row-title{ background:none; border:0; padding:0; text-align:left; font-weight:600; color:#0d6efd; cursor:pointer; }
    .row-badges .badge{ min-width:90px; }
    .details{ border-left:3px solid #e9ecef; margin-left:.25rem; padding-left:.75rem; }
    @media (max-width:991.98px){
      .items4-header, .item4-row{ grid-template-columns: 1fr 120px 110px 170px; }
      .items5-header, .item5-row{ grid-template-columns: 1fr 130px 200px 110px 140px; }
      .details{ margin-left:0; border-left:0; border-top:1px solid #e9ecef; padding:.75rem 0 0; }
    }

    .btn-new-assoc{ display:inline-flex; align-items:center; gap:.5rem; }
    main.container{ padding-top:1rem; padding-bottom:1.25rem; }
    .brand-logo{ height:36px; width:auto; margin-right:.5rem; object-fit:contain; filter:brightness(0) invert(1); }
    @media (min-width: 992px){ .brand-logo{ height:42px; } }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <img class="brand-logo" src="assets/img/logo_CCBMG.png?v=ccbmg-2025-09-10d" alt="Logo Clube do Cavalo">
    <a class="navbar-brand fw-bold text-truncate" href="index.html">Clube do Cavalo - Bonfim MG</a>
    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Alternar navegação">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
        <li class="nav-item me-2"><a class="nav-link" href="pg_associado.html">Área do Associado</a></li>
        <li class="nav-item"><button id="btnLogout" class="btn btn-sm btn-outline-light">Sair</button></li>
      </ul>
    </div>
  </div>
</nav>

<header>
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
    <div>
      <h1 class="h4 h3-md mb-1">Painel de Administração</h1>
      <p class="text-secondary mb-0">Gerencie associados, produtos, serviços e classificados.</p>
    </div>
    <div class="text-end">
      <div class="small">Logado como: <strong id="opName">—</strong></div>
      <span id="opRole" class="badge badge-role d-none text-uppercase">admin</span>
    </div>
  </div>
</header>

<div class="tabs-sticky">
  <div class="container">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pane-associados" type="button">Associados</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pane-produtos" type="button">Produtos</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pane-servicos" type="button">Serviços</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pane-classificados" type="button">Classificados</button></li>
    </ul>
  </div>
</div>

<main class="container">
  <div class="tab-content pt-3">

    <!-- ====================== ASSOCIADOS ====================== -->
    <div class="tab-pane fade show active" id="pane-associados">

      <!-- Cadastro novo (COLAPSADO por padrão) -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0">Associados</h5>
            <button class="btn btn-primary btn-new-assoc" type="button" data-bs-toggle="collapse" data-bs-target="#newAssocCollapse" aria-expanded="false">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-plus" viewBox="0 0 16 16"><path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m4.5 3a.5.5 0 0 1 .5.5V13h1.5a.5.5 0 0 1 0 1H11v1.5a.5.5 0 0 1-1 0V14H8.5a.5.5 0 0 1 0-1H10v-1.5a.5.5 0 0 1 .5-.5M1 13c0-2 4-3 5-3s5 1 5 3v1H1z"/></svg>
              Cadastrar novo associado
            </button>
          </div>

          <div id="newAssocCollapse" class="collapse mt-3">
            <form id="formNewAssoc" class="row g-3">
              <div class="col-sm-6 col-md-3">
                <label class="form-label">CPF (somente números)</label>
                <input type="text" class="form-control" id="naCPF" inputmode="numeric" required>
              </div>
              <div class="col-sm-6 col-md-3">
                <label class="form-label">Senha inicial</label>
                <input type="password" class="form-control" id="naPass" required>
                <div class="form-help">O associado poderá trocar depois.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Nome completo</label>
                <input type="text" class="form-control" id="naNome" required>
              </div>
              <div class="col-sm-6 col-md-4">
                <label class="form-label">Telefone</label>
                <input type="text" class="form-control" id="naTel">
              </div>
              <div class="col-sm-6 col-md-8">
                <label class="form-label">Endereço</label>
                <input type="text" class="form-control" id="naEnd">
              </div>
              <div class="col-sm-6 col-md-3">
                <label class="form-label">Anuidade paga — Data</label>
                <input type="date" class="form-control" id="naLastPayment">
              </div>
              <div class="col-sm-6 col-md-3">
                <label class="form-label">Anuidade paga — Valor (R$)</label>
                <input type="number" step="0.01" class="form-control" id="naPaidAmount" placeholder="ex.: 120.00">
              </div>
              <div class="col-sm-6 col-md-3">
                <label class="form-label">Próxima data a pagar</label>
                <input type="date" class="form-control" id="naNextDue">
              </div>
              <div class="col-sm-6 col-md-3 d-flex align-items-end">
                <button class="btn btn-primary w-100" type="submit">Criar associado</button>
              </div>
            </form>
            <div id="naMsg" class="small mt-2"></div>
          </div>
        </div>
      </div>

      <!-- Busca + lista -->
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="toolbar-wrap">
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <input type="text" class="form-control" id="searchQuery" placeholder="Buscar por CPF ou Nome" style="max-width:300px">
              <button id="btnSearch" class="btn btn-outline-primary">Buscar</button>
              <button id="btnListAll" class="btn btn-outline-secondary">Listar todos (100)</button>
            </div>
          </div>

          <div class="users-header mt-3">
            <div>Nome</div>
            <div>Perfil</div>
            <div>Status</div>
          </div>

          <div id="usersWrap" class="mt-2">
            <div class="text-center text-secondary py-3">Use a busca ou liste todos.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====================== PRODUTOS ====================== -->
    <div class="tab-pane fade" id="pane-produtos">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 id="prdFormTitle" class="mb-0">Cadastrar produto</h5>
            <button id="prdNewBtn" class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#prdCollapse" aria-expanded="false">Cadastrar produto</button>
          </div>

          <div id="prdCollapse" class="collapse mt-3">
            <form id="formProduct" class="row g-3">
              <input type="hidden" id="prdId">
              <div class="col-md-6">
                <label class="form-label">Título</label>
                <input type="text" class="form-control" id="prdTitle" required>
              </div>
              <div class="col-sm-6 col-md-3">
                <label class="form-label">Valor (R$)</label>
                <input type="number" step="0.01" class="form-control" id="prdPrice" placeholder="ex.: 199.90">
              </div>
              <div class="col-sm-6 col-md-3">
                <label class="form-label">Benefício</label>
                <input type="text" class="form-control" id="prdBenefit">
              </div>
              <div class="col-12">
                <label class="form-label">Descrição</label>
                <textarea class="form-control" id="prdDesc" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">WhatsApp de Vendas</label>
                <input type="text" class="form-control" id="prdWpp">
              </div>
              <div class="col-md-6">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="prdActive" checked>
                  <label class="form-check-label" for="prdActive">Ativo</label>
                </div>
              </div>

              <!-- Imagens PRODUTOS -->
              <div class="col-md-6">
                <label class="form-label">Imagens (até 3)</label>
                <input type="file" class="form-control" id="prdImages" accept="image/*" multiple>
                <div class="form-help">As imagens serão comprimidas (~300KB cada) e enviadas ao Storage; as URLs vão para o Firestore.</div>
              </div>
              <!-- <div class="col-md-6">
                <label class="form-label">URLs atuais (separadas por vírgula)</label>
                <input type="text" class="form-control" id="prdImagesUrls">
              </div> -->

              <div class="col-12 d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-primary" type="submit">Salvar</button>
                <span id="prdMsg" class="align-self-center text-success small"></span>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Lista PRODUTOS -->
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="toolbar-wrap">
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <input type="search" class="form-control" id="prdSearch" placeholder="Buscar por título ou benefício" style="max-width:320px">
              <select id="prdStatusFilter" class="form-select" style="max-width:200px">
                <option value="all">Status: Todos</option>
                <option value="active">Somente ativos</option>
                <option value="inactive">Somente inativos</option>
              </select>
              <button id="prdReload" class="btn btn-outline-primary">Atualizar</button>
            </div>
          </div>

          <div class="list-header items4-header mt-3">
            <div>Título</div>
            <div>Valor</div>
            <div>Status</div>
            <div>Ações</div>
          </div>
          <div id="productsWrap" class="mt-2">
            <div class="text-center text-secondary py-3">Carregando…</div>
          </div>
          <div class="small text-secondary mt-2" id="prdListMsg"></div>
        </div>
      </div>
    </div>

    <!-- ====================== SERVIÇOS ====================== -->
    <div class="tab-pane fade" id="pane-servicos">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 id="svcFormTitle" class="mb-0">Cadastrar serviço</h5>
            <button id="svcNewBtn" class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#svcCollapse" aria-expanded="false">Cadastrar serviço</button>
          </div>

          <div id="svcCollapse" class="collapse mt-3">
            <form id="formService" class="row g-3">
              <input type="hidden" id="svcId">
              <div class="col-md-6">
                <label class="form-label">Título</label>
                <input type="text" class="form-control" id="svcTitle" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Benefício para associados</label>
                <input type="text" class="form-control" id="svcBenefit">
              </div>
              <div class="col-12">
                <label class="form-label">Descrição</label>
                <textarea class="form-control" id="svcDesc" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">WhatsApp do provedor</label>
                <input type="text" class="form-control" id="svcWpp">
              </div>
              <div class="col-md-6">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="svcActive" checked>
                  <label class="form-check-label" for="svcActive">Ativo</label>
                </div>
              </div>

              <!-- Imagens SERVIÇOS (AGORA MULTIPLAS) -->
              <div class="col-md-6">
                <label class="form-label">Imagens (até 3)</label>
                <input type="file" class="form-control" id="svcImages" accept="image/*" multiple>
                <div class="form-help">As imagens serão comprimidas (~300KB cada) e enviadas ao Storage.</div>
              </div>
              <!-- <div class="col-md-6">
                <label class="form-label">URLs atuais (separadas por vírgula)</label>
                <input type="text" class="form-control" id="svcImageUrls">
              </div> -->

              <div class="col-12 d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-primary" type="submit">Salvar</button>
                <span id="svcMsg" class="align-self-center text-success small"></span>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Lista SERVIÇOS -->
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="toolbar-wrap">
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <input type="search" class="form-control" id="svcSearch" placeholder="Buscar por título ou benefício" style="max-width:320px">
              <select id="svcStatusFilter" class="form-select" style="max-width:200px">
                <option value="all">Status: Todos</option>
                <option value="active">Somente ativos</option>
                <option value="inactive">Somente inativos</option>
              </select>
              <button id="svcReload" class="btn btn-outline-primary">Atualizar</button>
            </div>
          </div>

          <div class="list-header items4-header mt-3">
            <div>Título</div>
            <div>Benefício</div>
            <div>Status</div>
            <div>Ações</div>
          </div>
          <div id="servicesWrap" class="mt-2">
            <div class="text-center text-secondary py-3">Carregando…</div>
          </div>
          <div class="small text-secondary mt-2" id="svcListMsg"></div>
        </div>
      </div>
    </div>

    <!-- ====================== CLASSIFICADOS ====================== -->
    <div class="tab-pane fade" id="pane-classificados">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 id="clsFormTitle" class="mb-0">Cadastrar classificado</h5>
            <button id="clsNewBtn" class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#clsCollapse" aria-expanded="false">Cadastrar classificado</button>
          </div>

          <div id="clsCollapse" class="collapse mt-3">
            <form id="formClassif" class="row g-3">
              <input type="hidden" id="clsId">
              <div class="col-md-6">
                <label class="form-label">Título</label>
                <input type="text" class="form-control" id="clsTitle" required>
              </div>
              <div class="col-sm-6 col-md-3">
                <label class="form-label">Valor (R$)</label>
                <input type="number" step="0.01" class="form-control" id="clsPrice">
              </div>
              <div class="col-sm-6 col-md-3">
                <label class="form-label">WhatsApp de Contato</label>
                <input type="text" class="form-control" id="clsWpp">
              </div>
              <div class="col-12">
                <label class="form-label">Descrição</label>
                <textarea class="form-control" id="clsDesc" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Imagens (múltiplas)</label>
                <input type="file" class="form-control" id="clsImages" accept="image/*" multiple>
              </div>
              <div class="col-12 d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-primary" type="submit">Salvar</button>
                <span id="clsMsg" class="align-self-center text-success small"></span>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="toolbar-wrap">
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <input type="search" class="form-control" id="clsSearch" placeholder="Buscar por título ou associado" style="max-width:320px">
              <select id="clsStatusFilter" class="form-select" style="max-width:200px">
                <option value="all">Status: Todos</option>
                <option value="active">Somente ativos</option>
                <option value="inactive">Somente inativos</option>
              </select>
              <select id="clsReviewFilter" class="form-select" style="max-width:220px">
                <option value="all">Revisão: Todos</option>
                <option value="approved">Aprovados</option>
                <option value="pending">Pendentes</option>
                <option value="rejected">Reprovados</option>
              </select>
              <input type="search" class="form-control" id="clsOwnerFilter" placeholder="Filtrar por associado (nome)" style="max-width:260px">
              <button id="clsReload" class="btn btn-outline-primary">Atualizar</button>
            </div>
          </div>

          <div class="list-header items5-header mt-3">
            <div>Título</div>
            <div>Criado em</div>
            <div>Anunciado por</div>
            <div>Status</div>
            <div>Pagamento</div>
          </div>
          <div id="classifWrap" class="mt-2">
            <div class="text-center text-secondary py-3">Carregando…</div>
          </div>
          <div class="small text-secondary mt-2" id="clsListMsg"></div>
        </div>
      </div>
    </div>

  </div>
</main>

<footer class="mt-4 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> — Painel de Administração.</div>
    </div>
        <div class="text-secondary small text-center">© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gestão de Associações Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import {
    requireAuth, cpfToEmail, setFinanceSummary,
    addMemberService, updateMemberService,
    addMemberProduct, updateMemberProduct
  } from "./firebase.js";
  import { auth, db } from "./firebase.js";

  import {
    collection, getDocs, query, orderBy, where, limit,
    doc, getDoc, setDoc, updateDoc, addDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signOut as signOutSec, signOut }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  /* ========= Requer admin/master logado ========= */
  const storage = getStorage();
  requireAuth({ requiredRole: ["Admin","Master","admin","master"] });

  const secondaryApp = initializeApp(auth.app.options, "op-secondary");
  const secAuth = getAuth(secondaryApp);

  const opNameEl = document.getElementById("opName");
  const opRoleEl = document.getElementById("opRole");
  let currentRole = "";
  const normalizeRole = (r) => String(r || "").trim().toLowerCase();

  async function getCurrentRole() {
    if (currentRole) return currentRole;
    const user = auth.currentUser;
    if (!user) return "";
    try {
      const snap = await getDoc(doc(db, "users", user.uid));
      const roleDoc = snap.exists() ? snap.data().role : "";
      const normalized = normalizeRole(roleDoc);
      currentRole = normalized || "admin";
      return currentRole;
    } catch {
      currentRole = "admin";
      return currentRole;
    }
  }

  auth.onAuthStateChanged(async (user) => {
    if (!user) return;
    const snap = await getDoc(doc(db, "users", user.uid));
    const d = snap.exists() ? snap.data() : {};
    opNameEl.textContent = d.nome || "Operador(a)";
    const role = normalizeRole(d.role) || "admin";
    currentRole = role;
    opRoleEl.textContent = role;
    opRoleEl.classList.remove("d-none");

    try { if (document.getElementById("usersWrap")) listUsers(""); } catch(e){ console.warn("Lista de associados não renderizada:", e); }

    loadProducts();
    loadServices();
    loadClassif();
  });

  document.getElementById("btnLogout")?.addEventListener("click", async ()=>{
    try { await signOut(auth); location.href = "login.html"; }
    catch(e){ alert("Não foi possível sair: " + e.message); }
  });

  const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  const readUrls = (el)=> (el?.value||"").split(",").map(s=>s.trim()).filter(Boolean);

  /* ===================== UTIL: COMPRESSAO & UPLOAD (<=3 imgs, ~300KB) ===================== */

  async function fileToImage(file){
    const dataUrl = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
    return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res({img, dataUrl}); img.onerror=rej; img.src=dataUrl; });
  }

  async function canvasToBlob(canvas, mime="image/jpeg", quality=0.9){
    return new Promise((res)=> canvas.toBlob((b)=>res(b), mime, quality));
  }

  async function compressImageToUnder(file, maxKB=300, maxW=1600, maxH=1600){
    // Convertemos tudo para JPEG para garantir boa compressão
    const { img } = await fileToImage(file);
    // escala
    let { width, height } = img;
    const ratio = Math.min(1, maxW / width, maxH / height);
    width = Math.max(1, Math.round(width * ratio));
    height = Math.max(1, Math.round(height * ratio));

    const canvas = document.createElement("canvas");
    canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);

    let q = 0.9;
    let blob = await canvasToBlob(canvas, "image/jpeg", q);
    const target = maxKB * 1024;

    // Tenta reduzir qualidade
    while (blob && blob.size > target && q > 0.45){
      q -= 0.08;
      blob = await canvasToBlob(canvas, "image/jpeg", q);
    }

    // Se ainda estiver grande, reduz dimensão e tenta novamente
    while (blob && blob.size > target && (canvas.width > 640 || canvas.height > 640)){
      canvas.width = Math.round(canvas.width * 0.9);
      canvas.height = Math.round(canvas.height * 0.9);
      const ctx2 = canvas.getContext("2d");
      ctx2.drawImage(img, 0, 0, canvas.width, canvas.height);
      q = Math.max(0.5, q - 0.05);
      blob = await canvasToBlob(canvas, "image/jpeg", q);
    }

    // fallback final
    if (!blob) blob = new Blob([file], { type: "image/jpeg" });

    const newName = (file.name.replace(/\.[^.]+$/, "") || "img") + ".jpg";
    return new File([blob], newName, { type: "image/jpeg" });
  }

  async function uploadManyCompressed(files, folder, maxCount=3, maxKB=300){
    const urls = [];
    const safe = Array.from(files || []).filter(f=>f && f.type?.startsWith("image/"));
    if (!safe.length) return urls;

    if (safe.length > maxCount){
      alert(`Serão consideradas apenas ${maxCount} imagens.`);
    }
    const chosen = safe.slice(0, maxCount);

    for (const original of chosen){
      if (original.size > 7 * 1024 * 1024){
        alert(`Imagem "${original.name}" acima de 7MB não permitida.`);
        continue;
      }
      // comprime
      const compressed = await compressImageToUnder(original, maxKB, 1600, 1600);

      const path = `${folder}/${Date.now()}_${Math.random().toString(36).slice(2)}_${compressed.name}`;
      const r = sref(storage, path);
      await new Promise((resolve, reject) => {
        const task = uploadBytesResumable(r, compressed, { contentType: compressed.type || "image/jpeg" });
        task.on("state_changed", null, reject, resolve);
      });
      urls.push(await getDownloadURL(r));
    }
    return urls;
  }

  /* ===================== ASSOCIADOS ===================== */
  const formNewAssoc = document.getElementById("formNewAssoc");
  const naCPF = document.getElementById("naCPF");
  const naPass = document.getElementById("naPass");
  const naNome = document.getElementById("naNome");
  const naTel  = document.getElementById("naTel");
  const naEnd  = document.getElementById("naEnd");
  const naLastPayment = document.getElementById("naLastPayment");
  const naPaidAmount  = document.getElementById("naPaidAmount");
  const naNextDue     = document.getElementById("naNextDue");
  const naMsg  = document.getElementById("naMsg");

  formNewAssoc?.addEventListener("submit", async (e) => {
    e.preventDefault();
    naMsg.textContent = "Criando associado...";
    try {
      const email = cpfToEmail(naCPF.value);
      const cred = await createUserWithEmailAndPassword(secAuth, email, naPass.value);
      const uid = cred.user.uid;

      await setDoc(doc(db, "users", uid), {
        cpf: naCPF.value.trim(),
        nome: naNome.value.trim(),
        telefone: naTel.value.trim(),
        endereco: naEnd.value.trim(),
        role: "Associado",
        ativo: true,
        status: "Anuidade Pendente",
        createdAt: (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")).serverTimestamp()
      }, { merge: true });

      await setFinanceSummary(uid, {
        lastPayment: naLastPayment.value || undefined,
        lastAmount: naPaidAmount.value || undefined,
        nextDue: naNextDue.value || undefined
      });

      naMsg.textContent = `Associado criado! UID: ${uid}`;
      formNewAssoc.reset();
      await signOutSec(secAuth);
      listUsers("");
    } catch (err) {
      naMsg.textContent = "Erro: " + err.message;
    }
  });

  const usersWrap = document.getElementById("usersWrap");
  const searchQuery = document.getElementById("searchQuery");
  document.getElementById("btnSearch")?.addEventListener("click", ()=> listUsers(searchQuery.value.trim()));
  document.getElementById("btnListAll")?.addEventListener("click", ()=> listUsers(""));

  async function listUsers(term) {
    if (!usersWrap) return;
    usersWrap.innerHTML = `<div class="text-center text-secondary py-3">Carregando...</div>`;

    const roleNow = normalizeRole(await getCurrentRole());
    const canSeeAll = (roleNow === "admin" || roleNow === "master");

    if (!canSeeAll) {
      try {
        const user = auth.currentUser;
        if (!user) { usersWrap.innerHTML = `<div class="text-center text-danger py-3">Sessão inválida.</div>`; return; }
        const snap = await getDoc(doc(db,"users", user.uid));
        if (!snap.exists()) { usersWrap.innerHTML = `<div class="text-center text-secondary py-3">Seu perfil não foi encontrado.</div>`; return; }

        let last = "—", next = "—", lastAmount = 0;
        try {
          const s = await getDoc(doc(db, "users", user.uid, "finance", "summary"));
          if (s.exists()) {
            const sd = s.data();
            last = toDateStr(sd.lastPayment); next = toDateStr(sd.nextDue);
            lastAmount = sd.lastAmount ?? 0;
          }
        } catch {}
        usersWrap.innerHTML = renderUserRow({ uid: user.uid, ...snap.data(), last, next, lastAmount });
        attachUserHandlers();
        return;
      } catch (e) {
        usersWrap.innerHTML = `<div class="text-center text-danger py-3">Falha ao carregar seu perfil.</div>`;
        return;
      }
    }

    let docs = [];
    try {
      if (!term) {
        const snap = await getDocs(query(collection(db,"users"), orderBy("nome"), limit(100)));
        docs = snap.docs;
      } else if (/^\d{5,}$/.test(term)) {
        const snap = await getDocs(query(collection(db,"users"), where("cpf","==", term)));
        docs = snap.docs;
      } else {
        const snap = await getDocs(query(collection(db,"users"), orderBy("nome"), limit(100)));
        const lower = term.toLowerCase();
        docs = snap.docs.filter(d => (d.data().nome || "").toLowerCase().includes(lower));
      }
    } catch (e) {
      usersWrap.innerHTML = `<div class="text-center text-danger py-3">Falha ao consultar usuários.</div>`;
      return;
    }

    if (!docs.length) { usersWrap.innerHTML = `<div class="text-center text-secondary py-3">Nenhum associado encontrado.</div>`; return; }

    usersWrap.innerHTML = docs.map(d=>{
      const u = d.data(); const uid = d.id;
      return renderUserRow({ uid, ...u, last:"", next:"", lastAmount:0 });
    }).join("");
    attachUserHandlers();

    for (const d of docs) {
      const uid = d.id;
      try {
        const s = await getDoc(doc(db, "users", uid, "finance", "summary"));
        if (s.exists()) {
          const sd = s.data();
          const el = document.querySelector(`#u-${uid} [data-uid="${uid}"][data-field="lastPayment"]`);
          if (el) el.value = toDateStr(sd.lastPayment);
          const el2 = document.querySelector(`#u-${uid} [data-uid="${uid}"][data-field="lastAmount"]`);
          if (el2) el2.value = sd.lastAmount ?? 0;
          const el3 = document.querySelector(`#u-${uid} [data-uid="${uid}"][data-field="nextDue"]`);
          if (el3) el3.value = toDateStr(sd.nextDue);
        }
      } catch {}
    }
  }
  function toDateStr(v){ try { const d = v?.toDate ? v.toDate() : (v? new Date(v): null); return d? d.toISOString().slice(0,10) : ""; } catch { return ""; } }

  function renderUserRow(u) {
    const ativo = (u.ativo !== false);
    const role = normalizeRole(u.role || "associado");
    const status = u.status || (ativo ? "Ativo" : "Inativo");
    const uidSafe = String(u.uid).replace(/[^a-zA-Z0-9_-]/g,'');
    const collapseId = `u-${uidSafe}`;
    return `
      <div class="user-row">
        <button class="user-name" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
          ${u.nome || "Sem nome"}
        </button>
        <div class="text-uppercase small"><span class="badge badge-role">${role}</span></div>
        <div class="user-status"><span class="badge ${ativo ? 'bg-success' : 'bg-secondary'}">${status}</span></div>
      </div>
      <div id="${collapseId}" class="collapse">
        <div class="user-details">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control" data-uid="${u.uid}" data-field="nome" value="${u.nome || ''}">
            </div>
            <div class="col-md-2">
              <label class="form-label">CPF</label>
              <input type="text" class="form-control" data-uid="${u.uid}" data-field="cpf" value="${u.cpf || ''}">
            </div>
            <div class="col-md-2">
              <label class="form-label">Telefone</label>
              <input type="text" class="form-control" data-uid="${u.uid}" data-field="telefone" value="${u.telefone || ''}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Endereço</label>
              <input type="text" class="form-control" data-uid="${u.uid}" data-field="endereco" value="${u.endereco || ''}">
            </div>
            <div class="col-md-2">
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" data-uid="${u.uid}" data-field="ativo" ${ativo?'checked':''}>
                <label class="form-check-label">Ativo</label>
              </div>
            </div>
            <div class="col-sm-6 col-md-2">
              <label class="form-label">Último pagto (data)</label>
              <input type="date" class="form-control" data-uid="${u.uid}" data-field="lastPayment" value="">
            </div>
            <div class="col-sm-6 col-md-2">
              <label class="form-label">Último pagto (valor)</label>
              <input type="number" step="0.01" class="form-control" data-uid="${u.uid}" data-field="lastAmount" value="">
            </div>
            <div class="col-sm-6 col-md-2">
              <label class="form-label">Próximo pagto</label>
              <input type="date" class="form-control" data-uid="${u.uid}" data-field="nextDue" value="">
            </div>
            <div class="col-sm-6 col-md-2">
              <button class="btn btn-outline-primary w-100 btn-save-profile" data-uid="${u.uid}">Salvar Perfil</button>
            </div>
            <div class="col-sm-6 col-md-2">
              <button class="btn btn-primary w-100 btn-save-fin" data-uid="${u.uid}">Salvar Financeiro</button>
            </div>
          </div>
        </div>
      </div>`;
  }
  function attachUserHandlers() {
    document.querySelectorAll(".btn-save-profile").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const uid = e.target.dataset.uid;
        const q = (f)=> document.querySelector(`[data-uid="${uid}"][data-field="${f}"]`);
        const payload = {
          nome: q("nome").value.trim(),
          cpf: q("cpf").value.trim(),
          telefone: q("telefone").value.trim(),
          endereco: q("endereco").value.trim(),
          ativo: q("ativo").checked
        };
        try { await updateDoc(doc(db,"users",uid), payload); e.target.textContent="Perfil salvo!"; setTimeout(()=>e.target.textContent="Salvar Perfil",1200); }
        catch (err) { alert("Erro ao salvar perfil: "+err.message); }
      });
    });
    document.querySelectorAll(".btn-save-fin").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const uid = e.target.dataset.uid;
        const q = (f)=> document.querySelector(`[data-uid="${uid}"][data-field="${f}"]`);
        try {
          await setFinanceSummary(uid, {
            lastPayment: q("lastPayment").value,
            lastAmount: q("lastAmount").value,
            nextDue: q("nextDue").value
          });
          e.target.textContent="Financeiro salvo!"; setTimeout(()=>e.target.textContent="Salvar Financeiro",1200);
        } catch (err) { alert("Erro ao salvar financeiro: "+err.message); }
      });
    });
  }

  /* ===================== PRODUTOS ===================== */
  const prdId = document.getElementById("prdId");
  const prdTitle = document.getElementById("prdTitle");
  const prdBenefit = document.getElementById("prdBenefit");
  const prdDesc = document.getElementById("prdDesc");
  const prdWpp = document.getElementById("prdWpp");
  const prdActive = document.getElementById("prdActive");
  const prdImages = document.getElementById("prdImages");
  const prdPrice = document.getElementById("prdPrice");
  const prdMsg = document.getElementById("prdMsg");
  const prdSearch = document.getElementById("prdSearch");
  const prdStatusFilter = document.getElementById("prdStatusFilter");
  const prdReload = document.getElementById("prdReload");

  document.getElementById("prdNewBtn")?.addEventListener("click", ()=>{
    prdId.value=""; document.getElementById("formProduct").reset(); prdActive.checked=true; prdMsg.textContent="";
  });

document.getElementById("formProduct")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  prdMsg.classList.remove("text-danger");
  prdMsg.textContent = "Enviando...";

  const title = prdTitle.value.trim();
  const description = prdDesc.value.trim();
  const benefit = prdBenefit.value.trim();
  const whatsapp = prdWpp.value.trim();
  const price = prdPrice.value ? Number(prdPrice.value) : null;
  const active = prdActive.checked;

  try {
    // 1) compõe lista de imagens (até 3): URLs manuais + uploads
    let images = [];
    const remaining = 3 - images.length;

    if (remaining > 0 && prdImages.files?.length) {
      const toUpload = Array.from(prdImages.files).slice(0, remaining);
      prdMsg.textContent = "Compactando e enviando imagens...";
      const uploaded = await uploadManyCompressed(toUpload, "uploads/products", remaining, 300);
      images = images.concat(uploaded).slice(0, 3);
    } else if (prdImages.files?.length > 0 && remaining <= 0) {
      alert("Você já informou 3 imagens/URLs. As imagens selecionadas não serão enviadas.");
    }

    // 2) salva no Firestore
    if (prdId.value) {
      await updateMemberProduct(prdId.value, { title, description, benefit, whatsapp, price, imageUrls: images, active });
      prdMsg.textContent = "Produto atualizado!";
    } else {
      const id = await addMemberProduct({ title, description, benefit, imageUrls: images, whatsapp, price });
      await updateMemberProduct(id, { active });
      prdMsg.textContent = `Produto salvo! ID: ${id}`;
    }

    // 3) recarrega lista
    prdImages.value = "";
    loadProducts();
  } catch (err) {
    console.error(err);
    prdMsg.classList.add("text-danger");
    prdMsg.textContent = "Erro ao salvar: " + (err?.message || err);
    if (String(err?.message || "").includes("storage/unauthorized")) {
      alert("Sem permissão para enviar ao Storage. Confira as Regras do Firebase Storage (veja o passo 1 acima).");
    }
  }
});


  prdReload?.addEventListener("click", loadProducts);
  prdSearch?.addEventListener("input", ()=>renderProducts());
  prdStatusFilter?.addEventListener("change", ()=>renderProducts());

  let productsRows = [];
  async function loadProducts() {
    const wrap = document.getElementById("productsWrap");
    if (!wrap) return;
    wrap.innerHTML = `<div class="text-center text-secondary py-3">Carregando...</div>`;
    try {
      const snap = await getDocs(query(collection(db,"memberProducts"), orderBy("title")));
      productsRows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderProducts();
    } catch { wrap.innerHTML = `<div class="text-center text-danger py-3">Falha ao carregar.</div>`; }
  }
  function renderProducts(){
    const wrap = document.getElementById("productsWrap");
    if (!wrap) return;
    const q = (prdSearch.value||"").trim().toLowerCase();
    const status = prdStatusFilter.value;
    let rows = productsRows.slice();
    rows = rows.filter(r=>{
      const okStatus = status==="all" ? true : (status==="active" ? (r.active!==false) : (r.active===false));
      const hay = [(r.title||""),(r.benefit||"")].join(" ").toLowerCase();
      return okStatus && (q? hay.includes(q) : true);
    });
    if (!rows.length){ wrap.innerHTML = `<div class="text-center text-secondary py-3">Nenhum produto.</div>`; return; }
    wrap.innerHTML = rows.map(r=>productRow(r)).join("");
    attachProductHandlers(rows);
    document.getElementById("prdListMsg").textContent = `${rows.length} item(ns)`;
  }
  function productRow(p){
    const idSafe = p.id.replace(/[^a-zA-Z0-9_-]/g,'');
    const cid = `p-${idSafe}`;
    const sub = [p.price!=null?fmt.format(p.price):"", p.benefit||""].filter(Boolean).join(" • ");
    const badge = (p.active!==false) ? '<span class="badge bg-success">Ativo</span>' : '<span class="badge bg-secondary">Inativo</span>';
    return `
      <div class="item4-row list-row">
        <button class="row-title" type="button" data-bs-toggle="collapse" data-bs-target="#${cid}" aria-expanded="false">${p.title||"—"}</button>
        <div class="small text-secondary">${sub||"&nbsp;"}</div>
        <div class="row-badges">${badge}</div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-sm btn-outline-primary btn-edit-product" data-id="${p.id}">Editar</button>
          <button class="btn btn-sm ${p.active!==false?'btn-outline-secondary':'btn-outline-success'} btn-toggle-product" data-id="${p.id}" data-action="${p.active!==false?'deactivate':'activate'}">${p.active!==false?'Inativar':'Ativar'}</button>
        </div>
      </div>
      <div id="${cid}" class="collapse">
        <div class="details">
          <div class="small text-secondary mb-1">WhatsApp: ${p.whatsapp||"—"}</div>
          <div>${(p.description||"").replace(/\n/g,"<br>")}</div>
        </div>
      </div>`;
  }
  function attachProductHandlers(rows){
    document.querySelectorAll(".btn-edit-product").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        const id = e.currentTarget.dataset.id; const p = rows.find(x=>x.id===id); if(!p) return;
        prdId.value=id; prdTitle.value=p.title||""; prdBenefit.value=p.benefit||""; prdDesc.value=p.description||"";
        prdWpp.value=p.whatsapp||""; prdActive.checked=(p.active!==false); prdPrice.value=p.price??"";
        prdImages.value="";
        const coll = document.getElementById("prdCollapse"); if (coll && !coll.classList.contains("show")) new bootstrap.Collapse(coll,{toggle:true});
        window.scrollTo({ top: document.getElementById("pane-produtos").getBoundingClientRect().top + window.scrollY - 90, behavior:"smooth" });
      });
    });
    document.querySelectorAll(".btn-toggle-product").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const id=e.currentTarget.dataset.id; const activating=e.currentTarget.dataset.action==="activate";
        try { await updateMemberProduct(id, { active: activating }); loadProducts(); }
        catch(err){ alert("Erro ao atualizar: "+err.message); }
      });
    });
  }

  /* ===================== SERVIÇOS ===================== */
  const svcId = document.getElementById("svcId");
  const svcTitle = document.getElementById("svcTitle");
  const svcBenefit = document.getElementById("svcBenefit");
  const svcDesc = document.getElementById("svcDesc");
  const svcWpp = document.getElementById("svcWpp");
  const svcActive = document.getElementById("svcActive");
  const svcImages = document.getElementById("svcImages");       // novo: múltiplas
  const svcMsg = document.getElementById("svcMsg");
  const svcSearch = document.getElementById("svcSearch");
  const svcStatusFilter = document.getElementById("svcStatusFilter");
  const svcReload = document.getElementById("svcReload");

  document.getElementById("svcNewBtn")?.addEventListener("click", ()=>{
    svcId.value=""; document.getElementById("formService").reset(); svcActive.checked=true; svcMsg.textContent="";
  });

document.getElementById("formService")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  svcMsg.classList.remove("text-danger");
  svcMsg.textContent = "Enviando...";

  const title = svcTitle.value.trim();
  const description = svcDesc.value.trim();
  const benefit = svcBenefit.value.trim();
  const whatsapp = svcWpp.value.trim();
  const active = svcActive.checked;

  try {
    // 1) compõe lista de imagens (até 3): URLs manuais + uploads
    let imageUrls = [];
    const remaining = 3 - imageUrls.length;

    if (remaining > 0 && svcImages.files?.length) {
      const toUpload = Array.from(svcImages.files).slice(0, remaining);
      svcMsg.textContent = "Compactando e enviando imagens...";
      const uploaded = await uploadManyCompressed(toUpload, "uploads/services", remaining, 300);
      imageUrls = imageUrls.concat(uploaded).slice(0, 3);
    } else if (svcImages.files?.length > 0 && remaining <= 0) {
      alert("Você já informou 3 imagens/URLs. As imagens selecionadas não serão enviadas.");
    }

    // compatibilidade: mantém imageUrl = primeira
    const imageUrl = imageUrls[0] || "";

    // 2) salva no Firestore
    if (svcId.value) {
      await updateMemberService(svcId.value, { title, description, benefit, whatsapp, imageUrl, imageUrls, active });
      svcMsg.textContent = "Serviço atualizado!";
    } else {
      const id = await addMemberService({ title, description, benefit, imageUrl, imageUrls, whatsapp });
      await updateMemberService(id, { active });
      svcMsg.textContent = `Serviço salvo! ID: ${id}`;
    }

    // 3) recarrega lista
    svcImages.value = "";
    loadServices();
  } catch (err) {
    console.error(err);
    svcMsg.classList.add("text-danger");
    svcMsg.textContent = "Erro ao salvar: " + (err?.message || err);
    if (String(err?.message || "").includes("storage/unauthorized")) {
      alert("Sem permissão para enviar ao Storage. Confira as Regras do Firebase Storage (veja o passo 1 acima).");
    }
  }
});


  svcReload?.addEventListener("click", loadServices);
  svcSearch?.addEventListener("input", ()=>renderServices());
  svcStatusFilter?.addEventListener("change", ()=>renderServices());

  let servicesRows = [];
  async function loadServices() {
    const wrap = document.getElementById("servicesWrap");
    if (!wrap) return;
    wrap.innerHTML = `<div class="text-center text-secondary py-3">Carregando...</div>`;
    try {
      const snap = await getDocs(query(collection(db,"memberServices"), orderBy("title")));
      servicesRows = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderServices();
    } catch { wrap.innerHTML = `<div class="text-center text-danger py-3">Falha ao carregar.</div>`; }
  }
  function renderServices(){
    const wrap = document.getElementById("servicesWrap");
    if (!wrap) return;
    const q = (svcSearch.value||"").trim().toLowerCase();
    const status = svcStatusFilter.value;
    let rows = servicesRows.slice();
    rows = rows.filter(r=>{
      const okStatus = status==="all" ? true : (status==="active" ? (r.active!==false) : (r.active===false));
      const hay = [(r.title||""),(r.benefit||"")].join(" ").toLowerCase();
      return okStatus && (q? hay.includes(q) : true);
    });
    if (!rows.length){ wrap.innerHTML = `<div class="text-center text-secondary py-3">Nenhum serviço.</div>`; return; }
    wrap.innerHTML = rows.map(r=>serviceRow(r)).join("");
    attachServiceHandlers(rows);
    document.getElementById("svcListMsg").textContent = `${rows.length} item(ns)`;
  }
  function serviceRow(s){
    const idSafe = s.id.replace(/[^a-zA-Z0-9_-]/g,'');
    const cid = `s-${idSafe}`;
    const badge = (s.active!==false) ? '<span class="badge bg-success">Ativo</span>' : '<span class="badge bg-secondary">Inativo</span>';
    return `
      <div class="item4-row list-row">
        <button class="row-title" type="button" data-bs-toggle="collapse" data-bs-target="#${cid}" aria-expanded="false">${s.title||"—"}</button>
        <div class="small text-secondary">${s.benefit||"&nbsp;"}</div>
        <div class="row-badges">${badge}</div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-sm btn-outline-primary btn-edit-service" data-id="${s.id}">Editar</button>
          <button class="btn btn-sm ${s.active!==false?'btn-outline-secondary':'btn-outline-success'} btn-toggle-service" data-id="${s.id}" data-action="${s.active!==false?'deactivate':'activate'}">${s.active!==false?'Inativar':'Ativar'}</button>
        </div>
      </div>
      <div id="${cid}" class="collapse">
        <div class="details">
          <div class="small text-secondary mb-1">WhatsApp: ${s.whatsapp||"—"}</div>
          <div>${(s.description||"").replace(/\n/g,"<br>")}</div>
        </div>
      </div>`;
  }
  function attachServiceHandlers(rows){
    document.querySelectorAll(".btn-edit-service").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        const id = e.currentTarget.dataset.id; const s = rows.find(x=>x.id===id); if(!s) return;
        svcId.value=id; svcTitle.value=s.title||""; svcBenefit.value=s.benefit||""; svcDesc.value=s.description||"";
        svcWpp.value=s.whatsapp||""; svcActive.checked=(s.active!==false);
        svcImages.value="";
        const coll = document.getElementById("svcCollapse"); if (coll && !coll.classList.contains("show")) new bootstrap.Collapse(coll,{toggle:true});
        window.scrollTo({ top: document.getElementById("pane-servicos").getBoundingClientRect().top + window.scrollY - 90, behavior:"smooth" });
      });
    });
    document.querySelectorAll(".btn-toggle-service").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const id=e.currentTarget.dataset.id; const activating=e.currentTarget.dataset.action==="activate";
        try { await updateMemberService(id, { active: activating }); loadServices(); }
        catch(err){ alert("Erro ao atualizar: "+err.message); }
      });
    });
  }

  /* ===================== CLASSIFICADOS (inalterado no pedido) ===================== */
  const clsId = document.getElementById("clsId");
  const clsTitle = document.getElementById("clsTitle");
  const clsPrice = document.getElementById("clsPrice");
  const clsDesc = document.getElementById("clsDesc");
  const clsWpp = document.getElementById("clsWpp");
  const clsImages = document.getElementById("clsImages");
  const clsMsg = document.getElementById("clsMsg");
  const clsSearch = document.getElementById("clsSearch");
  const clsStatusFilter = document.getElementById("clsStatusFilter");
  const clsReviewFilter = document.getElementById("clsReviewFilter");
  const clsOwnerFilter = document.getElementById("clsOwnerFilter");
  const clsReload = document.getElementById("clsReload");

  document.getElementById("clsNewBtn")?.addEventListener("click", ()=>{
    clsId.value=""; document.getElementById("formClassif").reset(); clsMsg.textContent="";
  });

  document.getElementById("formClassif")?.addEventListener("submit", async (e)=>{
    e.preventDefault(); clsMsg.textContent="";
    const title=clsTitle.value.trim(), description=clsDesc.value.trim(), price=clsPrice.value?Number(clsPrice.value):null, whatsapp=clsWpp.value.trim();
    let images = [];
    if (clsImages.files?.length) {
      // Mantemos comportamento original de classificados (sem compressão obrigatória no pedido)
      const up = await uploadManyCompressed(clsImages.files, "uploads/classifieds", 10, 600); // leve compressão para evitar estouro
      images = images.concat(up);
    }

    let createdBy = auth.currentUser?.uid || null;
    let createdByName = "—";
    try {
      if (createdBy) {
        const u = await getDoc(doc(db,"users", createdBy));
        if (u.exists()) createdByName = u.data().nome || createdByName;
      }
    } catch {}

    try {
      if (clsId.value) {
        await updateDoc(doc(db,"memberClassifieds",clsId.value), {
          title, description, price, whatsapp, imageUrls: images,
          updatedAt: (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")).serverTimestamp()
        });
        clsMsg.textContent="Classificado atualizado!";
      } else {
        const ref = await addDoc(collection(db,"memberClassifieds"), {
          title, description, price, whatsapp, imageUrls: images,
          active: true,
          approved: false,
          reviewed: false,
          paymentStatus: "pendente",
          createdBy, createdByName,
          createdAt: (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")).serverTimestamp(),
          updatedAt: (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")).serverTimestamp()
        });
        clsMsg.textContent = `Classificado salvo! ID: ${ref.id}`;
      }
      loadClassif();
    } catch(err){ alert("Erro ao salvar classificado: "+err.message); }
  });

  clsReload?.addEventListener("click", loadClassif);
  clsSearch?.addEventListener("input", ()=>renderClassif());
  clsStatusFilter?.addEventListener("change", ()=>renderClassif());
  clsReviewFilter?.addEventListener("change", ()=>renderClassif());
  clsOwnerFilter?.addEventListener("input", ()=>renderClassif());

  let classifRows = [];
  async function loadClassif() {
    const wrap = document.getElementById("classifWrap");
    if (!wrap) return;
    wrap.innerHTML = `<div class="text-center text-secondary py-3">Carregando...</div>`;
    try {
      const snap = await getDocs(query(collection(db,"memberClassifieds"), orderBy("title")));
      classifRows = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderClassif();
    } catch { wrap.innerHTML = `<div class="text-center text-danger py-3">Falha ao carregar.</div>`; }
  }

  function renderClassif(){
    const wrap = document.getElementById("classifWrap");
    if (!wrap) return;
    const q = (clsSearch.value||"").trim().toLowerCase();
    const status = clsStatusFilter.value;
    const rf = clsReviewFilter.value;
    const ownerQ = (clsOwnerFilter.value||"").trim().toLowerCase();

    let rows = classifRows.slice();
    rows = rows.filter(r=>{
      const okStatus = status==="all" ? true : (status==="active" ? (r.active!==false) : (r.active===false));
      const state = (r.reviewed===true && r.approved===true) ? "approved" : (r.reviewed===true && r.approved===false) ? "rejected" : "pending";
      const okReview = rf==="all" ? true : (rf===state);
      const hay = [(r.title||""),(r.createdByName||"")].join(" ").toLowerCase();
      const okQ = q ? hay.includes(q) : true;
      const okOwner = ownerQ ? (String(r.createdByName||"").toLowerCase().includes(ownerQ)) : true;
      return okStatus && okReview && okQ && okOwner;
    });

    if (!rows.length){
      wrap.innerHTML = `<div class="text-center text-secondary py-3">Nenhum classificado.</div>`;
      document.getElementById("clsListMsg").textContent="0 item(s)";
      return;
    }

    wrap.innerHTML = rows.map(r=>classifRow(r)).join("");
    attachClassifHandlers(rows);
    document.getElementById("clsListMsg").textContent = `${rows.length} item(ns)`;
  }

  function classifRow(c){
    const idSafe = c.id.replace(/[^a-zA-Z0-9_-]/g,'');
    const cid = `c-${idSafe}`;
    const badgeActive = (c.active!==false) ? '<span class="badge bg-success">Ativo</span>' : '<span class="badge bg-secondary">Inativo</span>';

    const owner = c.ownerName || "—";
    const pay = (c.paymentStatus || "pendente").toLowerCase();
    const payBadge =
      pay === "pago" ? '<span class="badge bg-success">Pago</span>' :
      pay === "estornado" ? '<span class="badge bg-secondary">Estornado</span>' :
      '<span class="badge bg-warning text-dark">Pendente</span>';

    const createdAtStr = (() => {
      try {
        const d = c.createdAt?.toDate ? c.createdAt.toDate() : (c.createdAt ? new Date(c.createdAt) : null);
        if (!d) return "—";
        return d.toLocaleDateString("pt-BR") + " " + d.toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"});
      } catch { return "—"; }
    })();

    const galeria = Array.isArray(c.imageUrls) && c.imageUrls.length
      ? `<div class="d-flex flex-wrap gap-2 mt-2">${c.imageUrls.map(u =>
          `<a href="${u}" target="_blank" rel="noopener">
             <img src="${u}" alt="Foto" style="width:110px;height:110px;object-fit:cover;border:1px solid #e9ecef;border-radius:8px;">
           </a>`).join("")}
         </div>`
      : `<div class="text-secondary small">Sem fotos</div>`;

    return `
      <div class="item5-row list-row">
        <button class="row-title" type="button" data-bs-toggle="collapse" data-bs-target="#${cid}" aria-expanded="false">
          ${c.title||"—"}
        </button>
        <div class="small text-secondary">${createdAtStr}</div>
        <div class="small">${owner}</div>
        <div class="row-badges">${badgeActive}</div>
        <div class="row-badges">${payBadge}</div>
      </div>

      <div id="${cid}" class="collapse">
        <div class="details">
          <div class="mb-2"><strong>Descrição:</strong><br>${(c.description||"—").replace(/\n/g,"<br>")}</div>
          <div class="small text-secondary mb-2"><strong>Contato (WhatsApp):</strong> ${c.whatsapp||"—"}</div>
          ${galeria}
          <div class="d-flex flex-wrap gap-2 mt-3">
            <button class="btn btn-sm btn-outline-primary btn-edit-classif" data-id="${c.id}">Editar</button>
            <button class="btn btn-sm ${c.active!==false?'btn-outline-secondary':'btn-outline-success'} btn-toggle-classif" data-id="${c.id}" data-action="${c.active!==false?'deactivate':'activate'}">${c.active!==false?'Inativar':'Ativar'}</button>
            <button class="btn btn-sm btn-outline-success btn-approve-classif" data-action="approve" data-id="${c.id}">Aprovar</button>
            <button class="btn btn-sm btn-outline-danger btn-approve-classif" data-action="reject" data-id="${c.id}">Reprovar</button>
          </div>
        </div>
      </div>`;
  }

  function attachClassifHandlers(rows){
    document.querySelectorAll(".btn-edit-classif").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        const id = e.currentTarget.dataset.id; const c = rows.find(x=>x.id===id); if(!c) return;
        clsId.value=id; clsTitle.value=c.title||""; clsDesc.value=c.description||""; clsWpp.value=c.whatsapp||"";
        clsPrice.value=c.price??""; clsImages.value="";
        const coll = document.getElementById("clsCollapse"); if (coll && !coll.classList.contains("show")) new bootstrap.Collapse(coll,{toggle:true});
        window.scrollTo({ top: document.getElementById("pane-classificados").getBoundingClientRect().top + window.scrollY - 90, behavior:"smooth" });
      });
    });
    document.querySelectorAll(".btn-toggle-classif").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const id=e.currentTarget.dataset.id; const activating=e.currentTarget.dataset.action==="activate";
        try { await updateDoc(doc(db,"memberClassifieds",id), { active: activating }); loadClassif(); }
        catch(err){ alert("Erro ao atualizar: "+err.message); }
      });
    });
    document.querySelectorAll(".btn-approve-classif").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const id=e.currentTarget.dataset.id;
        const action=e.currentTarget.dataset.action; // approve|reject
        const payload = (action==="approve")
          ? { approved:true, reviewed:true, active:true, paymentStatus:"pago" }
          : { approved:false, reviewed:true };
        try {
          await updateDoc(doc(db,"memberClassifieds",id), {
            ...payload,
            updatedAt: (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")).serverTimestamp()
          });
          loadClassif();
        }
        catch(err){ alert("Erro ao aprovar/reprovar: "+err.message); }
      });
    });
  }

  // UX: rolar para abaixo do topo fixo ao trocar de aba
  document.querySelectorAll('[data-bs-toggle="tab"]').forEach(btn=>{
    btn.addEventListener('shown.bs.tab', ()=>{
      const y = document.querySelector('.tabs-sticky').getBoundingClientRect().top + window.scrollY - 1;
      window.scrollTo({ top: y, behavior: 'smooth' });
    });
  });
</script>
</body>
</html>
