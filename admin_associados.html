<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Admin — Associados | Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Gestão de associados.">
  <meta property="og:image" content="https://clubedocavalobonfim.com.br/assets/img/logo_CCBMG.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/custom.css?v=op-2025-09-25-assoc">
  <link rel="icon" type="image/png" href="assets/img/logo_CCBMG.png">
  <link rel="shortcut icon" href="assets/img/logo_CCBMG.png" type="image/png">
  <style>
    :root{ --brand:#111279; --accent:#2a9d8f; }
    .bg-primary{ background-color:var(--brand)!important; }
    .btn-primary{ background-color:var(--brand)!important; border-color:var(--brand)!important; }
    .btn-outline-primary{ color:var(--brand)!important; border-color:var(--brand)!important; }
    .text-primary{ color:var(--brand)!important; }
    .navbar .container{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .navbar-brand{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    header { background:#f8f9fa; border-bottom:1px solid #e9ecef; }
    header .container{ padding-top:1rem; padding-bottom:1rem; }
    @media (min-width:768px){ header .container{ padding-top:1.25rem; padding-bottom:1.25rem; } }
    .badge-role{ background:var(--accent); }
    .form-help{ font-size:.875rem; color:#6c757d; }
    .users-header, .user-row{ display:grid; grid-template-columns: 1fr 160px 160px; gap:12px; align-items:center; }
    .users-header{ font-weight:600; color:#495057; border-bottom:1px solid #e9ecef; padding-bottom:.5rem; }
    .user-row{ padding:.5rem 0; border-bottom:1px dashed #e9ecef; }
    .user-name{ background:none; border:0; padding:0; text-align:left; font-weight:600; color:#0d6efd; cursor:pointer; }
    .user-status .badge{ min-width:90px; }
    .user-details{ border-left:3px solid #e9ecef; margin-left:.25rem; padding-left:.75rem; }
    @media (max-width:767.98px){
      .users-header, .user-row{ grid-template-columns: 1fr 110px 110px; }
      .user-details{ margin-left:0; border-left:0; border-top:1px solid #e9ecef; padding:.75rem 0 0; }
    }
    main.container{ padding-top:1rem; padding-bottom:1.25rem; }
    .brand-logo{ height:36px; width:auto; margin-right:.5rem; object-fit:contain; filter:brightness(0) invert(1); }
    @media (min-width: 992px){ .brand-logo{ height:42px; } }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <img class="brand-logo" src="assets/img/logo_CCBMG.png?v=ccbmg-2025-09-25" alt="Logo Clube do Cavalo">
    <a class="navbar-brand fw-bold text-truncate" href="index.html">Clube do Cavalo - Bonfim MG</a>
    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Alternar navegação">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
        <li class="nav-item me-2"><a class="nav-link" href="pg_associado.html">Área do Associado</a></li>     
        <li class="nav-item me-2"><a class="nav-link" href="admin.html">Painel Admin</a></li>
        <li class="nav-item"><button id="btnLogout" class="btn btn-sm btn-outline-light">Sair</button></li>
      </ul>
    </div>
  </div>
</nav>

<header>
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
    <div>
      <h1 class="h4 h3-md mb-1">Administração — Associados</h1>
      <p class="text-secondary mb-0">Gerencie cadastro e financeiro dos associados.</p>
    </div>
    <div class="text-end">
      <div class="small">Logado como: <strong id="opName">—</strong></div>
      <span id="opRole" class="badge badge-role d-none text-uppercase">admin</span>
    </div>
  </div>
</header>

<!-- Subnav de seções do painel -->
<div class="subnav">
  <div class="container">
    <div class="d-flex flex-wrap gap-2 py-2">
      <a class="btn btn-sm btn-primary disabled" aria-disabled="true">Associados</a>
      <a class="btn btn-sm btn-outline-primary" href="admin_produtos.html">Produtos</a>
      <a class="btn btn-sm btn-outline-primary" href="admin_servicos.html">Serviços</a>
      <a class="btn btn-sm btn-outline-primary" href="admin_classificados.html">Classificados</a>
    </div>
  </div>
</div>

<main class="container">

  <!-- Cadastro novo -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="mb-0">Associados</h5>
        <button class="btn btn-primary btn-new-assoc" type="button" data-bs-toggle="collapse" data-bs-target="#newAssocCollapse" aria-expanded="false">
          Cadastrar novo associado
        </button>
      </div>

      <div id="newAssocCollapse" class="collapse mt-3">
        <form id="formNewAssoc" class="row g-3">
          <div class="col-sm-6 col-md-3">
            <label class="form-label">CPF (somente números)</label>
            <input type="text" class="form-control" id="naCPF" inputmode="numeric" required>
          </div>
          <div class="col-sm-6 col-md-3">
            <label class="form-label">Senha inicial</label>
            <input type="password" class="form-control" id="naPass" required>
            <div class="form-help">O associado poderá trocar depois.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nome completo</label>
            <input type="text" class="form-control" id="naNome" required>
          </div>
          <div class="col-sm-6 col-md-4">
            <label class="form-label">Telefone</label>
            <input type="text" class="form-control" id="naTel">
          </div>
          <div class="col-sm-6 col-md-8">
            <label class="form-label">Endereço</label>
            <input type="text" class="form-control" id="naEnd">
          </div>
          <div class="col-sm-6 col-md-3">
            <label class="form-label">Anuidade paga — Data</label>
            <input type="date" class="form-control" id="naLastPayment">
          </div>
          <div class="col-sm-6 col-md-3">
            <label class="form-label">Anuidade paga — Valor (R$)</label>
            <input type="number" step="0.01" class="form-control" id="naPaidAmount" placeholder="ex.: 120.00">
          </div>
          <div class="col-sm-6 col-md-3">
            <label class="form-label">Próxima data a pagar</label>
            <input type="date" class="form-control" id="naNextDue">
          </div>
          <div class="col-sm-6 col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" type="submit">Criar associado</button>
          </div>
        </form>
        <div id="naMsg" class="small mt-2"></div>
      </div>
    </div>
  </div>

  <!-- Busca + lista -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="toolbar-wrap">
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <input type="text" class="form-control" id="searchQuery" placeholder="Buscar por CPF ou Nome" style="max-width:300px">
          <button id="btnSearch" class="btn btn-outline-primary">Buscar</button>
          <button id="btnListAll" class="btn btn-outline-secondary">Listar todos (100)</button>
        </div>
      </div>

      <div class="users-header mt-3">
        <div>Nome</div>
        <div>Perfil</div>
        <div>Status</div>
      </div>

      <div id="usersWrap" class="mt-2">
        <div class="text-center text-secondary py-3">Use a busca ou liste todos.</div>
      </div>
    </div>
  </div>

</main>

<footer class="mt-4 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> — Administração de Associados.</div>
    <div class="text-secondary small text-center">
      © 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gestão de Associações Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { requireAuth, cpfToEmail, setFinanceSummary } from "./firebase.js";
  import { auth, db } from "./firebase.js";
  import {
    collection, getDocs, query, orderBy, where, limit,
    doc, getDoc, setDoc, updateDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signOut as signOutSec, signOut }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  requireAuth({ requiredRole: ["Admin","Master","admin","master"] });

  const opNameEl = document.getElementById("opName");
  const opRoleEl = document.getElementById("opRole");
  let currentRole = "";
  const normalizeRole = (r) => String(r || "").trim().toLowerCase();

  const secondaryApp = initializeApp(auth.app.options, "op-secondary");
  const secAuth = getAuth(secondaryApp);

  auth.onAuthStateChanged(async (user)=>{
    if(!user) return;
    const snap = await getDoc(doc(db,"users",user.uid));
    const d = snap.exists()? snap.data() : {};
    opNameEl.textContent = d.nome || "Operador(a)";
    const role = normalizeRole(d.role) || "admin";
    currentRole = role;
    opRoleEl.textContent = role;
    opRoleEl.classList.remove("d-none");

    try { if (document.getElementById("usersWrap")) listUsers(""); } catch(e){}
  });

  document.getElementById("btnLogout")?.addEventListener("click", async ()=>{
    try{ await signOut(auth); location.href="login.html"; }
    catch(e){ alert("Não foi possível sair: " + e.message); }
  });

  /* === Cadastro novo associado === */
  const formNewAssoc = document.getElementById("formNewAssoc");
  const naCPF = document.getElementById("naCPF");
  const naPass = document.getElementById("naPass");
  const naNome = document.getElementById("naNome");
  const naTel  = document.getElementById("naTel");
  const naEnd  = document.getElementById("naEnd");
  const naLastPayment = document.getElementById("naLastPayment");
  const naPaidAmount  = document.getElementById("naPaidAmount");
  const naNextDue     = document.getElementById("naNextDue");
  const naMsg  = document.getElementById("naMsg");

  formNewAssoc?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    naMsg.textContent = "Criando associado...";
    try{
      const email = cpfToEmail(naCPF.value);
      const cred = await createUserWithEmailAndPassword(secAuth, email, naPass.value);
      const uid = cred.user.uid;

      await setDoc(doc(db,"users",uid), {
        cpf: naCPF.value.trim(),
        nome: naNome.value.trim(),
        telefone: naTel.value.trim(),
        endereco: naEnd.value.trim(),
        role: "Associado",
        ativo: true,
        status: "Anuidade Pendente",
        createdAt: (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")).serverTimestamp()
      }, { merge: true });

      await setFinanceSummary(uid, {
        lastPayment: naLastPayment.value || undefined,
        lastAmount: naPaidAmount.value || undefined,
        nextDue: naNextDue.value || undefined
      });

      naMsg.textContent = `Associado criado! UID: ${uid}`;
      formNewAssoc.reset();
      await signOutSec(secAuth);
      listUsers("");
    }catch(err){
      naMsg.textContent = "Erro: " + err.message;
    }
  });

  /* === Lista / busca === */
  const usersWrap = document.getElementById("usersWrap");
  const searchQuery = document.getElementById("searchQuery");
  document.getElementById("btnSearch")?.addEventListener("click", ()=> listUsers(searchQuery.value.trim()));
  document.getElementById("btnListAll")?.addEventListener("click", ()=> listUsers(""));

  async function listUsers(term){
    if(!usersWrap) return;
    usersWrap.innerHTML = `<div class="text-center text-secondary py-3">Carregando...</div>`;

    const canSeeAll = (currentRole==="admin" || currentRole==="master");
    if(!canSeeAll){
      try{
        const user = auth.currentUser;
        if(!user){ usersWrap.innerHTML = `<div class="text-center text-danger py-3">Sessão inválida.</div>`; return; }
        const snap = await getDoc(doc(db,"users",user.uid));
        if(!snap.exists()){ usersWrap.innerHTML = `<div class="text-center text-secondary py-3">Seu perfil não foi encontrado.</div>`; return; }

        let last="—", next="—", lastAmount=0;
        try{
          const s = await getDoc(doc(db,"users", user.uid, "finance", "summary"));
          if(s.exists()){
            const sd = s.data();
            last = toDateStr(sd.lastPayment);
            next = toDateStr(sd.nextDue);
            lastAmount = sd.lastAmount ?? 0;
          }
        }catch{}
        usersWrap.innerHTML = renderUserRow({ uid:user.uid, ...snap.data(), last, next, lastAmount });
        attachUserHandlers();
        return;
      }catch{
        usersWrap.innerHTML = `<div class="text-center text-danger py-3">Falha ao carregar seu perfil.</div>`;
        return;
      }
    }

    let docs=[];
    try{
      if(!term){
        const snap = await getDocs(query(collection(db,"users"), orderBy("nome"), limit(100)));
        docs = snap.docs;
      }else if(/^\d{5,}$/.test(term)){
        const snap = await getDocs(query(collection(db,"users"), where("cpf","==", term)));
        docs = snap.docs;
      }else{
        const snap = await getDocs(query(collection(db,"users"), orderBy("nome"), limit(100)));
        const lower = term.toLowerCase();
        docs = snap.docs.filter(d => (d.data().nome||"").toLowerCase().includes(lower));
      }
    }catch(e){
      usersWrap.innerHTML = `<div class="text-center text-danger py-3">Falha ao consultar usuários.</div>`;
      return;
    }

    if(!docs.length){ usersWrap.innerHTML = `<div class="text-center text-secondary py-3">Nenhum associado encontrado.</div>`; return; }

    usersWrap.innerHTML = docs.map(d=>{
      const u = d.data(); const uid = d.id;
      return renderUserRow({ uid, ...u, last:"", next:"", lastAmount:0 });
    }).join("");
    attachUserHandlers();

    for(const d of docs){
      const uid = d.id;
      try{
        const s = await getDoc(doc(db,"users",uid,"finance","summary"));
        if(s.exists()){
          const sd = s.data();
          const el1 = document.querySelector(`#u-${uid} [data-uid="${uid}"][data-field="lastPayment"]`);
          if(el1) el1.value = toDateStr(sd.lastPayment);
          const el2 = document.querySelector(`#u-${uid} [data-uid="${uid}"][data-field="lastAmount"]`);
          if(el2) el2.value = sd.lastAmount ?? 0;
          const el3 = document.querySelector(`#u-${uid} [data-uid="${uid}"][data-field="nextDue"]`);
          if(el3) el3.value = toDateStr(sd.nextDue);
        }
      }catch{}
    }
  }

  function toDateStr(v){ try{ const d = v?.toDate ? v.toDate() : (v? new Date(v) : null); return d? d.toISOString().slice(0,10) : ""; } catch { return ""; } }

  function renderUserRow(u){
    const ativo = (u.ativo !== false);
    const role = (String(u.role||"associado")).toLowerCase();
    const status = u.status || (ativo ? "Ativo" : "Inativo");
    const uidSafe = String(u.uid).replace(/[^a-zA-Z0-9_-]/g,'');
    const collapseId = `u-${uidSafe}`;
    return `
      <div class="user-row">
        <button class="user-name" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">${u.nome||"Sem nome"}</button>
        <div class="text-uppercase small"><span class="badge badge-role">${role}</span></div>
        <div class="user-status"><span class="badge ${ativo?'bg-success':'bg-secondary'}">${status}</span></div>
      </div>
      <div id="${collapseId}" class="collapse">
        <div class="user-details">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control" data-uid="${u.uid}" data-field="nome" value="${u.nome||''}">
            </div>
            <div class="col-md-2">
              <label class="form-label">CPF</label>
              <input type="text" class="form-control" data-uid="${u.uid}" data-field="cpf" value="${u.cpf||''}">
            </div>
            <div class="col-md-2">
              <label class="form-label">Telefone</label>
              <input type="text" class="form-control" data-uid="${u.uid}" data-field="telefone" value="${u.telefone||''}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Endereço</label>
              <input type="text" class="form-control" data-uid="${u.uid}" data-field="endereco" value="${u.endereco||''}">
            </div>
            <div class="col-md-2">
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" data-uid="${u.uid}" data-field="ativo" ${ativo?'checked':''}>
                <label class="form-check-label">Ativo</label>
              </div>
            </div>
            <div class="col-sm-6 col-md-2">
              <label class="form-label">Último pagto (data)</label>
              <input type="date" class="form-control" data-uid="${u.uid}" data-field="lastPayment" value="">
            </div>
            <div class="col-sm-6 col-md-2">
              <label class="form-label">Último pagto (valor)</label>
              <input type="number" step="0.01" class="form-control" data-uid="${u.uid}" data-field="lastAmount" value="">
            </div>
            <div class="col-sm-6 col-md-2">
              <label class="form-label">Próximo pagto</label>
              <input type="date" class="form-control" data-uid="${u.uid}" data-field="nextDue" value="">
            </div>
            <div class="col-sm-6 col-md-2">
              <button class="btn btn-outline-primary w-100 btn-save-profile" data-uid="${u.uid}">Salvar Perfil</button>
            </div>
            <div class="col-sm-6 col-md-2">
              <button class="btn btn-primary w-100 btn-save-fin" data-uid="${u.uid}">Salvar Financeiro</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function attachUserHandlers(){
    document.querySelectorAll(".btn-save-profile").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const uid = e.currentTarget.dataset.uid;
        const q = (f)=> document.querySelector(`[data-uid="${uid}"][data-field="${f}"]`);
        const payload = {
          nome: q("nome").value.trim(),
          cpf: q("cpf").value.trim(),
          telefone: q("telefone").value.trim(),
          endereco: q("endereco").value.trim(),
          ativo: q("ativo").checked
        };
        try{ await updateDoc(doc(db,"users",uid), payload); e.currentTarget.textContent="Perfil salvo!"; setTimeout(()=>e.currentTarget.textContent="Salvar Perfil",1200); }
        catch(err){ alert("Erro ao salvar perfil: "+err.message); }
      });
    });
    document.querySelectorAll(".btn-save-fin").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const uid = e.currentTarget.dataset.uid;
        const q = (f)=> document.querySelector(`[data-uid="${uid}"][data-field="${f}"]`);
        try{
          await setFinanceSummary(uid, {
            lastPayment: q("lastPayment").value,
            lastAmount: q("lastAmount").value,
            nextDue: q("nextDue").value
          });
          e.currentTarget.textContent="Financeiro salvo!"; setTimeout(()=>e.currentTarget.textContent="Salvar Financeiro",1200);
        }catch(err){ alert("Erro ao salvar financeiro: "+err.message); }
      });
    });
  }
</script>
</body>
</html>
