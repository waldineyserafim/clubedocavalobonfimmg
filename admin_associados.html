<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Admin — Associados | Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Gestão de associados com financeiro e faturas.">
  <meta property="og:image" content="https://clubedocavalobonfim.com.br/assets/img/logo_CCBMG.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="icon" type="image/png" href="assets/img/logo_CCBMG.png">
  <link rel="shortcut icon" href="assets/img/logo_CCBMG.png" type="image/png">
  <style>
    :root{ --brand:#111279; --accent:#2a9d8f; }
    .bg-primary{ background-color:var(--brand)!important; }
    .btn-primary{ background-color:var(--brand)!important; border-color:var(--brand)!important; }
    .btn-outline-primary{ color:var(--brand)!important; border-color:var(--brand)!important; }
    .text-primary{ color:var(--brand)!important; }
    .navbar .container{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .navbar-brand{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    header { background:#f8f9fa; border-bottom:1px solid #e9ecef; }
    header .container{ padding-top:1rem; padding-bottom:1rem; }
    @media (min-width:768px){ header .container{ padding-top:1.25rem; padding-bottom:1.25rem; } }
    .badge-role{ background:var(--accent); }
    .users-header, .user-row{ display:grid; grid-template-columns: 34px 1fr 140px 180px 140px; gap:12px; align-items:center; }
    .users-header{ font-weight:600; color:#495057; border-bottom:1px solid #e9ecef; padding-bottom:.5rem; }
    .user-row{ padding:.5rem 0; border-bottom:1px dashed #e9ecef; }
    .user-name{ background:none; border:0; padding:0; text-align:left; font-weight:600; color:#0d6efd; cursor:pointer; }
    .user-status .badge{ min-width:96px; }
    @media (max-width:991.98px){
      .users-header, .user-row{ grid-template-columns: 34px 1fr 120px 160px 120px; }
    }
    @media (max-width:767.98px){
      .users-header{ display:none; }
      .user-row{ grid-template-columns: 34px 1fr 120px; }
      .user-row .col-role, .user-row .col-status, .user-row .col-next{ display:none; }
    }
    main.container{ padding-top:1rem; padding-bottom:1.25rem; }
    .brand-logo{ height:36px; width:auto; margin-right:.5rem; object-fit:contain; filter:brightness(0) invert(1); }
    @media (min-width: 992px){ .brand-logo{ height:42px; } }
    .small-muted{ font-size:.875rem; color:#6c757d; }
    .input-readonly[disabled]{ background-color:#f2f2f2; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <img class="brand-logo" src="assets/img/logo_CCBMG.png" alt="Logo Clube do Cavalo">
    <a class="navbar-brand fw-bold text-truncate" href="index.html">Clube do Cavalo - Bonfim MG</a>
    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
        <li class="nav-item me-2"><a class="nav-link" href="pg_associado.html">Área do Associado</a></li>
        <li class="nav-item me-2"><a class="nav-link" href="admin.html">Painel Admin</a></li>
        <li class="nav-item"><button id="btnLogout" class="btn btn-sm btn-outline-light">Sair</button></li>
      </ul>
    </div>
  </div>
</nav>

<header>
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
    <div>
      <h1 class="h4 h3-md mb-1">Administração — Associados</h1>
      <p class="text-secondary mb-0">Cadastro, financeiro e automações.</p>
    </div>
    <div class="text-end">
      <div class="small">Logado como: <strong id="opName">—</strong></div>
      <span id="opRole" class="badge badge-role d-none text-uppercase">admin</span>
    </div>
  </div>
</header>

<div class="subnav">
  <div class="container">
    <div class="d-flex flex-wrap gap-2 py-2">
      <a class="btn btn-sm btn-primary disabled" aria-disabled="true">Associados</a>
      <a class="btn btn-sm btn-outline-primary" href="admin_produtos.html">Produtos</a>
      <a class="btn btn-sm btn-outline-primary" href="admin_servicos.html">Serviços</a>
      <a class="btn btn-sm btn-outline-primary" href="admin_classificados.html">Classificados</a>
    </div>
  </div>
</div>

<main class="container">
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-12 col-lg-5 d-flex gap-2">
          <input type="search" id="searchQuery" class="form-control" placeholder="Buscar por nome ou CPF">
          <button id="btnSearch" class="btn btn-outline-primary">Buscar</button>
          <button id="btnListAll" class="btn btn-outline-secondary">Listar (100)</button>
        </div>
        <div class="col-12 col-lg-4 d-flex gap-2 justify-content-lg-center">
          <button class="btn btn-sm btn-outline-primary" data-filter="all">Todos</button>
          <button class="btn btn-sm btn-outline-primary" data-filter="em_dia">Em dia</button>
          <button class="btn btn-sm btn-outline-primary" data-filter="pendente">Pendente</button>
          <button class="btn btn-sm btn-outline-primary" data-filter="isento">Isento</button>
        </div>
        <div class="col-12 col-lg-3 d-flex gap-2 justify-content-lg-end">
          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">Ações em massa</button>
            <div class="dropdown-menu dropdown-menu-end p-2" style="min-width:280px">
              <button class="dropdown-item" id="actionGenInvoices">Gerar fatura (selecionados)</button>
              <button class="dropdown-item" id="actionSendReminders">Enviar lembrete (WhatsApp)</button>
              <button class="dropdown-item" id="actionExportCsv">Baixar CSV</button>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-3">

      <div class="users-header">
        <div><input type="checkbox" id="chkAll"></div>
        <div>Nome</div>
        <div class="col-role">Perfil</div>
        <div class="col-status d-flex align-items-center gap-2">
          Situação financeira
          <i class="bi bi-info-circle text-secondary"
             data-bs-toggle="popover"
             data-bs-title="Regras de status"
             data-bs-html="true"
             data-bs-content="
              <strong>Em dia</strong>: plano ativo (até o fim).<br>
              <strong>Atrasado</strong>: vencido há ≤ 10 dias.<br>
              <strong>Vencido</strong>: vencido há &gt; 10 dias.<br>
              <strong>Cancelado</strong>: sem acesso.<br>
              <strong>Na lista</strong>: exibimos <em>Pendente</em> quando está <em>Atrasado</em> ou <em>Vencido</em>.">
          </i>
        </div>
        <div class="col-next">Próxima cobrança</div>
      </div>
      <div id="usersWrap" class="mt-2">
        <div class="text-center text-secondary py-3">Use a busca ou liste todos.</div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="mb-0">Cadastrar novo associado</h5>
      </div>
      <div class="mt-3">
        <form id="formNewAssoc" class="row g-3">
          <div class="col-sm-6 col-md-3">
            <label class="form-label">CPF (somente números)</label>
            <input type="text" class="form-control" id="naCPF" inputmode="numeric" required>
          </div>
          <div class="col-sm-6 col-md-3">
            <label class="form-label">Senha inicial</label>
            <input type="password" class="form-control" id="naPass" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nome completo</label>
            <input type="text" class="form-control" id="naNome" required>
          </div>
          <div class="col-sm-6 col-md-4">
            <label class="form-label">Telefone</label>
            <input type="text" class="form-control" id="naTel">
          </div>
          <div class="col-sm-6 col-md-8">
            <label class="form-label">Endereço</label>
            <input type="text" class="form-control" id="naEnd">
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-primary" type="submit">Criar associado</button>
          </div>
        </form>
        <div id="naMsg" class="small mt-2"></div>
      </div>
    </div>
  </div>
</main>

<footer class="mt-5 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> — Promovendo a cultura equestre.</div>
    <div class="text-secondary small text-center">© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gestão de Clubes e Associações Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { requireAuth, cpfToEmail } from "./firebase.js";
  import { auth, db } from "./firebase.js";
  import {
    collection, getDocs, query, orderBy, where, limit, addDoc,
    doc, getDoc, setDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signOut as signOutSec, signOut }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const bootstrap = window.bootstrap;
  [...document.querySelectorAll('[data-bs-toggle="popover"]')].forEach(el => new bootstrap.Popover(el));

  requireAuth({ requiredRole: ["Admin","Master","admin","master"] });

  const opNameEl = document.getElementById("opName");
  const opRoleEl = document.getElementById("opRole");
  let currentRole = "";
  let operatorProfile = { uid:"", nome:"", cpf:"" };
  const normalizeRole = (r) => String(r || "").trim().toLowerCase();

  const secondaryApp = initializeApp(auth.app?.options || {}, "op-secondary");
  const secAuth = getAuth(secondaryApp);

  auth.onAuthStateChanged(async (user)=>{
    if(!user) return;
    const snap = await getDoc(doc(db,"users",user.uid));
    const d = snap.exists()? snap.data() : {};
    opNameEl.textContent = d.nome || "Operador(a)";
    const role = normalizeRole(d.role) || "admin";
    currentRole = role;
    opRoleEl.textContent = role.toUpperCase();
    opRoleEl.classList.remove("d-none");
    operatorProfile = { uid:user.uid, nome: d.nome || "", cpf: (d.cpf||"").replace(/\D/g,"") };
    try { if (document.getElementById("usersWrap")) listUsers(""); } catch(e){ console.error(e); }
  });

  document.getElementById("btnLogout")?.addEventListener("click", async ()=>{
    try{ await signOut(auth); location.href="login.html"; }
    catch(e){ alert("Não foi possível sair: " + e.message); }
  });

  const PLAN_MONTHS = { mensal:1, trimestral:3, semestral:6, anual:12 };
  const PLAN_LABEL  = { mensal:"Mensal", trimestral:"Trimestral", semestral:"Semestral", anual:"Anual", custom:"Personalizado" };

  const fmtBRL = (v)=> (v==null||v==="") ? "" : Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  const toDateStr = (v)=> { try{ const d = v?.toDate ? v.toDate() : (v? new Date(v) : null); return d? d.toISOString().slice(0,10) : ""; } catch { return ""; } };
  const fromDateStr = (s)=> s ? new Date(s+"T00:00:00") : null;
  const addDays = (date, n)=> { const d = new Date(date); d.setDate(d.getDate()+n); return d; };
  const addMonthsSafe = (date, months)=> {
    if(!date) return null;
    const d = new Date(date);
    const day = d.getDate();
    d.setMonth(d.getMonth()+months);
    if (d.getDate() < day) d.setDate(0);
    return d;
  };
  const now = ()=> new Date();
  const payPageUrl = ()=> `${location.origin}/pay.html`;
  const fmtBRDate = (date)=> new Intl.DateTimeFormat('pt-BR',{dateStyle:'long'}).format(date);

  function computeMembership({ invoices = [], summary = {} }) {
    if (summary.exempt === true) {
      const untilMs = summary.exemptUntil?.toMillis?.() ?? (summary.exemptUntil ? new Date(summary.exemptUntil).getTime() : null);
      if (!untilMs || untilMs > Date.now()) {
        return { listCode: "isento", listBadge: "Isento", detail: "isento", nextDue: null };
      }
    }

    const unpaid = invoices.filter(i => {
      const s = String(i.status || "").toLowerCase();
      return !["pago", "paga", "paid"].includes(s);
    });

    let earliestDue = null;
    for (const inv of unpaid) {
      const dueMs = inv.dueDate?.toMillis?.() ?? (inv.dueDate ? new Date(inv.dueDate).getTime() : null);
      if (dueMs && (earliestDue === null || dueMs < earliestDue)) earliestDue = dueMs;
    }

    if (earliestDue && earliestDue < Date.now()) {
      const daysOver = Math.floor((Date.now() - earliestDue) / (24 * 3600 * 1000));
      const detail = daysOver <= 10 ? "atrasado" : "vencido";
      return { listCode: "pendente", listBadge: "Pendente", detail, nextDue: earliestDue };
    }

    const paid = invoices.filter(i => ["pago", "paid"].includes(String(i.status || "").toLowerCase()));
    let lastPaidEnd = null;
    if (paid.length) {
      paid.sort((a, b) => {
        const ap = a.planEnd?.toMillis?.() ?? new Date(a.planEnd || 0).getTime();
        const bp = b.planEnd?.toMillis?.() ?? new Date(b.planEnd || 0).getTime();
        return bp - ap;
      });
      lastPaidEnd = paid[0].planEnd?.toDate?.() ?? new Date(paid[0].planEnd);
    }

    let detail = "vencido";
    if (lastPaidEnd) {
      const graceEnd = addDays(lastPaidEnd, 10);
      if (now() <= lastPaidEnd) detail = "em_dia";
      else if (now() <= graceEnd) detail = "atrasado";
      else detail = "vencido";
    }

    const listCode = (detail === "atrasado" || detail === "vencido") ? "pendente" : "em_dia";
    const listBadge = listCode === "pendente" ? "Pendente" : "Em dia";
    return { listCode, listBadge, detail, nextDue: earliestDue || null };
  }

  function displayPlan(inv){
    if (inv.planName) return inv.planName;
    return inv.planType ? (PLAN_LABEL[inv.planType] || inv.planType) : "-";
  }

  function wppUrl(phoneRaw, text){
    const p = (phoneRaw||"").replace(/\D/g,"");
    const msg = encodeURIComponent(text||"");
    return p ? `https://wa.me/${p}?text=${msg}` : `https://wa.me/?text=${msg}`;
  }

  /* ===== Novo associado ===== */
  const formNewAssoc = document.getElementById("formNewAssoc");
  const naCPF = document.getElementById("naCPF");
  const naPass = document.getElementById("naPass");
  const naNome = document.getElementById("naNome");
  const naTel  = document.getElementById("naTel");
  const naEnd  = document.getElementById("naEnd");
  const naMsg  = document.getElementById("naMsg");

  formNewAssoc?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    naMsg.textContent = "Criando associado...";
    try{
      const email = cpfToEmail(naCPF.value);
      const cred = await createUserWithEmailAndPassword(secAuth, email, naPass.value);
      const uid = cred.user.uid;

      await setDoc(doc(db,"users",uid), {
        cpf: naCPF.value.trim().replace(/\D/g,""),
        nome: naNome.value.trim(),
        telefone: naTel.value.trim(),
        endereco: naEnd.value.trim(),
        role: "Associado",
        ativo: true,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge: true });

      await setDoc(doc(db,"users",uid,"finance","summary"), {
        lastPayment: null, lastAmount: null, nextDue: null, activeUntil: null,
        exempt: false, exemptUntil: null, updatedAt: serverTimestamp()
      }, { merge:true });

      naMsg.textContent = `Associado criado! UID: ${uid}`;
      formNewAssoc.reset();
      await signOutSec(secAuth);
      listUsers("");
    }catch(err){
      console.error(err);
      naMsg.textContent = "Erro: " + err.message;
    }
  });

  /* ===== Lista / filtros ===== */
  const usersWrap = document.getElementById("usersWrap");
  const searchQuery = document.getElementById("searchQuery");
  document.getElementById("btnSearch")?.addEventListener("click", ()=> listUsers(searchQuery.value.trim()));
  document.getElementById("btnListAll")?.addEventListener("click", ()=> { searchQuery.value=""; listUsers(""); });

  let currentFilter = "all";
  document.querySelectorAll("[data-filter]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      currentFilter = btn.getAttribute("data-filter");
      document.querySelectorAll("[data-filter]").forEach(b=> b.classList.remove("active"));
      btn.classList.add("active");
      listUsers(searchQuery.value.trim());
    });
  });
  document.getElementById("chkAll")?.addEventListener("change", (e)=>{
    document.querySelectorAll(".row-check").forEach(c=> c.checked = e.target.checked);
  });

  async function listUsers(term){
    if(!usersWrap) return;
    usersWrap.innerHTML = `<div class="text-center text-secondary py-3">Carregando...</div>`;
    let docs=[];
    try{
      if(!term){
        const snap = await getDocs(query(collection(db,"users"), orderBy("nome"), limit(100)));
        docs = snap.docs;
      }else if(/^\d{5,}$/.test(term.replace(/\D/g,""))){
        const snap = await getDocs(query(collection(db,"users"), where("cpf","==", term.replace(/\D/g,""))));
        docs = snap.docs;
      }else{
        const snap = await getDocs(query(collection(db,"users"), orderBy("nome"), limit(100)));
        const lower = term.toLowerCase();
        docs = snap.docs.filter(d => (d.data().nome||"").toLowerCase().includes(lower));
      }
    }catch(e){
      console.error("Falha ao consultar usuários", e);
      usersWrap.innerHTML = `<div class="text-center text-danger py-3">Falha ao consultar usuários.</div>`;
      return;
    }

    if(!docs.length){
      usersWrap.innerHTML = `<div class="text-center text-secondary py-3">Nenhum associado encontrado.</div>`;
      return;
    }

    usersWrap.innerHTML = docs.map(d=>{
      const u = d.data(); const uid = d.id;
      return renderUserRow({ uid, ...u });
    }).join("");
    attachUserRowHandlers();

    for (const d of docs){ await loadFinanceForRow(d.id); }
  }

  function renderUserRow(u){
    const uid = u.uid;
    return `
      <div class="user-row" id="row-${uid}">
        <div><input type="checkbox" class="row-check" data-uid="${uid}"></div>
        <button class="user-name" type="button" data-uid="${uid}">${u.nome||"Sem nome"}</button>
        <div class="text-uppercase small col-role"><span class="badge badge-role">${(String(u.role||"associado")).toUpperCase()}</span></div>
        <div class="user-status col-status"><span class="badge bg-secondary">Carregando...</span></div>
        <div class="next-due text-secondary small col-next">—</div>
      </div>
    `;
  }

  async function autoPatchInvoices(uid){
    try{
      const invSnap = await getDocs(query(collection(db,"users",uid,"financeInvoices"), orderBy("dueDate","asc")));
      for (const d of invSnap.docs){
        const inv = d.data();
        const status = String(inv.status||"").toLowerCase();
        const dueMs = inv.dueDate?.toMillis?.() ?? (inv.dueDate ? new Date(inv.dueDate).getTime() : null);
        if (status==="em_aberto" && dueMs!=null && dueMs < Date.now()){
          await updateDoc(doc(db,"users",uid,"financeInvoices",d.id), { status:"atrasado", updatedAt: serverTimestamp() });
        }
      }
    }catch(e){ console.warn("autoPatchInvoices", uid, e); }
  }

  async function loadFinanceForRow(uid){
    const row = document.getElementById(`row-${uid}`);
    if (!row) return;

    await autoPatchInvoices(uid);

    try{
      const sumSnap = await getDoc(doc(db,"users",uid,"finance","summary"));
      const summary = sumSnap.exists()? sumSnap.data() : {};

      let invDocs = [];
      try{
        const invSnap = await getDocs(query(collection(db,"users",uid,"financeInvoices"), orderBy("dueDate","asc")));
        invDocs = invSnap.docs.map(x=>({ id:x.id, ...x.data() }));
      }catch(errInv){
        console.warn("Falha ao ler financeInvoices de", uid, errInv);
      }

      const m = computeMembership({ invoices: invDocs, summary });
      const nextDueStr = m.nextDue ? new Intl.DateTimeFormat('pt-BR',{dateStyle:'medium'}).format(new Date(m.nextDue)) : "—";

      if (currentFilter !== "all" && m.listCode !== currentFilter){
        row.classList.add("d-none");
      } else {
        row.classList.remove("d-none");
      }

      const stEl = row.querySelector(".user-status .badge");
      if (stEl){
        stEl.className = "badge " + (m.listCode==="em_dia" ? "bg-success"
                          : m.listCode==="pendente" ? "bg-warning text-dark"
                          : m.listCode==="isento" ? "text-bg-secondary" : "text-bg-secondary");
        stEl.textContent = m.listBadge;
      }
      const nd = row.querySelector(".next-due");
      if (nd) nd.textContent = nextDueStr;
    }catch(e){
      console.error("Falha ao carregar financeiro de", uid, e);
      const stEl = document.querySelector(`#row-${uid} .user-status .badge`);
      if (stEl){ stEl.className = "badge text-bg-secondary"; stEl.textContent = "—"; }
    }
  }

  function attachUserRowHandlers(){
    document.querySelectorAll(".user-name").forEach(btn=>{
      btn.addEventListener("click", ()=> openUserModal(btn.getAttribute("data-uid")));
    });
  }

  /* ===== Modal do Usuário (Perfil + Financeiro) ===== */
  let userModalDiv = null;
  async function openUserModal(uid){
    let u = {}, summary = {}, invDocs = [];
    try{
      const [uSnap, sSnap, invSnap] = await Promise.all([
        getDoc(doc(db,"users",uid)),
        getDoc(doc(db,"users",uid,"finance","summary")),
        getDocs(query(collection(db,"users",uid,"financeInvoices"), orderBy("dueDate","asc")))
      ]);
      u = uSnap.exists()? { uid, ...uSnap.data() } : { uid };
      summary = sSnap.exists()? sSnap.data() : {};
      invDocs = invSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    }catch(e){ console.warn("openUserModal fetch", e); }

    if (userModalDiv) userModalDiv.remove();
    userModalDiv = document.createElement("div");
    userModalDiv.className = "modal fade";
    userModalDiv.tabIndex = -1;

    const m = computeMembership({ invoices: invDocs, summary });
    const nextDueStr = m.nextDue ? new Intl.DateTimeFormat('pt-BR',{dateStyle:'medium'}).format(new Date(m.nextDue)) : "—";

    const perfilHtml = renderProfileFormModal(u, summary);
    const financeiroHtml = renderFinanceBlock(uid, summary, invDocs, nextDueStr, m);

    userModalDiv.innerHTML = `
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h5 class="modal-title">${u.nome || "Associado"}</h5>
              <div class="small text-secondary">CPF: ${(u.cpf||"").replace(/\D/g,"") || "—"}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs" id="userTabs">
              <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabProfile">Perfil</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFinance">Financeiro</button></li>
            </ul>
            <div class="tab-content pt-3">
              <div class="tab-pane fade show active" id="tabProfile">${perfilHtml}</div>
              <div class="tab-pane fade" id="tabFinance">${financeiroHtml}</div>
            </div>
          </div>
          <div class="modal-footer">
            <span class="me-auto small text-secondary">Situação: <strong>${m.listBadge}</strong> • Próxima cobrança: <strong>${nextDueStr}</strong></span>
            <button class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(userModalDiv);
    const modal = new bootstrap.Modal(userModalDiv); modal.show();

    userModalDiv.querySelector(".btn-save-profile")?.addEventListener("click", async (e)=>{
      const q = (sel)=> userModalDiv.querySelector(sel);
      const payload = {
        nome: q('#pfNome').value.trim(),
        cpf: q('#pfCPF').value.trim().replace(/\D/g,""),
        telefone: q('#pfTelefone').value.trim(),
        endereco: q('#pfEndereco').value.trim(),
        email: q('#pfEmail').value.trim() || null,
        ativo: q('#pfAtivo').checked,
        updatedAt: serverTimestamp()
      };
      try{
        await updateDoc(doc(db,"users",uid), payload);
        e.currentTarget.textContent = "Perfil salvo!";
        setTimeout(()=> e.currentTarget.textContent = "Salvar Perfil", 1200);
      }catch(err){ alert("Erro ao salvar perfil: "+err.message); }
    });

    userModalDiv.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("button[data-action],a[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      if (action==="new-payment"){ openPaymentModal({ uid }); }
      if (action==="send-link"){ openSendLinkModal(uid); }
      if (action==="set-exempt"){ openExemptModal(uid).then(async()=> { await reloadFinanceInsideModal(uid); }); }
      if (action==="view-all"){ openAllInvoicesModal(uid); }
      if (action==="edit-invoice"){
        const invoiceId = btn.getAttribute("data-invid");
        openPaymentModal({ uid, invoiceId });
      }
    });

    async function reloadFinanceInsideModal(uidReload){
      try{
        const [sSnap, invSnap] = await Promise.all([
          getDoc(doc(db,"users",uidReload,"finance","summary")),
          getDocs(query(collection(db,"users",uidReload,"financeInvoices"), orderBy("dueDate","asc")))
        ]);
        const summary2 = sSnap.exists()? sSnap.data() : {};
        const invDocs2 = invSnap.docs.map(d=>({ id:d.id, ...d.data() }));
        const m2 = computeMembership({ invoices: invDocs2, summary: summary2 });
        const nextDueStr2 = m2.nextDue ? new Intl.DateTimeFormat('pt-BR',{dateStyle:'medium'}).format(new Date(m2.nextDue)) : "—";
        userModalDiv.querySelector("#tabFinance").innerHTML = renderFinanceBlock(uidReload, summary2, invDocs2, nextDueStr2, m2);
      }catch(e){ console.warn("reloadFinanceInsideModal", e); }
    }
  }

  function renderProfileFormModal(u, summary = {}) {
    const ativo = (u.ativo !== false);
    const isExempt = summary.exempt === true;
    const untilStr = summary.exemptUntil
        ? (summary.exemptUntil.toDate?.() ?? new Date(summary.exemptUntil))
        : null;

    return `
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Nome</label>
          <input type="text" id="pfNome" class="form-control" value="${u.nome||''}">
        </div>
        <div class="col-md-2">
          <label class="form-label">CPF</label>
          <input type="text" id="pfCPF" class="form-control" value="${u.cpf||''}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Telefone</label>
          <input type="text" id="pfTelefone" class="form-control" value="${u.telefone||''}">
        </div>
        <div class="col-md-3">
          <label class="form-label">E-mail (opcional)</label>
          <input type="email" id="pfEmail" class="form-control" value="${u.email||''}" placeholder="ex.: pessoa@email.com">
        </div>
        <div class="col-md-9">
          <label class="form-label">Endereço</label>
          <input type="text" id="pfEndereco" class="form-control" value="${u.endereco||''}">
        </div>
        <div class="col-md-3">
          <div class="form-check mt-4">
            <input class="form-check-input" id="pfAtivo" type="checkbox" ${ativo?'checked':''}>
            <label class="form-check-label">Ativo</label>
          </div>
        </div>

        <div class="col-12">
          <div class="d-flex flex-wrap gap-2 align-items-center p-2 border rounded">
            <span class="badge ${isExempt ? 'text-bg-secondary' : 'text-bg-light border'}">
              ${isExempt ? 'ISENTO' : 'NÃO ISENTO'}
            </span>
            ${isExempt && untilStr ? `<span class="small text-secondary">até <strong>${new Intl.DateTimeFormat('pt-BR',{dateStyle:'long'}).format(untilStr)}</strong></span>` : ''}
            <button class="btn btn-outline-secondary ms-auto" data-action="set-exempt">
              ${isExempt ? 'Editar/Remover isenção' : 'Marcar como isento'}
            </button>
          </div>
        </div>

        <div class="col-12 text-end">
          <button class="btn btn-outline-primary btn-save-profile">Salvar Perfil</button>
        </div>
      </div>
    `;
  }

  function renderFinanceBlock(uid, summary, invDocs, nextDueStr, membership){
    const last3 = [...invDocs].sort((a,b)=>{
      const ad = a.dueDate?.toMillis?.() ?? new Date(a.dueDate||0).getTime();
      const bd = b.dueDate?.toMillis?.() ?? new Date(b.dueDate||0).getTime();
      return bd - ad;
    }).slice(0,3);

    const rows = last3.map(inv=>{
      const s = String(inv.status||"").toLowerCase();
      const badge = s==="pago" ? "bg-success" : s==="atrasado" ? "bg-danger" : s==="cancelado" ? "bg-secondary" : "bg-warning text-dark";
      return `
        <tr>
          <td>${displayPlan(inv)}</td>
          <td>${fmtBRL(inv.amount)}</td>
          <td>${toDateStr(inv.planStart)||"—"}</td>
          <td>${toDateStr(inv.planEnd)||"—"}</td>
          <td>${toDateStr(inv.dueDate)||"—"}</td>
          <td><span class="badge ${badge}">${inv.status||"-"}</span></td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary" data-action="edit-invoice" data-uid="${uid}" data-invid="${inv.id}">Editar</button>
          </td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="7" class="text-center text-secondary">Sem faturas visíveis.</td></tr>`;

    const overdueAlert = (membership.detail==="atrasado")
      ? `<div class="alert alert-warning d-flex justify-content-between align-items-center">
           <div>Este associado está <strong>Atrasado</strong> (até 10 dias do vencimento).</div>
           <button class="btn btn-sm btn-danger" data-action="send-link" data-uid="${uid}">Notificar via WhatsApp</button>
         </div>`
      : (membership.detail==="vencido")
        ? `<div class="alert alert-danger d-flex justify-content-between align-items-center">
             <div>Este associado está <strong>Vencido</strong> (mais de 10 dias do vencimento).</div>
             <button class="btn btn-sm btn-danger" data-action="send-link" data-uid="${uid}">Enviar cobrança (WhatsApp)</button>
           </div>`
        : "";

    return `
      ${overdueAlert}
      <div class="d-flex flex-wrap gap-2 mb-2">
        <button class="btn btn-primary" data-action="new-payment" data-uid="${uid}">Registrar pagamento</button>
        <button class="btn btn-outline-primary" data-action="send-link" data-uid="${uid}">Enviar link</button>
        <button class="btn btn-outline-secondary" data-action="set-exempt" data-uid="${uid}">
          ${summary.exempt===true ? "Editar/Remover isenção" : "Marcar como isento"}
        </button>
        <button class="btn btn-light" data-action="view-all" data-uid="${uid}">Ver todas</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr>
            <th>Plano</th><th>Valor</th><th>Início</th><th>Fim</th><th>Vencimento</th><th>Status</th><th class="text-end">Ações</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>

      <div class="small-muted">Próxima cobrança: <strong>${nextDueStr||"—"}</strong> (igual ao vencimento).</div>
    `;
  }

  /* ===== Modal: Pagamento/Fatura ===== */
  let paymentModalDiv = null;
  function openPaymentModal({ uid, invoiceId=null }){
    if (paymentModalDiv) paymentModalDiv.remove();
    paymentModalDiv = document.createElement("div");
    paymentModalDiv.className = "modal fade"; paymentModalDiv.tabIndex = -1;

    const isEdit = !!invoiceId;
    paymentModalDiv.innerHTML = `
      <div class="modal-dialog modal-lg">
        <form class="modal-content" id="paymentForm">
          <div class="modal-header">
            <h5 class="modal-title">${isEdit ? "Editar fatura / pagamento" : "Registrar pagamento"}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div id="payMsg" class="d-none"></div>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Plano</label>
                  <select class="form-select" id="pfPlan">
                    <option value="">— selecione —</option>
                    <option value="mensal">Mensal</option>
                    <option value="trimestral">Trimestral</option>
                    <option value="semestral">Semestral</option>
                    <option value="anual">Anual</option>
                    <option value="custom">Personalizado</option>
                  </select>
                <div class="form-text">Ao selecionar, "Fim" e "Vencimento" são calculados.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Valor (R$)</label>
                <input type="number" step="0.01" class="form-control" id="pfAmount" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Status</label>
                <select class="form-select" id="pfStatus">
                  <option value="pago">pago</option>
                  <option value="em_aberto">em_aberto</option>
                  <option value="atrasado">atrasado</option>
                  <option value="cancelado">cancelado</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Início do plano</label>
                <input type="date" class="form-control" id="pfStart">
              </div>
              <div class="col-md-4">
                <label class="form-label">Fim do plano</label>
                <input type="date" class="form-control" id="pfEnd">
              </div>
              <div class="col-md-4">
                <label class="form-label">Vencimento (igual ao Fim)</label>
                <input type="date" class="form-control input-readonly" id="pfDue" disabled>
              </div>

              <div class="col-md-4">
                <label class="form-label">Data do pagamento</label>
                <input type="date" class="form-control" id="pfPaidAt">
              </div>
              <div class="col-md-4">
                <label class="form-label">Método</label>
                <input type="text" class="form-control" id="pfMethod" placeholder="PIX, MP, Dinheiro, Cartão">
              </div>
              <div class="col-md-4">
                <label class="form-label">GatewayId / Ref</label>
                <input type="text" class="form-control" id="pfGateway">
              </div>

              <div class="col-md-8">
                <label class="form-label">Link de pagamento (opcional)</label>
                <input type="url" class="form-control" id="pfPaymentUrl" placeholder="https://...">
              </div>
              <div class="col-md-4">
                <label class="form-label">Telefone/WhatsApp do associado</label>
                <input type="text" class="form-control" id="pfPhone" placeholder="DDD+Número">
              </div>

              <div class="col-12">
                <label class="form-label">Observação</label>
                <textarea class="form-control" id="pfNotes" rows="2" placeholder="Qualquer detalhe adicional"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            ${isEdit ? `<button type="button" class="btn btn-danger me-auto" id="pfDelete">Excluir fatura</button>` : ``}
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">${isEdit? "Salvar alterações" : "Salvar pagamento"}</button>
          </div>
        </form>
      </div>
    `;
    document.body.appendChild(paymentModalDiv);
    const modal = new bootstrap.Modal(paymentModalDiv); modal.show();

    const payMsg = paymentModalDiv.querySelector("#payMsg");
    const input = (id)=> paymentModalDiv.querySelector(id);
    const showMsg = (t,k="info")=>{ payMsg.textContent=t; payMsg.className=`alert alert-${k}`; payMsg.classList.remove("d-none"); };

    const syncDueFromEnd = ()=> { input("#pfDue").value = input("#pfEnd").value || ""; };
    const recalcEndByType = ()=>{
      const t = input("#pfPlan").value;
      if (!t || t==="custom") return;
      const months = PLAN_MONTHS[t];
      let startStr = input("#pfStart").value;
      if (!startStr){
        const today = new Date(); startStr = today.toISOString().slice(0,10);
        input("#pfStart").value = startStr;
      }
      const end = addMonthsSafe(fromDateStr(startStr), months);
      input("#pfEnd").value = end ? end.toISOString().slice(0,10) : "";
      syncDueFromEnd();
    };
    input("#pfPlan").addEventListener("change", ()=>{
      const t = input("#pfPlan").value;
      input("#pfEnd").toggleAttribute("disabled", t && t!=="custom");
      input("#pfEnd").classList.toggle("input-readonly", t && t!=="custom");
      if (t && t!=="custom") recalcEndByType();
    });
    input("#pfStart").addEventListener("change", ()=> recalcEndByType());
    input("#pfEnd").addEventListener("change", ()=> syncDueFromEnd());

    (async ()=>{
      if (!invoiceId) {
        input("#pfEnd").setAttribute("disabled","disabled");
        input("#pfEnd").classList.add("input-readonly");
        return;
      }
      try{
        const invSnap = await getDoc(doc(db,"users",uid,"financeInvoices",invoiceId));
        if (!invSnap.exists()) return;
        const inv = invSnap.data();
        input("#pfPlan").value  = inv.planType || "custom";
        input("#pfAmount").value = inv.amount ?? "";
        input("#pfStatus").value = inv.status || "em_aberto";
        input("#pfPaidAt").value = toDateStr(inv.paidAt);
        input("#pfStart").value = toDateStr(inv.planStart);
        input("#pfEnd").value = toDateStr(inv.planEnd);
        input("#pfDue").value = toDateStr(inv.dueDate);
        input("#pfMethod").value = inv.method||"";
        input("#pfGateway").value = inv.gatewayId||"";
        input("#pfNotes").value = inv.notes||"";
        input("#pfPaymentUrl").value = inv.paymentUrl||"";
        input("#pfPhone").value = inv.customerPhone||"";
        input("#pfEnd").toggleAttribute("disabled", inv.planType && inv.planType!=="custom");
        input("#pfEnd").classList.toggle("input-readonly", inv.planType && inv.planType!=="custom");
      }catch(e){ console.error(e); showMsg("Falha ao carregar a fatura: "+e.message, "danger"); }
    })();

    paymentModalDiv.querySelector("#pfDelete")?.addEventListener("click", async ()=>{
      if(!confirm("Excluir esta fatura (marcar como cancelada)?")) return;
      try{
        await updateDoc(doc(db,"users",uid,"financeInvoices",invoiceId), { status:"cancelado", updatedAt: serverTimestamp() });
        showMsg("Fatura marcada como cancelada.", "success");
        setTimeout(()=>{ modal.hide(); }, 600);
      }catch(e){ showMsg("Erro ao excluir (cancelar) fatura: "+e.message, "danger"); }
    });

    paymentModalDiv.querySelector("#paymentForm").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      try{
        if (input("#pfEnd").value) input("#pfDue").value = input("#pfEnd").value;

        const planSel  = input("#pfPlan");
        const planName = planSel.options[planSel.selectedIndex]?.text?.trim() || null;

        const payload = {
          planType: input("#pfPlan").value || null,
          amount: input("#pfAmount").value ? Number(input("#pfAmount").value) : null,
          planName,
          status: input("#pfStatus").value,
          paidAt: input("#pfPaidAt").value ? fromDateStr(input("#pfPaidAt").value) : null,
          planStart: input("#pfStart").value ? fromDateStr(input("#pfStart").value) : null,
          planEnd: input("#pfEnd").value ? fromDateStr(input("#pfEnd").value) : null,
          dueDate: input("#pfDue").value ? fromDateStr(input("#pfDue").value) : null,
          method: input("#pfMethod").value.trim() || null,
          gatewayId: input("#pfGateway").value.trim() || null,
          notes: input("#pfNotes").value.trim() || null,
          paymentUrl: input("#pfPaymentUrl").value.trim() || null,
          customerPhone: input("#pfPhone").value.trim() || null,
          recordedByUid: operatorProfile.uid || null,
          recordedByName: operatorProfile.nome || null,
          recordedByCPF: operatorProfile.cpf || null,
          recordedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        let invRef;
        if (invoiceId){
          invRef = doc(db,"users",uid,"financeInvoices",invoiceId);
          await setDoc(invRef, payload, { merge:true });
        } else {
          invRef = await addDoc(collection(db,"users",uid,"financeInvoices"), payload);
          invoiceId = invRef.id;
        }

        await refreshSummaryFromInvoices(uid);
        showMsg("Dados financeiros salvos com sucesso.", "success");
        setTimeout(()=>{ modal.hide(); }, 600);
      }catch(e){
        console.error(e);
        showMsg("Erro ao salvar: "+e.message, "danger");
      }
    });
  }

  /* ===== Modal: Isenção ===== */
  let exemptDiv = null;
  async function openExemptModal(uid){
    if (exemptDiv) exemptDiv.remove();
    exemptDiv = document.createElement("div");
    exemptDiv.className = "modal fade"; exemptDiv.tabIndex = -1;

    let summary = {};
    try{
      const s = await getDoc(doc(db,"users",uid,"finance","summary"));
      summary = s.exists()? s.data() : {};
    }catch{}

    const currentExempt = summary.exempt===true;
    const currentUntil = summary.exemptUntil ? (summary.exemptUntil.toDate?.() ?? new Date(summary.exemptUntil)) : null;

    exemptDiv.innerHTML = `
      <div class="modal-dialog">
        <form class="modal-content" id="exForm">
          <div class="modal-header">
            <h5 class="modal-title">${currentExempt? "Editar/Remover isenção" : "Marcar como isento"}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            ${currentExempt ? `<div class="alert alert-info">Isento até: <strong>${currentUntil ? fmtBRDate(currentUntil) : "(sem data definida)"}</strong></div>` : ""}
            <div class="row g-3">
              <div class="col-sm-6">
                <label class="form-label">Duração</label>
                <select id="exMonths" class="form-select">
                  <option value="1">1 mês</option>
                  <option value="3">3 meses</option>
                  <option value="6">6 meses</option>
                  <option value="12" selected>12 meses</option>
                  <option value="custom">Personalizado…</option>
                </select>
              </div>
              <div class="col-sm-6 d-none" id="exCustomWrap">
                <label class="form-label">Meses (personalizado)</label>
                <input type="number" min="1" step="1" id="exCustom" class="form-control" placeholder="ex.: 18">
              </div>
              <div class="col-12"><div class="form-text">Conta a partir de hoje.</div></div>
            </div>
          </div>
          <div class="modal-footer">
            ${currentExempt ? `<button type="button" class="btn btn-danger me-auto" id="exRemove">Remover isenção</button>` : ``}
            <button class="btn btn-light" data-bs-dismiss="modal" type="button">Cancelar</button>
            <button class="btn btn-primary" type="submit">${currentExempt? "Atualizar" : "Aplicar"}</button>
          </div>
        </form>
      </div>
    `;
    document.body.appendChild(exemptDiv);
    const modal = new bootstrap.Modal(exemptDiv); modal.show();

    const sel = exemptDiv.querySelector("#exMonths");
    const customWrap = exemptDiv.querySelector("#exCustomWrap");
    const custom = exemptDiv.querySelector("#exCustom");
    sel.addEventListener("change", ()=> customWrap.classList.toggle("d-none", sel.value!=="custom"));

    exemptDiv.querySelector("#exRemove")?.addEventListener("click", async ()=>{
      if(!confirm("Remover isenção deste associado?")) return;
      try{
        await setDoc(doc(db,"users",uid,"finance","summary"), { exempt:false, exemptUntil:null, updatedAt: serverTimestamp() }, { merge:true });
        modal.hide();
      }catch(e){ alert("Falha ao remover isenção: "+e.message); }
    });

    exemptDiv.querySelector("#exForm").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      try{
        const months = sel.value==="custom" ? Math.max(1, Number(custom.value||"1")) : Number(sel.value);
        const until = addMonthsSafe(now(), months);
        await setDoc(doc(db,"users",uid,"finance","summary"), { exempt:true, exemptUntil: until, updatedAt: serverTimestamp() }, { merge:true });
        modal.hide();
      }catch(e){ alert("Falha ao aplicar isenção: "+e.message); }
    });
  }

  /* ===== Modal: WhatsApp ===== */
  let sendLinkDiv = null;
  async function openSendLinkModal(uid){
    if (sendLinkDiv) sendLinkDiv.remove();
    sendLinkDiv = document.createElement("div");
    sendLinkDiv.className = "modal fade"; sendLinkDiv.tabIndex = -1;

    let phone = "", due = "";
    try{
      const [uSnap, sSnap] = await Promise.all([
        getDoc(doc(db,"users",uid)),
        getDoc(doc(db,"users",uid,"finance","summary"))
      ]);
      phone = uSnap.exists() ? (uSnap.data().telefone || "") : "";
      const sd = sSnap.exists()? sSnap.data() : {};
      due = toDateStr(sd.nextDue);
    }catch(e){ console.warn("sendLink query", e); }

    const dueText = due ? fmtBRDate(new Date(due+"T00:00:00")) : "(data de vencimento)";
    const msg = `Olá! Aqui é do Clube do Cavalo. Sua associação vencerá dia ${dueText}. Segue o link para o pagamento: ${payPageUrl()}.
Qualquer dúvida, estamos à disposição.`;

    sendLinkDiv.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Enviar link de pagamento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">Telefone/WhatsApp</label>
              <input type="text" class="form-control" id="slPhone" value="${phone}">
            </div>
            <div class="mb-2">
              <label class="form-label">Mensagem</label>
              <textarea class="form-control" id="slMsg" rows="4">${msg}</textarea>
            </div>
          </div>
          <div class="modal-footer">
            <a class="btn btn-success" id="slOpen" target="_blank" rel="noopener" data-action="open-wpp">Abrir WhatsApp</a>
            <button class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(sendLinkDiv);
    const modal = new bootstrap.Modal(sendLinkDiv); modal.show();

    const phoneEl = sendLinkDiv.querySelector("#slPhone");
    const msgEl = sendLinkDiv.querySelector("#slMsg");
    const openBtn = sendLinkDiv.querySelector("#slOpen");
    const refresh = ()=> openBtn.href = wppUrl(phoneEl.value, msgEl.value);
    [phoneEl, msgEl].forEach(el => el.addEventListener("input", refresh));
    refresh();
  }

  /* ===== Todas as faturas ===== */
  let allInvDiv = null;
  async function openAllInvoicesModal(uid){
    if (allInvDiv) allInvDiv.remove();
    allInvDiv = document.createElement("div");
    allInvDiv.className = "modal fade"; allInvDiv.tabIndex = -1;

    let rows="";
    try{
      const invSnap = await getDocs(query(collection(db,"users",uid,"financeInvoices"), orderBy("dueDate","asc")));
      const list = invSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      rows = list.map(inv=>{
        const s = String(inv.status||"").toLowerCase();
        const badge = s==="pago" ? "bg-success" : s==="atrasado" ? "bg-danger" : s==="cancelado" ? "bg-secondary" : "bg-warning text-dark";
        return `<tr>
          <td>${displayPlan(inv)}</td>
          <td>${fmtBRL(inv.amount)}</td>
          <td>${toDateStr(inv.planStart)||"—"}</td>
          <td>${toDateStr(inv.planEnd)||"—"}</td>
          <td>${toDateStr(inv.dueDate)||"—"}</td>
          <td><span class="badge ${badge}">${inv.status||"-"}</span></td>
          <td class="small">${inv.method||""}</td>
          <td class="small">${inv.gatewayId||""}</td>
          <td class="small">${inv.recordedByName||""}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="9" class="text-center text-secondary">Sem faturas.</td></tr>`;
    }catch(e){ console.error(e); rows = `<tr><td colspan="9" class="text-center text-danger">Falha ao carregar.</td></tr>`; }

    allInvDiv.innerHTML = `
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Faturas do associado</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead><tr>
                  <th>Plano</th><th>Valor</th><th>Início</th><th>Fim</th><th>Vencimento</th><th>Status</th>
                  <th>Método</th><th>GatewayId</th><th>Registrado por</th>
                </tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer"><button class="btn btn-light" data-bs-dismiss="modal">Fechar</button></div>
        </div>
      </div>
    `;
    document.body.appendChild(allInvDiv);
    new bootstrap.Modal(allInvDiv).show();
  }

  /* ===== Summary ===== */
  async function refreshSummaryFromInvoices(uid){
    const invSnap = await getDocs(query(collection(db,"users",uid,"financeInvoices"), orderBy("dueDate","asc")));
    const invoices = invSnap.docs.map(d=>({ id:d.id, ...d.data() }));

    let lastPayment=null, lastAmount=null, nextDue=null, activeUntil=null;

    const paid = invoices.filter(i=> String(i.status||"").toLowerCase()==="pago");
    if (paid.length){
      paid.sort((a,b)=> {
        const ap = a.paidAt?.toMillis?.() ?? new Date(a.paidAt||0).getTime();
        const bp = b.paidAt?.toMillis?.() ?? new Date(b.paidAt||0).getTime();
        return bp - ap;
      });
      lastPayment = paid[0].paidAt || null;
      lastAmount = paid[0].amount ?? null;

      if (paid[0].planEnd){
        const end = paid[0].planEnd?.toDate?.() ?? new Date(paid[0].planEnd);
        activeUntil = addDays(end, 10);
      }
    }

    const open = invoices.filter(i=> !["pago","cancelado"].includes(String(i.status||"").toLowerCase()));
    if (open.length){
      open.sort((a,b)=>{
        const ad = a.dueDate?.toMillis?.() ?? new Date(a.dueDate||0).getTime();
        const bd = b.dueDate?.toMillis?.() ?? new Date(b.dueDate||0).getTime();
        return ad - bd;
      });
      nextDue = open[0].dueDate || null;
    }

    await setDoc(doc(db,"users",uid,"finance","summary"), {
      lastPayment: lastPayment || null,
      lastAmount: lastAmount ?? null,
      nextDue: nextDue || null,
      activeUntil: activeUntil || null,
      updatedAt: serverTimestamp()
    }, { merge:true });
  }

  /* ===== Ações em massa ===== */
  document.getElementById("actionGenInvoices")?.addEventListener("click", openMassInvoiceModal);
  document.getElementById("actionSendReminders")?.addEventListener("click", massSendReminders);
  document.getElementById("actionExportCsv")?.addEventListener("click", exportCsvSelected);

  function getSelectedUids(){
    return Array.from(document.querySelectorAll(".row-check:checked")).map(c=> c.getAttribute("data-uid"));
  }

  let massInvDiv = null;
  function openMassInvoiceModal(){
    const uids = getSelectedUids();
    if (!uids.length){ alert("Selecione pelo menos um associado."); return; }
    if (massInvDiv) massInvDiv.remove();
    massInvDiv = document.createElement("div");
    massInvDiv.className = "modal fade"; massInvDiv.tabIndex = -1;
    massInvDiv.innerHTML = `
      <div class="modal-dialog">
        <form class="modal-content" id="massForm">
          <div class="modal-header"><h5 class="modal-title">Gerar fatura para ${uids.length} associado(s)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-sm-6">
                <label class="form-label">Plano</label>
                <select class="form-select" id="mType" required>
                  <option value="">— selecione —</option>
                  <option value="mensal">Mensal</option>
                  <option value="trimestral">Trimestral</option>
                  <option value="semestral">Semestral</option>
                  <option value="anual">Anual</option>
                </select>
              </div>
              <div class="col-sm-3">
                <label class="form-label">Valor (R$)</label>
                <input type="number" step="0.01" class="form-control" id="mAmount" required>
              </div>
              <div class="col-sm-3">
                <label class="form-label">Início do plano</label>
                <input type="date" class="form-control" id="mStart" required>
              </div>
              <div class="col-sm-6">
                <label class="form-label">Fim do plano</label>
                <input type="date" class="form-control input-readonly" id="mEnd" disabled>
              </div>
              <div class="col-sm-6">
                <label class="form-label">Vencimento</label>
                <input type="date" class="form-control input-readonly" id="mDue" disabled>
              </div>
              <div class="col-sm-12">
                <label class="form-label">Link de pagamento (opcional)</label>
                <input type="url" class="form-control" id="mUrl" placeholder="https://...">
              </div>
              <div class="col-12"><div class="form-text">Faturas criadas com status <strong>em_aberto</strong>.</div></div>
            </div>
            <div id="mMsg" class="d-none mt-2"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-light" data-bs-dismiss="modal" type="button">Cancelar</button>
            <button class="btn btn-primary" type="submit">Criar faturas</button>
          </div>
        </form>
      </div>
    `;
    document.body.appendChild(massInvDiv);
    const modal = new bootstrap.Modal(massInvDiv); modal.show();

    const msg = massInvDiv.querySelector("#mMsg");
    const show = (t,k="info")=>{ msg.textContent=t; msg.className=`alert alert-${k}`; msg.classList.remove("d-none"); };

    const mType = massInvDiv.querySelector("#mType");
    const mStart = massInvDiv.querySelector("#mStart");
    const mEnd   = massInvDiv.querySelector("#mEnd");
    const mDue   = massInvDiv.querySelector("#mDue");
    const recalcMass = ()=>{
      if (!mType.value || !mStart.value) return;
      const months = PLAN_MONTHS[mType.value];
      const end = addMonthsSafe(fromDateStr(mStart.value), months);
      mEnd.value = end ? end.toISOString().slice(0,10) : "";
      mDue.value = mEnd.value;
    };
    mType.addEventListener("change", recalcMass);
    mStart.addEventListener("change", recalcMass);

    massInvDiv.querySelector("#massForm").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const amount = Number(massInvDiv.querySelector("#mAmount").value);
      const type = mType.value;
      const planName = mType.options[mType.selectedIndex].text.trim();
      const start = fromDateStr(mStart.value);
      const end = fromDateStr(mEnd.value);
      const due = end;
      const url = massInvDiv.querySelector("#mUrl").value.trim() || null;

      try{
        for(const uid of uids){
          await addDoc(collection(db,"users",uid,"financeInvoices"), {
            planType: type, amount, status:"em_aberto",
            planName,
            planStart: start, planEnd: end, dueDate: due,
            paymentUrl: url, recordedAt: serverTimestamp(),
            recordedByUid: operatorProfile.uid, recordedByName: operatorProfile.nome, recordedByCPF: operatorProfile.cpf
          });
          await refreshSummaryFromInvoices(uid);
        }
        show("Faturas criadas com sucesso.", "success");
        setTimeout(()=>{ modal.hide(); listUsers(searchQuery.value.trim()); }, 600);
      }catch(e){ console.error(e); show("Erro: "+e.message, "danger"); }
    });
  }

  async function massSendReminders(){
    const uids = getSelectedUids();
    if (!uids.length){ alert("Selecione pelo menos um associado."); return; }
    for (const uid of uids){
      try{
        const [uSnap, sSnap] = await Promise.all([
          getDoc(doc(db,"users",uid)),
          getDoc(doc(db,"users",uid,"finance","summary"))
        ]);
        const phone = uSnap.exists() ? (uSnap.data().telefone || "") : "";
        const due = sSnap.exists()? toDateStr(sSnap.data().nextDue) : "";
        const dueTxt = due ? fmtBRDate(new Date(due+"T00:00:00")) : "(data de vencimento)";
        const msg = `Olá! Aqui é do Clube do Cavalo. Sua associação vencerá dia ${dueTxt}. Segue o link para o pagamento: ${payPageUrl()}.
Qualquer dúvida, estamos à disposição.`;
        window.open(wppUrl(phone,msg), "_blank","noopener");
      }catch(e){ console.warn("reminder fail", uid, e); }
    }
  }

  async function exportCsvSelected(){
    const uids = getSelectedUids();
    if (!uids.length){ alert("Selecione pelo menos um associado."); return; }
    const lines = [["uid","nome","cpf","status_lista","nextDue","lastPayment","lastAmount"].join(",")];

    for (const uid of uids){
      try{
        const [uSnap, sSnap, invSnap] = await Promise.all([
          getDoc(doc(db,"users",uid)),
          getDoc(doc(db,"users",uid,"finance","summary")),
          getDocs(query(collection(db,"users",uid,"financeInvoices"), orderBy("dueDate","asc")))
        ]);
        const u = uSnap.data()||{};
        const s = sSnap.data()||{};
        const invoices = invSnap.docs.map(d=>({ id:d.id, ...d.data() }));
        const m = computeMembership({ invoices, summary:s });

        const row = [
          uid,
          JSON.stringify(u.nome||""),
          JSON.stringify((u.cpf||"").replace(/\D/g,"")),
          m.listCode,
          toDateStr(s.nextDue)||"",
          toDateStr(s.lastPayment)||"",
          s.lastAmount!=null ? String(s.lastAmount).replace(".",",") : ""
        ];
        lines.push(row.join(","));
      }catch(e){ console.warn("csv user fail", uid, e); }
    }

    const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `associados_financeiro_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
