<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Área do Associado — Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Área do associado com benefícios, produtos e classificados.">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- versionado para bustar cache -->
  <link rel="stylesheet" href="assets/css/custom.css?v=assoc-2025-09-10a">

  <style>
    :root{ --brand:#111279; --accent:#2a9d8f; }

    /* ===== Brand cores ===== */
    .bg-primary{ background-color:var(--brand)!important; }
    .btn-primary{ background-color:var(--brand)!important; border-color:var(--brand)!important; }
    .btn-outline-primary{ color:var(--brand)!important; border-color:var(--brand)!important; }
    .text-primary{ color:var(--brand)!important; }
    .badge-role{ background:var(--accent); }

    /* ===== Navbar: sempre clicável e sem quebra ===== */
    .navbar{ position:relative; z-index:1020; }
    .navbar .container{ justify-content:space-between; flex-wrap:nowrap; }
    .navbar-toggler{ margin-left:auto; }
    .navbar .btn{ pointer-events:auto; }
    .navbar-brand{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:65vw; }

    /* ===== Cards / grid ===== */
    .card{ border:1px solid rgba(0,0,0,.06); border-radius:14px; will-change:transform; }
    .card:hover{ transform:translateY(-2px); transition:.2s ease; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    .thumb{ height:140px; object-fit:cover; border-top-left-radius:14px; border-top-right-radius:14px; }
    .grid{ row-gap:1rem; }

    /* ===== Busca ===== */
    .search-wrap{ position:relative; }
    .search-wrap input{ padding-left:2.25rem; }
    .search-wrap .ico{ position:absolute; left:.75rem; top:50%; transform:translateY(-50%); opacity:.55; }

    /* ===== Abas responsivas (roláveis no mobile) ===== */
    #typeTabs{ gap:.25rem; }
    @media (max-width: 575.98px){
      #typeTabs{ overflow:auto; white-space:nowrap; flex-wrap:nowrap; }
      #typeTabs .nav-item{ flex:0 0 auto; }
    }

    /* ===== Chips / estados ===== */
    .badge-type{ text-transform:uppercase; letter-spacing:.02em; }
    .empty-state{ border:1px dashed #ced4da; border-radius:.75rem; padding:1rem; text-align:center; color:#6c757d; margin:0; }
    .chip{ border:1px solid rgba(0,0,0,.08); background:#fff; border-radius:999px; padding:.35rem .75rem; font-size:.85rem; display:inline-flex; gap:.5rem; align-items:center; }
    .chip .dot{ width:.5rem; height:.5rem; border-radius:50%; display:inline-block; }
    .dot-ok{ background:#28a745; } .dot-warn{ background:#ffc107; } .dot-bad{ background:#dc3545; }

    /* ===== Layout sem “buracos” ===== */
    header{ padding-top:1.25rem!important; padding-bottom:1rem!important; }
    main{ margin-top:1rem!important; margin-bottom:1.25rem!important; }
    #listLoading{ padding:1.25rem 0; }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-truncate" href="index.html">Clube do Cavalo - Bonfim MG</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
            aria-controls="nav" aria-expanded="false" aria-label="Alternar navegação">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
        <li class="nav-item"><a class="nav-link" href="events.html">Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Fotos</a></li>
        <li class="nav-item"><a class="nav-link" href="board.html">Diretoria</a></li>
        <li class="nav-item"><a class="nav-link" href="partners.html">Parcerias</a></li>
        <li class="nav-item mt-2 mt-lg-0">
          <a class="btn btn-light text-primary ms-lg-3 w-100 w-lg-auto" href="pg_associado.html">Área do Associado</a>
        </li>
        <!-- Só aparece para admin/master -->
        <li class="nav-item d-none" id="adminBtn">
          <a class="btn btn-warning text-dark ms-4" href="operacao.html">Administração</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- HEADER -->
<header class="bg-light border-bottom">
  <div class="container d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div class="w-100">
      <h1 class="h4 mb-1">Área do Associado</h1>
      <div class="text-secondary small">Bem-vindo(a), <strong id="memberName"></strong></div>
      <div class="mt-1"><span id="memberRole" class="badge badge-role d-none text-uppercase"></span></div>
      <div class="mt-2 d-flex flex-wrap gap-2">
        <span id="chipPayStatus" class="chip d-none"><span id="chipPayDot" class="dot"></span><span id="chipPayText">Situação: —</span></span>
        <span id="chipNextDue" class="chip d-none">Próxima anuidade: <strong id="chipNextDueText" class="ms-1">—</strong></span>
        <span class="chip" id="chipCpfText">Seu número de associado é o próprio CPF.</span>
      </div>
    </div>
    <div class="d-flex gap-2 flex-shrink-0">
      <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal" id="openChangePasswordBtn">Trocar senha</button>
      <button id="logoutBtn" class="btn btn-primary">Sair</button>
    </div>
  </div>
</header>

<!-- CONTEÚDO -->
<main class="container">
  <!-- Filtros -->
  <section class="mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-12 col-md-7">
        <div class="search-wrap">
          <svg class="ico" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="searchInput" type="search" class="form-control" placeholder="Buscar produtos, serviços e classificados..." autocomplete="off">
        </div>
      </div>
      <div class="col-12 col-md-5 text-md-end">
        <ul class="nav nav-pills justify-content-md-end flex-nowrap" id="typeTabs">
          <li class="nav-item"><button class="nav-link active" data-type="all">Todos <span class="badge text-bg-light ms-1" id="countAll">0</span></button></li>
          <li class="nav-item"><button class="nav-link" data-type="service">Serviços <span class="badge text-bg-light ms-1" id="countServices">0</span></button></li>
          <li class="nav-item"><button class="nav-link" data-type="product">Produtos <span class="badge text-bg-light ms-1" id="countProducts">0</span></button></li>
          <li class="nav-item"><button class="nav-link" data-type="classified">Classificados <span class="badge text-bg-light ms-1" id="countClassifieds">0</span></button></li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Lista -->
  <section>
    <div id="listLoading" class="text-center">
      <div class="spinner-border text-primary" role="status" aria-label="Carregando"></div>
      <div class="mt-2 text-secondary small">Carregando itens...</div>
    </div>

    <div id="listGrid" class="row grid d-none"></div>
    <div id="listEmpty" class="empty-state d-none">Nada encontrado para seu filtro.</div>
    <div id="listError" class="alert alert-danger d-none mt-3"></div>
  </section>
</main>

<footer class="mt-4 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> — Promovendo a cultura equestre.</div>
    <div class="text-secondary small">© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.</div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { collection, getDocs, query, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
  updatePassword,
  reauthenticateWithCredential,
  EmailAuthProvider,
  reauthenticateWithPopup,
  GoogleAuthProvider} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { OAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";



  // ---------- Helpers de acesso ----------
  const ADMIN_UIDS = new Set([ /* "UID-ADMIN-AQUI" */ ]);
  const MASTER_UIDS = new Set([ /* "UID-MASTER-AQUI" */ ]);

  function toRoleSet(roleField) {
    if (!roleField) return new Set();
    if (Array.isArray(roleField)) return new Set(roleField.map(r => String(r).trim().toLowerCase()).filter(Boolean));
    return new Set(String(roleField).toLowerCase().split(/[,;|/ ]+/g).map(s => s.trim()).filter(Boolean));
  }

  // ---------- Helpers de nome ----------
  function looksLikeCPF(value) {
    if (!value) return false;
    const only = String(value).replace(/\D/g, "");
    if (only.length !== 11) return false;
    if (/^(\d)\1{10}$/.test(only)) return true; // 000.../111..., etc
    return true; // 11 dígitos -> trata como CPF
  }
  function properCase(s) {
    return String(s).trim().toLowerCase().replace(/(^|\s|-|\/)\p{L}/gu, m => m.toUpperCase());
  }
  function getPreferredName(u, user) {
    const firstLast = [u?.firstName, u?.lastName].filter(Boolean).join(" ").trim() || null;
    const emailPrefix = user?.email ? user.email.split("@")[0] : "";
    const candidates = [u?.nome, u?.fullName, u?.name, firstLast, user?.displayName, u?.nickname, u?.givenName, u?.surname,
      /^[A-Za-z].*/.test(emailPrefix) ? emailPrefix : null].filter(Boolean);
    for (const raw of candidates) {
      if (looksLikeCPF(raw)) continue;
      if (/^\d{8,}$/.test(String(raw).trim())) continue;
      return properCase(raw);
    }
    return "associado";
  }

  async function hasAdminAccess(user, userDocData) {
    if (ADMIN_UIDS.has(user.uid) || MASTER_UIDS.has(user.uid)) return true;
    try {
      const token = await user.getIdTokenResult(true);
      if (token?.claims?.admin || token?.claims?.master) return true;
    } catch (e) { console.warn("Falha ao ler custom claims:", e); }
    const roles = toRoleSet(userDocData?.role || "associado");
    return roles.has("admin") || roles.has("master");
  }

  // ---------- Utils ----------
  const fmtDate = (ts) => {
    if (!ts) return "—";
    try { const d = ts?.toDate ? ts.toDate() : new Date(ts);
      return new Intl.DateTimeFormat('pt-BR',{dateStyle:'medium'}).format(d);
    } catch { return "—"; }
  };
  const fmtCPF = (cpfRaw) => {
    const n = (cpfRaw || "").replace(/\D/g, "");
    if (n.length!==11) return null;
    return n.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4");
  };
  const wpp = (phone, text) => {
    const p = (phone||"").replace(/\D/g,"");
    const msg = encodeURIComponent(text||"");
    return p ? `https://wa.me/${p}?text=${msg}` : `https://wa.me/?text=${msg}`;
  };
  const debouncer = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  const norm = (s) => (s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();

  // ---------- DOM ----------
  const adminBtn = document.getElementById("adminBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const memberNameEl = document.getElementById("memberName");
  const memberRoleEl = document.getElementById("memberRole");
  const chipCpfText = document.getElementById("chipCpfText");
  const chipPayStatus = document.getElementById("chipPayStatus");
  const chipPayText = document.getElementById("chipPayText");
  const chipPayDot = document.getElementById("chipPayDot");
  const chipNextDue = document.getElementById("chipNextDue");
  const chipNextDueText = document.getElementById("chipNextDueText");
  const searchInput = document.getElementById("searchInput");
  const typeTabs = document.getElementById("typeTabs");
  const listLoading = document.getElementById("listLoading");
  const listGrid = document.getElementById("listGrid");
  const listEmpty = document.getElementById("listEmpty");
  const listError = document.getElementById("listError");
  const countAll = document.getElementById("countAll");
  const countServices = document.getElementById("countServices");
  const countProducts = document.getElementById("countProducts");
  const countClassifieds = document.getElementById("countClassifieds");

  // ---------- Estado ----------
  let currentType = "all";
  let items = [];
  let memberName = "associado";
  let metaPhones = { salesPhone:"", financePhone:"" };

  // Fecha o menu mobile ao clicar em itens (evita overlay travando clique)
  document.querySelectorAll('#nav a.nav-link, #nav .btn').forEach(el=>{
    el.addEventListener('click', ()=> {
      const collapse = document.getElementById('nav');
      if (collapse?.classList.contains('show')) new bootstrap.Collapse(collapse).hide();
    });
  });

  // ---------- Auth + Profile ----------
  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "login.html"; return; }

    try {
      const uref = doc(db, "users", user.uid);
      const usnap = await getDoc(uref);
      const u = usnap.exists() ? usnap.data() : {};

      if (await hasAdminAccess(user, u)) adminBtn?.classList.remove("d-none");
      else adminBtn?.classList.add("d-none");

      memberName = getPreferredName(u, user);
      memberNameEl.textContent = memberName;

      const roles = toRoleSet(u.role || "associado");
      const roleForBadge = roles.size ? Array.from(roles).join(" / ") : "associado";
      memberRoleEl.textContent = roleForBadge;
      memberRoleEl.classList.remove("d-none");

      const cpfFmt = fmtCPF(u.cpf);
      chipCpfText.textContent = cpfFmt
        ? `Seu número de associado é o seu CPF: ${cpfFmt}`
        : `Seu número de associado é o próprio CPF.`;

      metaPhones.salesPhone = u.salesPhone || "";
      metaPhones.financePhone = u.financePhone || "";

      await loadPaymentChips(user.uid);
      await loadAllContent();
      bindUI();
      render();
    } catch (e) {
      console.error(e);
      listLoading.classList.add("d-none");
      listError.textContent = "Não foi possível carregar seus dados.";
      listError.classList.remove("d-none");
    }
  });

  logoutBtn.addEventListener("click", async () => {
    try { await signOut(auth); } finally { window.location.href = "login.html"; }
  });

  async function loadPaymentChips(uid){
    try{
      const sumRef = doc(db, "users", uid, "finance", "summary");
      const sumSnap = await getDoc(sumRef);
      const summary = sumSnap.exists() ? sumSnap.data() : {};
      const invRef = collection(db, "users", uid, "finance", "invoices");
      const qRef = query(invRef, orderBy("dueDate", "desc"));
      const invSnap = await getDocs(qRef);
      const invoices = invSnap.docs.map(d=>({id:d.id,...d.data()}));

      let status = "Em dia";
      const now = Date.now();
      const hasOverdue = invoices.some(i=>{
        const dueMs = i.dueDate?.toMillis ? i.dueDate.toMillis() : new Date(i.dueDate).getTime();
        return (i.status||"").toLowerCase()!=="pago" && dueMs < now;
      });
      const hasOpen = invoices.some(i => (i.status||"").toLowerCase()==="em_aberto");
      if (hasOverdue) status = "Atrasada"; else if (hasOpen) status = "Anuidade pendente";

      const nextDue = summary.nextDue || invoices
        .filter(i => (i.status||"").toLowerCase()!=="pago")
        .map(i=>i.dueDate)
        .sort((a,b)=>(a?.toMillis?.()??new Date(a).getTime()) - (b?.toMillis?.()??new Date(b).getTime()))[0];

      chipPayStatus.classList.remove("d-none");
      chipPayText.textContent = `Situação: ${status}`;
      chipPayDot.classList.remove('dot-ok','dot-warn','dot-bad');
      if (status==="Em dia") chipPayDot.classList.add('dot-ok');
      else if (status==="Anuidade pendente") chipPayDot.classList.add('dot-warn');
      else chipPayDot.classList.add('dot-bad');

      chipNextDue.classList.remove("d-none");
      chipNextDueText.textContent = fmtDate(nextDue);
    }catch(e){ console.warn("chips pagamento:", e); }
  }

  // ---------- Conteúdo ----------
  async function loadAllContent(){
    listError.classList.add("d-none");
    listLoading.classList.remove("d-none");
    listGrid.classList.add("d-none");
    listEmpty.classList.add("d-none");
    items = [];

    try{
      // Serviços
      try{
        const sSnap = await getDocs(query(collection(db,"memberServices")));
        const svc = sSnap.docs.map(d=>{
          const v = d.data();
          return {
            id:d.id, type:"service",
            title:v.title||"Serviço",
            description:v.description||"",
            benefit:v.benefit||"",
            images:[v.imageUrl||"assets/img/placeholder_service.jpg"],
            whatsapp:v.whatsapp||"",
            createdAt:v.createdAt||null
          };
        });
        items.push(...svc);
      }catch(e){ console.warn("services:", e); }

      // Produtos
      try{
        const pSnap = await getDocs(query(collection(db,"memberProducts")));
        const prd = pSnap.docs.map(d=>{
          const v = d.data();
          const imgs = Array.isArray(v.imageUrls)&&v.imageUrls.length ? v.imageUrls : [v.imageUrl||"assets/img/placeholder_product.jpg"];
          return {
            id:d.id, type:"product",
            title:v.title||"Produto",
            description:v.description||"",
            benefit:v.benefit||"",
            price:v.amount||v.price||null,
            images:imgs, whatsapp:v.whatsapp||metaPhones.salesPhone||"",
            createdAt:v.createdAt||null
          };
        });
        items.push(...prd);
      }catch(e){ console.warn("products:", e); }

      // Classificados
      try{
        const cSnap = await getDocs(query(collection(db,"memberClassifieds"), orderBy("createdAt","desc")));
        const cls = cSnap.docs.map(d=>{
          const v = d.data();
          const imgs = Array.isArray(v.imageUrls)&&v.imageUrls.length ? v.imageUrls : [v.imageUrl||"assets/img/placeholder_classified.jpg"];
          return {
            id:d.id, type:"classified",
            title:v.title||"Classificado",
            description:v.description||"",
            price:v.amount||v.price||null,
            images:imgs, whatsapp:v.whatsapp||v.contactPhone||"",
            createdAt:v.createdAt||null, location:v.location||""
          };
        });
        items.push(...cls);
      }catch(e){ console.warn("classifieds:", e); }

      // Ordenação
      items.sort((a,b)=>{
        const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
        const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
        if (tb!==ta) return tb-ta;
        return (a.title||"").localeCompare(b.title||"");
      });

      refreshCounts();
      listLoading.classList.add("d-none");
      if (items.length){ listGrid.classList.remove("d-none"); render(); }
      else { listEmpty.classList.remove("d-none"); }
    }catch(e){
      console.error(e);
      listLoading.classList.add("d-none");
      listError.textContent = "Não foi possível carregar os itens. Tente novamente.";
      listError.classList.remove("d-none");
    }
  }

  function refreshCounts(){
    countAll.textContent = items.length;
    countServices.textContent = items.filter(i=>i.type==="service").length;
    countProducts.textContent = items.filter(i=>i.type==="product").length;
    countClassifieds.textContent = items.filter(i=>i.type==="classified").length;
  }

  // ---------- Render ----------
  function render(){
    const q = norm(searchInput.value);
    const filtered = items.filter(i=>{
      if (currentType!=="all" && i.type!==currentType) return false;
      if (!q) return true;
      const hay = [i.title, i.description, i.benefit, i.location, (i.price!=null? String(i.price): "")]
        .map(norm).join(" ");
      return hay.includes(q);
    });

    listGrid.innerHTML = filtered.map((i, idx)=>card(i, idx)).join("");
    listEmpty.classList.toggle("d-none", filtered.length>0);
  }

  function card(i){
    const badge = i.type==="service" ? "Serviço"
                : i.type==="product" ? "Produto"
                : "Classificado";
    const badgeClass = i.type==="service" ? "text-bg-info"
                      : i.type==="product" ? "text-bg-primary"
                      : "text-bg-secondary";
    const img = (i.images&&i.images[0]) || "assets/img/placeholder.jpg";
    const price = (i.price!=null) ? `<div class="fw-semibold mt-1">R$ ${Number(i.price).toLocaleString('pt-BR')}</div>` : "";
    const benefit = i.benefit ? `<span class="badge text-bg-success me-1">Benefício: ${i.benefit}</span>` : "";
    const btnLabel = i.type==="service" ? "Falar no WhatsApp"
                    : i.type==="product" ? "Falar com Vendas"
                    : "Falar com o Anunciante";
    const msg = `Olá! Sou o ${memberName} do Clube do Cavalo de Bonfim MG e tenho interesse em "${i.title}". Pode me ajudar?`;
    const link = wpp(i.whatsapp, msg);

    return `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100">
          <img src="${img}" class="thumb w-100" alt="${i.title}" loading="lazy">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <h6 class="mb-1">${i.title}</h6>
              <span class="badge badge-type ${badgeClass}">${badge}</span>
            </div>
            <p class="small text-secondary mb-2">${i.description||""}</p>
            ${benefit}
            ${price}
            <a class="btn btn-sm btn-primary mt-auto" href="${link}" target="_blank" rel="noopener">${btnLabel}</a>
          </div>
        </div>
      </div>
    `;
  }

  // ---------- UI bindings ----------
  function bindUI(){
    typeTabs.querySelectorAll("button.nav-link").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        typeTabs.querySelectorAll("button.nav-link").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentType = btn.getAttribute("data-type");
        render();
      });
    });
    searchInput.addEventListener("input", debouncer(()=>render(), 200));
  }
  // ===== Troca de senha (sem e-mail) =====
const changePasswordModalEl = document.getElementById("changePasswordModal");
const changePasswordForm    = document.getElementById("changePasswordForm");
const cpInfo    = document.getElementById("cpInfo");
const cpError   = document.getElementById("cpError");
const cpSuccess = document.getElementById("cpSuccess");

const groupCurrentPassword = document.getElementById("groupCurrentPassword");
const currentPassword = document.getElementById("currentPassword");
const newPassword     = document.getElementById("newPassword");
const confirmPassword = document.getElementById("confirmPassword");

const federatedBlock  = document.getElementById("federatedBlock");
const reauthPopupBtn  = document.getElementById("reauthPopupBtn");
const savePasswordBtn = document.getElementById("savePasswordBtn");

let currentUserEmail = "";
let isPasswordProvider = false;   // true: email/senha | false: federado (Google/Apple)
let reauthOK = false;             // marca se já reautenticou (federado)

function clearMsgs() {
  [cpInfo, cpError, cpSuccess].forEach(el => { el.classList.add("d-none"); el.textContent = ""; });
}

function senhaForteMin(s) {
  return typeof s === "string" && s.length >= 6;
}

changePasswordModalEl?.addEventListener("show.bs.modal", () => {
  clearMsgs();
  changePasswordForm.reset();
  reauthOK = false;

  const user = auth.currentUser;
  if (!user) {
    cpError.textContent = "Sessão expirada. Faça login novamente.";
    cpError.classList.remove("d-none");
    return;
  }

  currentUserEmail = user.email || "";

  const providers = (user.providerData || []).map(p => p.providerId);
  // password = e-mail/senha; senão, é federado (google.com, apple.com, etc.)
  isPasswordProvider = providers.includes("password");

  if (isPasswordProvider) {
    // Mostra campo de senha atual; esconde bloco federado
    groupCurrentPassword.classList.remove("d-none");
    federatedBlock.classList.add("d-none");
    cpInfo.textContent = "Informe sua senha atual e a nova senha.";
    cpInfo.classList.remove("d-none");
  } else {
    // Senha atual não existe — precisa revalidar via popup do provedor
    groupCurrentPassword.classList.add("d-none");
    federatedBlock.classList.remove("d-none");
    cpInfo.textContent = "Revalide sua sessão no provedor para definir uma nova senha sem e-mail.";
    cpInfo.classList.remove("d-none");
  }
});

// Revalidar (contas federadas) — NÃO envia e-mail; abre popup do provedor
reauthPopupBtn?.addEventListener("click", async () => {
  clearMsgs();
  const user = auth.currentUser;
  if (!user) {
    cpError.textContent = "Sessão expirada. Faça login novamente.";
    cpError.classList.remove("d-none");
    return;
  }

  try {
    // Detecta o provedor primário e escolhe o provider adequado
    const p = (user.providerData || [])[0]?.providerId || "";
    let provider;
    if (p === "google.com") {
      provider = new GoogleAuthProvider();
    } else if (p === "apple.com") {
      provider = new OAuthProvider("apple.com");
    } else {
      // fallback: tente Google (ajuste se usar outros provedores)
      provider = new GoogleAuthProvider();
    }

    await reauthenticateWithPopup(user, provider);
    reauthOK = true;
    cpSuccess.textContent = "Sessão revalidada com sucesso. Agora defina a nova senha e salve.";
    cpSuccess.classList.remove("d-none");
  } catch (err) {
    cpError.textContent = traduzErroAuth(err);
    cpError.classList.remove("d-none");
  }
});

changePasswordForm?.addEventListener("submit", async (ev) => {
  ev.preventDefault();
  clearMsgs();

  const user = auth.currentUser;
  if (!user) {
    cpError.textContent = "Sessão expirada. Faça login novamente.";
    cpError.classList.remove("d-none");
    return;
  }

  const nova = newPassword.value.trim();
  const conf = confirmPassword.value.trim();
  if (nova !== conf) {
    cpError.textContent = "A confirmação não confere com a nova senha.";
    cpError.classList.remove("d-none");
    return;
  }
  if (!senhaForteMin(nova)) {
    cpError.textContent = "A nova senha precisa ter pelo menos 6 caracteres.";
    cpError.classList.remove("d-none");
    return;
  }

  savePasswordBtn.disabled = true;

  try {
    if (isPasswordProvider) {
      // Reautenticar com a senha atual
      const curr = (currentPassword.value || "").trim();
      if (!curr) {
        throw new Error("auth/missing-current-password");
      }
      const cred = EmailAuthProvider.credential(currentUserEmail, curr);
      await reauthenticateWithCredential(user, cred);
      await updatePassword(user, nova);
    } else {
      // Federado: precisa ter reautenticado via popup primeiro
      if (!reauthOK) {
        cpInfo.textContent = "Clique em “Revalidar sessão” antes de salvar a nova senha.";
        cpInfo.classList.remove("d-none");
        savePasswordBtn.disabled = false;
        return;
      }
      await updatePassword(user, nova);
    }

    cpSuccess.textContent = "Senha alterada com sucesso!";
    cpSuccess.classList.remove("d-none");

    // Fecha modal após 1,5s (opcional)
    setTimeout(() => {
      const modal = bootstrap.Modal.getInstance(changePasswordModalEl);
      modal?.hide();
    }, 1500);

  } catch (err) {
    cpError.textContent = traduzErroAuth(err);
    cpError.classList.remove("d-none");
  } finally {
    savePasswordBtn.disabled = false;
  }
});

function traduzErroAuth(err) {
  const code = String(err?.code || "").toLowerCase();
  if (code.includes("auth/wrong-password")) return "Senha atual incorreta.";
  if (code.includes("auth/invalid-credential")) return "Credenciais inválidas.";
  if (code.includes("auth/missing-current-password")) return "Informe sua senha atual.";
  if (code.includes("auth/requires-recent-login")) return "Por segurança, revalide sua sessão e tente novamente.";
  if (code.includes("auth/weak-password")) return "A nova senha é fraca. Use ao menos 6 caracteres.";
  if (code.includes("popup-closed-by-user")) return "Popup fechado antes de concluir a revalidação.";
  if (err?.message) return err.message;
  return "Ocorreu um erro. Tente novamente.";
}

</script>
<!-- MODAL: Trocar senha (sem e-mail) -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="changePasswordForm">
      <div class="modal-header">
        <h5 class="modal-title" id="changePasswordLabel">Trocar senha</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <div id="cpInfo" class="alert alert-info d-none small mb-3"></div>
        <div id="cpError" class="alert alert-danger d-none small mb-3"></div>
        <div id="cpSuccess" class="alert alert-success d-none small mb-3"></div>

        <!-- Mostrado apenas para contas de e-mail/senha -->
        <div class="mb-3" id="groupCurrentPassword">
          <label class="form-label">Senha atual</label>
          <input type="password" class="form-control" id="currentPassword" autocomplete="current-password">
        </div>

        <div class="mb-3">
          <label class="form-label">Nova senha</label>
          <input type="password" class="form-control" id="newPassword" autocomplete="new-password" required>
          <div class="form-text">Mínimo de 6 caracteres.</div>
        </div>

        <div class="mb-1">
          <label class="form-label">Confirmar nova senha</label>
          <input type="password" class="form-control" id="confirmPassword" autocomplete="new-password" required>
        </div>

        <!-- Mostrado apenas para contas federadas (Google/Apple/etc.) -->
        <div class="mt-3 d-none" id="federatedBlock">
          <p class="small text-secondary mb-2">
            Sua conta usa um provedor externo (ex.: Google/Apple). Primeiro vamos revalidar seu login em um popup; em seguida, definiremos a nova senha aqui mesmo, sem e-mail.
          </p>
          <button type="button" class="btn btn-outline-primary btn-sm" id="reauthPopupBtn">Revalidar sessão</button>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="savePasswordBtn">
          Salvar nova senha
        </button>
      </div>
    </form>
  </div>
</div>
</body>
</html>
