<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>√Årea do Associado ‚Äî Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="√Årea do associado com benef√≠cios, produtos e classificados.">
  <meta property="og:image" content="https://clubedocavalobonfim.com.br/assets/img/logo_CCBMG.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/custom.css?v=assoc-2025-09-10b">

  <link rel="icon" type="image/png" href="assets/img/logo_CCBMG.png">
  <link rel="shortcut icon" href="assets/img/logo_CCBMG.png" type="image/png">

  <style>
    :root{ --brand:#111279; --accent:#2a9d8f; }

    .bg-primary{ background-color:var(--brand)!important; }
    .btn-primary{ background-color:var(--brand)!important; border-color:var(--brand)!important; }
    .btn-outline-primary{ color:var(--brand)!important; border-color:var(--brand)!important; }
    .text-primary{ color:var(--brand)!important; }
    .badge-role{ background:var(--accent); }

    .navbar{ position:relative; z-index:1020; }
    .navbar .container{ justify-content:space-between; flex-wrap:nowrap; }
    .navbar-toggler{ margin-left:auto; }
    .navbar .btn{ pointer-events:auto; }
    .navbar-brand{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:65vw; }

    .card{ border:1px solid rgba(0,0,0,.06); border-radius:14px; will-change:transform; }
    .card:hover{ transform:translateY(-2px); transition:.2s ease; box-shadow:0 8px 24px rgba(0,0,0,.08); }

    .thumb, .carousel-item img{
      height:200px; width:100%;
      object-fit:contain; object-position:center;
      background:#fff; border-top-left-radius:14px; border-top-right-radius:14px;
    }

    .search-wrap{ position:relative; }
    .search-wrap input{ padding-left:2.25rem; }
    .search-wrap .ico{ position:absolute; left:.75rem; top:50%; transform:translateY(-50%); opacity:.55; }

    #typeTabs{ gap:.25rem; }
    @media (max-width: 575.98px){
      #typeTabs{ overflow:auto; white-space:nowrap; flex-wrap:nowrap; }
      #typeTabs .nav-item{ flex:0 0 auto; }
    }

    .badge-type{ text-transform:uppercase; letter-spacing:.02em; }
    .empty-state{ border:1px dashed #ced4da; border-radius:.75rem; padding:1rem; text-align:center; color:#6c757d; margin:0; }
    .chip{ border:1px solid rgba(0,0,0,.08); background:#fff; border-radius:999px; padding:.35rem .75rem; font-size:.85rem; display:inline-flex; gap:.5rem; align-items:center; }
    .chip .dot{ width:.5rem; height:.5rem; border-radius:50%; display:inline-block; }
    .dot-ok{ background:#28a745; } .dot-warn{ background:#ffc107; } .dot-bad{ background:#dc3545; }

    header{ padding-top:1.25rem!important; padding-bottom:1rem!important; }
    main{ margin-top:1rem!important; margin-bottom:1.25rem!important; }
    #listLoading{ padding:1.25rem 0; }
    .brand-logo{ height:36px; width:auto; margin-right:.5rem; object-fit:contain; filter:brightness(0) invert(1); }
    @media (min-width: 992px){ .brand-logo{ height:42px; } }

    #myClassifiedsSection .card { border:1px solid rgba(0,0,0,.06); }
    .action-row { gap:.5rem; display:flex; flex-wrap:wrap; justify-content:flex-end; }

    .thumb-wrap { position:relative; }
    .thumb-wrap img { width:100%; height:140px; object-fit:cover; border-radius:.5rem; }
    .thumb-remove {
      position:absolute; top:.35rem; right:.35rem; border:none; background:rgba(0,0,0,.55); color:#fff;
      width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      line-height:1; cursor:pointer;
    }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <img class="brand-logo" src="assets/img/logo_CCBMG.png?v=ccbmg-2025-09-10d" alt="Logo Clube do Cavalo">
    <a class="navbar-brand fw-bold text-truncate" href="index.html">Clube do Cavalo - Bonfim MG</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
            aria-controls="nav" aria-expanded="false" aria-label="Alternar navega√ß√£o">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
        <li class="nav-item"><a class="nav-link" href="classificados.html">Classificados</a></li>
        <li class="nav-item"><a class="nav-link" href="events.html">Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="partners.html">Parcerias</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Fotos</a></li>
        <li class="nav-item"><a class="nav-link" href="board.html">Diretoria</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="sobre.html">Sobre o Clube</a></li>
        <li class="nav-item mt-2 mt-lg-0">
          <a class="btn btn-light text-primary ms-lg-3 w-100 w-lg-auto" href="pg_associado.html">√Årea do Associado</a>
        </li>
        <!-- S√≥ aparece para admin/master -->
        <li class="nav-item d-none" id="adminBtn">
          <a class="btn btn-warning text-dark ms-4" href="admin.html">Painel Admin</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- HEADER -->
<header class="bg-light border-bottom">
  <div class="container d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div class="w-100">
      <h1 class="h4 mb-1">√Årea do Associado</h1>
      <div class="text-secondary small">Bem-vindo(a), <strong id="memberName"></strong></div>

      <!-- Linha de chips simplificada -->
      <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
        <span id="chipPlan" class="chip d-none">Plano: <strong id="chipPlanText" class="ms-1">‚Äî</strong></span>
        <span id="chipPayStatus" class="chip d-none"><span id="chipPayDot" class="dot"></span><span id="chipPayText">Situa√ß√£o: ‚Äî</span></span>
        <span id="chipNextDue" class="chip d-none">Vencimento: <strong id="chipNextDueText" class="ms-1">‚Äî</strong></span>
        <a href="pay.html" id="btnRenewPlan" class="btn btn-success btn-sm d-none">Renovar plano</a>
      </div>
    </div>

    <div class="d-flex flex-column flex-sm-row gap-2 flex-shrink-0 text-end">
      <!-- Bot√£o s√≥ para ASSOCIADO -->
      <button class="btn btn-outline-primary d-none" id="btnNewClassified" data-bs-toggle="modal" data-bs-target="#classifiedModal">
        Novo classificado
      </button>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal" id="openChangePasswordBtn">Trocar senha</button>
        <button id="logoutBtn" class="btn btn-primary">Sair</button>
      </div>
    </div>
  </div>
</header>

<!-- CONTE√öDO -->
<main class="container">
  <!-- Filtros -->
  <section class="mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-12 col-md-7">
        <div class="search-wrap">
          <svg class="ico" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="searchInput" type="search" class="form-control" placeholder="Buscar produtos, servi√ßos e classificados..." autocomplete="off">
        </div>
      </div>
      <div class="col-12 col-md-5 text-md-end">
        <ul class="nav nav-pills justify-content-md-end flex-nowrap" id="typeTabs">
          <li class="nav-item"><button class="nav-link active" data-type="all">Todos <span class="badge text-bg-light ms-1" id="countAll">0</span></button></li>
          <li class="nav-item"><button class="nav-link" data-type="service">Servi√ßos <span class="badge text-bg-light ms-1" id="countServices">0</span></button></li>
          <li class="nav-item"><button class="nav-link" data-type="product">Produtos <span class="badge text-bg-light ms-1" id="countProducts">0</span></button></li>
          <li class="nav-item"><button class="nav-link" data-type="classified">Classificados <span class="badge text-bg-light ms-1" id="countClassifieds">0</span></button></li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Meus classificados (associado) -->
  <section id="myClassifiedsWrapper" class="mb-5 d-none">
    <div class="card border-primary shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">üìå Meus Classificados</h2>
        <small id="myClassifiedsCount">0</small>
      </div>
      <div id="myClassifiedsSection" class="row g-3"></div>
      <div id="myClassifiedsEmpty" class="empty-state d-none text-center text-muted py-4">
        Voc√™ ainda n√£o cadastrou classificados.
      </div>
    </div>
  </section>

  <!-- Listagem principal -->
  <section id="allClassifiedsWrapper" class="mb-5">
    <div class="card border-secondary shadow-sm">
      <div class="card-body">
        <div id="listLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status" aria-label="Carregando"></div>
          <div class="mt-2 text-secondary small">Carregando itens...</div>
        </div>
        <div id="listGrid" class="row g-3 d-none"></div>
        <div id="listEmpty" class="empty-state d-none text-center text-muted py-4">
          Nada encontrado para seu filtro.
        </div>
        <div id="listError" class="alert alert-danger d-none mt-3"></div>
      </div>
    </div>
  </section>

</main>

<footer class="mt-5 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> ‚Äî Promovendo a cultura equestre.</div>
    <div class="text-secondary small text-center">¬© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gest√£o de Associa√ß√µes Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    collection, getDocs, query, orderBy, doc, getDoc, addDoc, where, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    updatePassword, reauthenticateWithCredential, EmailAuthProvider, reauthenticateWithPopup, GoogleAuthProvider
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { OAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  import { uploadImageFile } from "./firebase.js";

  const PAYMENT_URL = "https://mpago.la/1mJpCsd";

  /* ================== Helpers de acesso / roles ================== */
  const ADMIN_UIDS = new Set([]);
  const MASTER_UIDS = new Set([]);

  function toRoleSet(roleField) {
    if (!roleField) return new Set();
    if (Array.isArray(roleField)) return new Set(roleField.map(r => String(r).trim().toLowerCase()).filter(Boolean));
    return new Set(String(roleField).toLowerCase().split(/[,;|/ ]+/g).map(s => s.trim()).filter(Boolean));
  }

  async function hasAdminAccess(user, userDocData) {
    if (ADMIN_UIDS.has(user.uid) || MASTER_UIDS.has(user.uid)) return true;
    try {
      const token = await user.getIdTokenResult(true);
      if (token?.claims?.admin || token?.claims?.master) return true;
    } catch {}
    const roles = toRoleSet(userDocData?.role || "associado");
    return roles.has("admin") || roles.has("master");
  }

  /* ================== Helpers de UI / dados ================== */
  function looksLikeCPF(value) {
    if (!value) return false;
    const only = String(value).replace(/\D/g, "");
    if (only.length !== 11) return false;
    if (/^(\d)\1{10}$/.test(only)) return true;
    return true;
  }
  function properCase(s) {
    return String(s).trim().toLowerCase().replace(/(^|\s|-|\/)\p{L}/gu, m => m.toUpperCase());
  }
  function getPreferredName(u, user) {
    const firstLast = [u?.firstName, u?.lastName].filter(Boolean).join(" ").trim() || null;
    const emailPrefix = user?.email ? user.email.split("@")[0] : "";
    const candidates = [u?.nome, u?.fullName, u?.name, firstLast, user?.displayName, u?.nickname, u?.givenName, u?.surname,
      /^[A-Za-z].*/.test(emailPrefix) ? emailPrefix : null].filter(Boolean);
    for (const raw of candidates) {
      if (looksLikeCPF(raw)) continue;
      if (/^\d{8,}$/.test(String(raw).trim())) continue;
      return properCase(raw);
    }
    return "associado";
  }
  const fmtDate = (ts) => {
    if (!ts) return "‚Äî";
    try { const d = ts?.toDate ? ts.toDate() : new Date(ts);
      return new Intl.DateTimeFormat('pt-BR',{dateStyle:'medium'}).format(d);
    } catch { return "‚Äî"; }
  };

  const debouncer = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  const norm = (s) => (s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();

  // Gera link do WhatsApp
  function wpp(phone, text) {
  const p = (phone||"").replace(/\D/g,"");
  const msg = encodeURIComponent(text||"");
  return p ? `https://wa.me/${p}?text=${msg}` : `https://wa.me/?text=${msg}`;
  }

  /* ===== Helpers do plano ===== */
  const monthsToPlan = (m)=>({1:"Mensal",3:"Trimestral",6:"Semestral",12:"Anual"}[m]||null);
  function guessPlanName(start, end, hinted){
    const nameRaw = String(hinted||"").trim().toLowerCase();
    if (["mensal","trimestral","semestral","anual"].includes(nameRaw)) return nameRaw.charAt(0).toUpperCase()+nameRaw.slice(1);
    const s = start?.toDate ? start.toDate() : (start ? new Date(start) : null);
    const e = end?.toDate ? end.toDate()   : (end   ? new Date(end)   : null);
    if (s && e && !isNaN(s) && !isNaN(e)) {
      const months = (e.getFullYear()-s.getFullYear())*12 + (e.getMonth()-s.getMonth()) + (e.getDate()>=s.getDate()?0:-1);
      const candidates=[1,3,6,12]; let best=candidates[0], diff=Infinity;
      for (const c of candidates){ const d=Math.abs(months-c); if(d<diff){best=c; diff=d;} }
      return monthsToPlan(best) || "‚Äî";
    }
    return "‚Äî";
  }
  /* ======== GATE DE ACESSO: ativo + financeiro (em dia ou atraso <= 10 dias) ======== */
  function asDate(d){
    if (!d) return null;
    if (d?.toDate) return d.toDate();
    const t = new Date(d);
    return isNaN(t) ? null : t;
  }
  function pickFirstDate(...cands){
    for (const c of cands){
      const dt = asDate(c);
      if (dt) return dt;
    }
    return null;
  }
  function trueish(v){
    if (typeof v === "boolean") return v;
    if (v == null) return false;
    const s = String(v).trim().toLowerCase();
    return s === "true" || s === "1" || s === "yes" || s === "ativo" || s === "active";
  }
function computeStatusFromInvoices(invoices, nowMs){
  for (const i of (invoices||[])){
    const status = String(i?.status||"").toLowerCase();
    const dueMs  = i?.dueDate?.toMillis ? i.dueDate.toMillis() : (i?.dueDate ? new Date(i.dueDate).getTime() : NaN);
    const isPaid = status === "pago";
    if (!isPaid && Number.isFinite(dueMs) && dueMs < nowMs){
      return "Atrasada"; // s√≥ bloqueia por atraso real (vencido)
    }
  }
  return "Em dia"; // aberto/futuro continua "Em dia" para efeito de gate
}

  function resolvePlanEnd(summary, invoices){
    // tenta nos campos mais comuns do summary
    const endFromSummary = pickFirstDate(
      summary?.planEnd, summary?.endDate, summary?.planEndDate, summary?.fim, summary?.plan_end
    );
    if (endFromSummary) return endFromSummary;

    // tenta nos campos das faturas, priorizando PAGA mais recente; sen√£o a mais recente
    const ordered = [...(invoices||[])].sort((a,b)=>{
      const da = a?.dueDate?.toMillis ? a.dueDate.toMillis() : (a?.dueDate ? new Date(a.dueDate).getTime() : 0);
      const db = b?.dueDate?.toMillis ? b.dueDate.toMillis() : (b?.dueDate ? new Date(b.dueDate).getTime() : 0);
      return db - da;
    });
    const paidFirst = ordered.find(i => String(i?.status||"").toLowerCase()==="pago") || ordered[0];

    return pickFirstDate(
      paidFirst?.endDate, paidFirst?.end, paidFirst?.fim, paidFirst?.planEnd, paidFirst?.plan_end
    );
  }

  /**
   * Avalia se o usu√°rio pode acessar e, se n√£o puder, retorna um code para redireciono ao pay.html
   * Regra: ativo === true E (status === "Em dia" OU (status === "Atrasada" E agora <= planEnd + 10 dias))
   */
  async function evaluateAccessGate(db, uid, userDocData){
    // 1) Ativo (flag no painel)
    const activeFlag = trueish(userDocData?.isActive ?? userDocData?.ativo ?? userDocData?.active);
    if (!activeFlag){
      return { ok:false, code:"inactive_flag", msg:"Seu cadastro est√° inativo." };
    }

    // 2) L√™ summary e invoices do usu√°rio
    let summary = {};
    try {
      const sumRef = doc(db, "users", uid, "finance", "summary");
      const sumSnap = await getDoc(sumRef);
      summary = sumSnap.exists() ? sumSnap.data() : {};
    } catch {}
    if (!summary || Object.keys(summary).length===0){
      try{
        const sumRef2 = doc(db, "users", uid, "finance_summary");
        const sumSnap2 = await getDoc(sumRef2);
        summary = sumSnap2.exists() ? sumSnap2.data() : {};
      } catch {}
    }

    let invoices = [];
    try{
      const invSnap = await getDocs(
        query(collection(db, "users", uid, "financeInvoices"), orderBy("dueDate","desc"))
      );
      invoices = invSnap.docs.map(d=>({id:d.id, ...d.data()}));
    }catch{}

    // 3) Status financeiro + c√°lculo de fim de plano + grace de 10 dias
    const nowMs = Date.now();
    const status = computeStatusFromInvoices(invoices, nowMs);
    const planEnd = resolvePlanEnd(summary, invoices); // Date ou null
    const planEndMs = planEnd ? planEnd.getTime() : NaN;
    const graceMs = 10 * 24 * 60 * 60 * 1000; // 10 dias

    // Libera se: Em dia
    if (status === "Em dia") return { ok:true };

    // Libera se: Atrasada mas dentro do grace (precisa conhecer planEnd)
    if (status === "Atrasada" && Number.isFinite(planEndMs) && nowMs <= (planEndMs + graceMs)){
      return { ok:true };
    }

    // Bloqueia nos demais casos
    if (status === "Atrasada"){
      return {
        ok:false,
        code: Number.isFinite(planEndMs) ? "late_over_10d" : "late_no_plan_end",
        until: Number.isFinite(planEndMs) ? new Date(planEndMs + graceMs).toISOString() : null
      };
    }

    // "Anuidade pendente" (n√£o libera)
    return { ok:false, code:"open_invoice" };
  }


  /* ================== DOM refs ================== */
  const adminBtn = document.getElementById("adminBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const memberNameEl = document.getElementById("memberName");

  // Chips do cabe√ßalho
  const chipPlan = document.getElementById("chipPlan");
  const chipPlanText = document.getElementById("chipPlanText");
  const chipPayStatus = document.getElementById("chipPayStatus");
  const chipPayText = document.getElementById("chipPayText");
  const chipPayDot = document.getElementById("chipPayDot");
  const chipNextDue = document.getElementById("chipNextDue");
  const chipNextDueText = document.getElementById("chipNextDueText");
  const btnRenewPlan = document.getElementById("btnRenewPlan");

  const searchInput = document.getElementById("searchInput");
  const typeTabs = document.getElementById("typeTabs");
  const listLoading = document.getElementById("listLoading");
  const listGrid = document.getElementById("listGrid");
  const listEmpty = document.getElementById("listEmpty");
  const listError = document.getElementById("listError");
  const countAll = document.getElementById("countAll");
  const countServices = document.getElementById("countServices");
  const countProducts = document.getElementById("countProducts");
  const countClassifieds = document.getElementById("countClassifieds");

  // My classifieds nodes
  const myClassifiedsWrapper = document.getElementById("myClassifiedsWrapper");
  const myClassifiedsSection = document.getElementById("myClassifiedsSection");
  const myClassifiedsEmpty = document.getElementById("myClassifiedsEmpty");
  const myClassifiedsCount = document.getElementById("myClassifiedsCount");

  // Modal Novo Classificado
  const classifiedModalEl = document.getElementById("classifiedModal");
  const classifiedForm = document.getElementById("classifiedForm");
  const clsTitle = document.getElementById("clsTitle");
  const clsPrice = document.getElementById("clsPrice");
  const clsContact = document.getElementById("clsContact");
  const clsDesc = document.getElementById("clsDesc");
  const clsFeedback = document.getElementById("clsFeedback");
  const btnNewClassified = document.getElementById("btnNewClassified");

  // Upload
  const clsImagesInput = document.getElementById("clsImages");
  const btnPickImgs    = document.getElementById("btnPickImgs");
  const btnClearImgs   = document.getElementById("btnClearImgs");
  const imgPreviewGrid = document.getElementById("imgPreviewGrid");
  const imgProgressList= document.getElementById("imgProgressList");
  let selectedFiles = [];

  /* ================== Estado ================== */
  let currentType = "all";
  let items = [];
  let memberName = "associado";
  let metaPhones = { salesPhone:"", financePhone:"" };
  let currentUser = null;
  let currentUserRoles = new Set();
  let myClassifieds = [];

  // Fecha o menu mobile ao clicar
  document.querySelectorAll('#nav a.nav-link, #nav .btn').forEach(el=>{
    el.addEventListener('click', ()=>{
      const collapse = document.getElementById('nav');
      if (collapse?.classList.contains('show')) new bootstrap.Collapse(collapse).hide();
    });
  });

  /* ================== Auth + Perfil ================== */
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "login.html"; return; }
  currentUser = user;

  try {
    const uref = doc(db, "users", user.uid);
    const usnap = await getDoc(uref);
    const u = usnap.exists() ? usnap.data() : {};

    // Admin/master continuam podendo acessar mesmo sem estar em dia
    const isAdminOrMaster = await hasAdminAccess(user, u);
    if (isAdminOrMaster) {
      adminBtn?.classList.remove("d-none");
    } else {
      adminBtn?.classList.add("d-none");
      // <<< AQUI: aplica o gate de acesso para associados comuns >>>
      const gate = await evaluateAccessGate(db, user.uid, u);
      if (!gate.ok) {
        const params = new URLSearchParams({
          reason: gate.code || "access_denied",
          // opcionalmente exponha a data-limite do grace ao usu√°rio
          ...(gate.until ? { until: gate.until } : {})
        });
        window.location.href = `pay.html?${params.toString()}`;
        return; // interrompe carregamento da p√°gina do associado
      }
    }

    // ====== segue fluxo normal (UI) ======
    memberName = getPreferredName(u, user);
    memberNameEl.textContent = memberName;

    currentUserRoles = toRoleSet(u.role || "associado");
    metaPhones.salesPhone = u.salesPhone || "";
    metaPhones.financePhone = u.financePhone || "";

    await loadPaymentChips(user.uid);
    await loadAllContent();
    bindUI();
    render();
  } catch (e) {
    console.error(e);
    listLoading.classList.add("d-none");
    listError.textContent = "N√£o foi poss√≠vel carregar seus dados.";
    listError.classList.remove("d-none");
  }
});

  logoutBtn.addEventListener("click", async () => {
    try { await signOut(auth); } finally { window.location.href = "login.html"; }
  });

  // ====== Carrega status/planos para chips (sem se√ß√£o financeira) ======
  async function loadPaymentChips(uid){
    try{
      // Summary (prefer√™ncia: users/{uid}/finance/summary)
      let summary = {};
      try {
        const sumRef = doc(db, "users", uid, "finance", "summary");
        const sumSnap = await getDoc(sumRef);
        summary = sumSnap.exists() ? sumSnap.data() : {};
      } catch {}
      // Fallback: users/{uid}/finance_summary
      if (!summary || Object.keys(summary).length===0) {
        try {
          const sumRef2 = doc(db, "users", uid, "finance_summary");
          const sumSnap2 = await getDoc(sumRef2);
          summary = sumSnap2.exists() ? sumSnap2.data() : {};
        } catch {}
      }

      // Invoices (cole√ß√£o usada no Admin): users/{uid}/financeInvoices
      let invoices = [];
      try {
        const invSnap = await getDocs(
          query(collection(db, "users", uid, "financeInvoices"), orderBy("dueDate","desc"))
        );
        invoices = invSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {
        console.warn("financeInvoices:", e);
      }

      // ---- Plano (mostrar exatamente o que foi cadastrado)
      const orderedInv = [...(invoices||[])].sort((a,b)=>{
        const da = a.dueDate?.toMillis ? a.dueDate.toMillis() : (a.dueDate ? new Date(a.dueDate).getTime() : 0);
        const db = b.dueDate?.toMillis ? b.dueDate.toMillis() : (b.dueDate ? new Date(b.dueDate).getTime() : 0);
        return db - da;
      });
      // 1) Preferir uma fatura "paga"; sen√£o, pegar a mais recente por vencimento
      const chosen = orderedInv.find(i => String(i.status||'').toLowerCase()==='pago') || orderedInv[0];
      // 2) Ler o texto armazenado na fatura; se n√£o houver, usar o do summary
      const planLabel =
        chosen?.planName || chosen?.planLabel || chosen?.plano || chosen?.plan ||
        summary?.planName || summary?.planLabel || summary?.plano || summary?.plan || "‚Äî";


      chipPlanText.textContent = planLabel;
      chipPlan.classList.remove("d-none");


      // ---- Situa√ß√£o + Pr√≥ximo Pagamento
      let status = "Em dia";
      const now = Date.now();
      const hasOverdue = invoices.some(i=>{
        const dueMs = i.dueDate?.toMillis ? i.dueDate.toMillis() : new Date(i.dueDate).getTime();
        return (String(i.status||"").toLowerCase()!=="pago") && dueMs < now;
      });
      const hasOpen = invoices.some(i => String(i.status||"").toLowerCase()==="em_aberto");
      if (hasOverdue) status = "Atrasada";
      else if (hasOpen) status = "Anuidade pendente";

      const nextDue = summary?.nextDue || invoices
        .filter(i => String(i.status||"").toLowerCase()!=="pago")
        .map(i=>i.dueDate)
        .sort((a,b)=>(a?.toMillis?.()??new Date(a).getTime()) - (b?.toMillis?.()??new Date(b).getTime()))[0];

      chipPayStatus.classList.remove("d-none");
      chipPayText.textContent = `Situa√ß√£o: ${status}`;
      chipPayDot.className = "dot " + (status==="Em dia" ? "dot-ok" : status==="Anuidade pendente" ? "dot-warn" : "dot-bad");

      chipNextDue.classList.remove("d-none");
      chipNextDueText.textContent = fmtDate(nextDue);

      // Mostrar bot√£o Renovar ap√≥s Pr√≥ximo Pagamento
      btnRenewPlan.classList.remove("d-none");
      btnRenewPlan.href = "pay.html"; // mant√©m destino

      // Mostrar bot√£o "Novo classificado" somente para ASSOCIADO
      if (currentUserRoles.has("associado")) {
        btnNewClassified.classList.remove("d-none");
      } else {
        btnNewClassified.classList.add("d-none");
      }
    }catch(e){
      console.warn("chips/financeiro:", e);
      // Ainda assim mostramos o bot√£o de renovar
      btnRenewPlan.classList.remove("d-none");
    }
  }

  /* ================== Conte√∫do ================== */
  async function loadAllContent(){
    listError.classList.add("d-none");
    listLoading.classList.remove("d-none");
    listGrid.classList.add("d-none");
    listEmpty.classList.add("d-none");
    myClassifiedsWrapper.classList.add("d-none");
    myClassifiedsSection.innerHTML = "";
    myClassifieds = [];
    items = [];

    try{
      // Servi√ßos
      try {
        const sSnap = await getDocs(query(collection(db,"memberServices")));
        const svc = sSnap.docs.map(d=>{
          const v = d.data();
          const isActive = (v.active !== false);
          if (!isActive) return null;
          return {
            id:d.id, type:"service",
            title:v.title||"Servi√ßo",
            description:v.description||"",
            benefit:v.benefit||"",
            images:[v.imageUrl||"assets/img/placeholder_service.jpg"],
            whatsapp:v.whatsapp||"",
            createdAt:v.createdAt||null
          };
        }).filter(Boolean);
        items.push(...svc);
      }catch(e){ console.warn("services:", e); }

      // Produtos
      try{
        const pSnap = await getDocs(query(collection(db,"memberProducts")));
        const prd = pSnap.docs.map(d=>{
          const v = d.data();
          const isActive = (v.active !== false);
          if (!isActive) return null;
          const imgs = Array.isArray(v.imageUrls)&&v.imageUrls.length ? v.imageUrls
                      : (v.imageUrl ? [v.imageUrl] : ["assets/img/placeholder_product.jpg"]);
          return {
            id:d.id, type:"product",
            title:v.title||"Produto",
            description:v.description||"",
            benefit:v.benefit||"",
            price:v.amount||v.price||null,
            images:imgs,
            whatsapp:v.whatsapp||metaPhones.salesPhone||"",
            createdAt:v.createdAt||null
          };
        }).filter(Boolean);
        items.push(...prd);
      }catch(e){ console.warn("products:", e); }

      // Classificados ‚Äî geral
      try{
        const cSnap = await getDocs(query(collection(db,"memberClassifieds"), orderBy("createdAt","desc")));
        const cls = cSnap.docs.map(d=>{
          const v = d.data();
          const isActive = (v.active !== false) && (v.approved === true);
          if (!isActive) return null;
          const imgs = Array.isArray(v.imageUrls)&&v.imageUrls.length ? v.imageUrls
                       : (v.imageUrl ? [v.imageUrl] : ["assets/img/placeholder_classified.jpg"]);
          return {
            id:d.id, type:"classified",
            title:v.title||"Classificado",
            description:v.description||"",
            price:v.amount||v.price||null,
            images:imgs, whatsapp:v.whatsapp||v.contactPhone||"",
            createdAt:v.createdAt||null, location:v.location||"",
            ownerName: v.ownerName || v.owner || ""
          };
        }).filter(Boolean);
        items.push(...cls);
      }catch(e){ console.warn("classifieds:", e); }

      // Meus classificados ‚Äî ativos ou pendentes
      try{
        if (currentUser) {
          let mySnap = await getDocs(query(collection(db,"memberClassifieds"), where("ownerUid","==", currentUser.uid), orderBy("createdAt","desc")));
          let docs = mySnap.docs || [];

          if ((!docs || docs.length===0) && currentUser.email) {
            mySnap = await getDocs(query(collection(db,"memberClassifieds"), where("ownerEmail","==", currentUser.email), orderBy("createdAt","desc")));
            docs = mySnap.docs || [];
          }

          if ((!docs || docs.length===0) && memberName) {
            const allMy = await getDocs(query(collection(db,"memberClassifieds"), orderBy("createdAt","desc")));
            docs = allMy.docs.filter(d=>{
              const v = d.data() || {};
              const possible = [v.owner, v.ownerName, v.ownerDisplayName, v.owner_fullname].map(x=>String(x||"").toLowerCase());
              return possible.some(p => p && p.includes(String(memberName || "").toLowerCase()));
            });
          }

          myClassifieds = (docs || []).map(d=>{
            const v = d.data();
            const imgs = Array.isArray(v.imageUrls)&&v.imageUrls.length ? v.imageUrls
                         : (v.imageUrl ? [v.imageUrl] : ["assets/img/placeholder_classified.jpg"]);
            return {
              id:d.id,
              raw:v,
              title:v.title||"Classificado",
              description:v.description||"",
              price:v.amount||v.price||null,
              images:imgs,
              whatsapp:v.whatsapp||v.contactPhone||"",
              createdAt:v.createdAt||null,
              active: v.active !== false,
              approved: v.approved === true,
              paymentStatus: v.paymentStatus || v.paymentState || (v.pendingPayment ? "pending" : null),
              paymentUrl: v.paymentUrl || v.payment_link || v.paymentLink || PAYMENT_URL
            };
          }) || [];
        }
      }catch(e){ console.warn("my classifieds:", e); }

      // Ordena√ß√£o geral
      items.sort((a,b)=>{
        const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
        const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
        if (tb!==ta) return tb-ta;
        return (a.title||"").localeCompare(b.title||"");
      });

      refreshCounts();
      listLoading.classList.add("d-none");

      if (Array.isArray(myClassifieds) && myClassifieds.length) {
        myClassifiedsWrapper.classList.remove("d-none");
        renderMyClassifieds();
      } else {
        myClassifiedsWrapper.classList.add("d-none");
      }

      if (items.length){ listGrid.classList.remove("d-none"); render(); }
      else { listEmpty.classList.remove("d-none"); }
    }catch(e){
      console.error(e);
      listLoading.classList.add("d-none");
      listError.textContent = "N√£o foi poss√≠vel carregar os itens. Tente novamente.";
      listError.classList.remove("d-none");
    }
  }

  function refreshCounts(){
    countAll.textContent = items.length;
    countServices.textContent = items.filter(i=>i.type==="service").length;
    countProducts.textContent = items.filter(i=>i.type==="product").length;
    countClassifieds.textContent = items.filter(i=>i.type==="classified").length;
  }

  /* ================== Render ================== */
  function render(){
    const q = norm(searchInput.value);
    const filtered = items.filter(i=>{
      if (currentType!=="all" && i.type!==currentType) return false;
      if (!q) return true;
      const hay = [i.title, i.description, i.benefit, i.location, (i.price!=null? String(i.price): "")]
        .map(norm).join(" ");
      return hay.includes(q);
    });

    listGrid.innerHTML = filtered.map((i)=>card(i)).join("");
    listEmpty.classList.toggle("d-none", filtered.length>0);
  }

  function renderMyClassifieds(){
    const mapped = myClassifieds.map(i => myCard(i)).join("");
    myClassifiedsSection.innerHTML = mapped;
    myClassifiedsEmpty.classList.toggle("d-none", myClassifieds.length>0);
    myClassifiedsCount.textContent = myClassifieds.length;
  }

  /* ======== Helper: carrossel (Bootstrap 5) ======== */
  function carouselHtml(images, title, uid){
    if (!images || !images.length) {
      return `<img src="assets/img/placeholder.jpg" class="thumb w-100" alt="${title}" loading="lazy">`;
    }
    if (images.length === 1){
      const img = images[0];
      return `<img src="${img}" class="thumb w-100" alt="${title}" loading="lazy">`;
    }
    const id = `crs_${uid}`;
    const ind = images.map((_,i)=>`<button type="button" data-bs-target="#${id}" data-bs-slide-to="${i}" ${i===0?'class="active" aria-current="true"':''} aria-label="Slide ${i+1}"></button>`).join("");
    const slides = images.map((src,i)=>`
      <div class="carousel-item ${i===0?'active':''}">
        <img src="${src}" class="d-block w-100" alt="${title}">
      </div>`).join("");
    return `
      <div id="${id}" class="carousel slide" data-bs-ride="false">
        <div class="carousel-indicators">${ind}</div>
        <div class="carousel-inner">${slides}</div>
        <button class="carousel-control-prev" type="button" data-bs-target="#${id}" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Anterior</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#${id}" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Pr√≥ximo</span>
        </button>
      </div>`;
  }

  /* ======== Cart√µes ======== */
  function card(i){
    const badge = i.type==="service" ? "Servi√ßo"
              : i.type==="product" ? "Produto"
              : "Classificado";
    const badgeClass = i.type==="service" ? "text-bg-info"
                      : i.type==="product" ? "text-bg-primary"
                      : "text-bg-secondary";

    const gallery = carouselHtml(i.images, i.title, `${i.type}_${i.id}`);

    const price = (i.price!=null && i.type!=="service")
      ? `<div class="fw-semibold mt-1">R$ ${Number(i.price).toLocaleString('pt-BR')}</div>` 
      : "";

    const benefit = (i.type==="service" && i.benefit)
      ? `<span class="badge bg-success d-block text-center py-2 mb-3">${i.benefit} de desconto</span>`
      : "";

    const btnLabel = i.type==="service" ? "Falar no WhatsApp"
                    : i.type==="product" ? "Falar com Vendas"
                    : "Falar com o Anunciante";
    const msg = `Ol√°! Sou o ${memberName} do Clube do Cavalo de Bonfim MG e tenho interesse em \"${i.title}\". Pode me ajudar?`;
    const link = wpp(i.whatsapp, msg);

    const owner = (i.type==="classified" && i.ownerName) 
      ? `<p class="small text-muted mb-2">Anunciante: ${i.ownerName}</p>` 
      : "";

    return `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100">
          ${gallery}
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <h6 class="mb-1">${i.title}</h6>
              <span class="badge badge-type ${badgeClass}">${badge}</span>
            </div>
            ${owner}
            <p class="small text-secondary mb-2">${i.description||""}</p>
            ${benefit}
            ${price}
            <a class="btn btn-sm btn-primary mt-auto" href="${link}" target="_blank" rel="noopener">${btnLabel}</a>
          </div>
        </div>
      </div>
    `;
  }

  function myCard(i){
    const gallery = carouselHtml(i.images, i.title, `my_${i.id}`);
    const price = (i.price!=null) ? `<div class="fw-semibold mt-1">R$ ${Number(i.price).toLocaleString('pt-BR')}</div>` : "";
    const approvedBadge = i.approved ? `<span class="badge text-bg-success me-1">Aprovado</span>` : `<span class="badge text-bg-warning me-1">Aguardando aprova√ß√£o</span>`;
    const activeBadge = i.active ? `<span class="badge text-bg-primary me-1">Ativo</span>` : `<span class="badge text-bg-secondary me-1">Inativo</span>`;
    const payPending = isPendingPayment(i);
    const payBtn = payPending ? `<button class="btn btn-sm btn-success" data-action="pay" data-id="${i.id}">Pagar an√∫ncio</button>` : "";
    const deactivateBtn = i.active ? `<button class="btn btn-sm btn-outline-secondary" data-action="deactivate" data-id="${i.id}">Desativar</button>` : "";
    const deleteBtn = `<button class="btn btn-sm btn-danger" data-action="delete" data-id="${i.id}">Excluir</button>`;
    const detailsBtn = `<button class="btn btn-sm btn-outline-primary" data-action="view" data-id="${i.id}">Ver</button>`;

    return `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100">
          ${gallery}
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <h6 class="mb-1">${i.title}</h6>
              <div>${approvedBadge}${activeBadge}</div>
            </div>
            <p class="small text-secondary mb-2">${i.description||""}</p>
            ${price}
            <div class="mt-3 action-row">
              ${payBtn}
              ${deactivateBtn}
              ${detailsBtn}
              ${deleteBtn}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  /* ================== Helpers classificados do usu√°rio ================== */
  function isPendingPayment(obj){
    const raw = obj?.raw || {};
    const s = String(obj?.paymentStatus || raw.paymentStatus || raw.paymentState || "").toLowerCase();
    if (!s && (raw.pendingPayment || raw.paymentPending)) return true;
    if (!s && (raw.paymentUrl || obj?.paymentUrl)) return true;
    if (["pending","pendente","em_aberto","pendente_pagamento","pending_payment","open","unpaid"].some(x=>s.includes(x))) return true;
    return false;
  }

  async function handleMyAction(ev){
    const btn = ev.target.closest("button");
    if (!btn) return;
    const action = btn.getAttribute("data-action");
    const id = btn.getAttribute("data-id");
    if (!action || !id) return;

    if (action === "view") {
      const item = myClassifieds.find(m => m.id === id);
      if (!item) return;
      showViewModal(item);
      return;
    }

    if (action === "pay") {
      await payClassified(id);
      return;
    }
    if (action === "deactivate") {
      if (!confirm("Deseja realmente desativar este an√∫ncio?")) return;
      await deactivateClassified(id);
      return;
    }
    if (action === "delete") {
      if (!confirm("Excluir o an√∫ncio √© irrevers√≠vel. Deseja continuar?")) return;
      await deleteClassified(id);
      return;
    }
  }

  myClassifiedsSection.addEventListener("click", handleMyAction);

  async function payClassified(id){
    try {
      const item = myClassifieds.find(m=>m.id===id);
      if (!item) { alert("An√∫ncio n√£o encontrado."); return; }
      const link = item.paymentUrl || PAYMENT_URL;
      window.open(link, "_blank", "noopener");
    } catch (e) {
      console.error(e);
      alert("N√£o foi poss√≠vel iniciar o pagamento. Tente novamente.");
    }
  }

  async function deactivateClassified(id){
    try {
      const cref = doc(db, "memberClassifieds", id);
      await updateDoc(cref, { active: false, updatedAt: new Date() });
      await loadAllContent();
    } catch (e) {
      console.error(e);
      alert("Falha ao desativar o an√∫ncio.");
    }
  }

  async function deleteClassified(id){
    try {
      const cref = doc(db, "memberClassifieds", id);
      await deleteDoc(cref);
      await loadAllContent();
    } catch (e) {
      console.error(e);
      alert("Falha ao excluir o an√∫ncio.");
    }
  }

  /* ================== UI bindings ================== */
  function bindUI(){
    typeTabs.querySelectorAll("button.nav-link").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        typeTabs.querySelectorAll("button.nav-link").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentType = btn.getAttribute("data-type");
        render();
      });
    });
    searchInput.addEventListener("input", debouncer(()=>render(), 200));
  }

  /* ================== Novo Classificado (Associado) ================== */
  btnPickImgs?.addEventListener("click", () => clsImagesInput.click());

  btnClearImgs?.addEventListener("click", () => {
    selectedFiles = [];
    clsImagesInput.value = "";
    renderImgPreviews();
    imgProgressList.innerHTML = "";
  });

  clsImagesInput?.addEventListener("change", () => {
    const files = Array.from(clsImagesInput.files || []);
    if (!files.length) return;

    for (const f of files) {
      if (selectedFiles.length >= 3) break;
      if (!f.type.startsWith("image/")) continue;
      if (f.size > 10 * 1024 * 1024) {
        alert(`A imagem ${f.name} parece muito grande (>10MB). Tente outra.`);
        continue;
      }
      selectedFiles.push(f);
    }
    if (selectedFiles.length > 3) {
      selectedFiles = selectedFiles.slice(0,3);
    }
    renderImgPreviews();
  });

  function renderImgPreviews() {
    imgPreviewGrid.innerHTML = selectedFiles.map((f, idx) => {
      const url = URL.createObjectURL(f);
      return `
        <div class="col-4">
          <div class="thumb-wrap">
            <img src="${url}" alt="preview ${idx+1}">
            <button type="button" class="thumb-remove" data-idx="${idx}" title="Remover">√ó</button>
          </div>
          <div class="small text-truncate mt-1" title="${f.name}">${f.name}</div>
        </div>
      `;
    }).join("");

    imgPreviewGrid.querySelectorAll(".thumb-remove").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-idx"));
        selectedFiles.splice(i, 1);
        renderImgPreviews();
      });
    });
  }

  classifiedForm?.addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    clsFeedback.classList.add("d-none");
    clsFeedback.classList.remove("alert-success","alert-danger","alert-info");
    clsFeedback.textContent = "";

    const title = (clsTitle.value || "").trim();
    const price = clsPrice.value ? Number(clsPrice.value) : null;
    const contact = (clsContact.value || "").trim();
    const description = (clsDesc.value || "").trim();

    if (!title || price==null || isNaN(price) || !contact) {
      clsFeedback.textContent = "Preencha os campos obrigat√≥rios: T√≠tulo, Valor e Contato.";
      clsFeedback.classList.remove("d-none");
      clsFeedback.classList.add("alert","alert-danger");
      return;
    }
    if (!currentUser) {
      clsFeedback.textContent = "Sess√£o expirada. Fa√ßa login novamente.";
      clsFeedback.classList.remove("d-none");
      clsFeedback.classList.add("alert","alert-danger");
      return;
    }

    try {
      const { serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js");

      // 1) Cria o an√∫ncio no Firestore (pendente/inativo)
      const docRef = await addDoc(collection(db,"memberClassifieds"), {
        title,
        description,
        price,
        whatsapp: contact,
        imageUrls: [],

        active: false,
        approved: false,

        paymentStatus: "pending",
        paymentUrl: PAYMENT_URL,
        pricePerDay: 1.00,
        minDays: 30,
        plannedActiveDays: 30,
        paymentCreatedAt: serverTimestamp(),

        ownerUid: currentUser.uid,
        ownerEmail: currentUser.email || null,
        ownerName: memberName,

        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      // 2) Upload de fotos (at√© 3)
      const urls = [];
      imgProgressList.innerHTML = "";
      if (selectedFiles.length) {
        const bars = selectedFiles.map((f, i) => {
          const id = `bar_${i}`;
          imgProgressList.insertAdjacentHTML("beforeend", `
            <div class="progress mb-2" style="height: 6px;">
              <div id="${id}" class="progress-bar" role="progressbar" style="width:0%"></div>
            </div>
          `);
          return document.getElementById(id);
        });

        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const bar  = bars[i];

          const pathBase = `classifieds/${currentUser.uid}/${docRef.id}`;
          const { url } = await uploadImageFile(
            file,
            pathBase,
            (pct) => { if (bar) bar.style.width = pct + "%"; },
            { targetKB: 200 }
          );
          urls.push(url);
        }

        await updateDoc(doc(db, "memberClassifieds", docRef.id), {
          imageUrls: urls,
          updatedAt: serverTimestamp()
        });
      }

      // 3) Feedback + redirect
      clsFeedback.innerHTML = `
        <strong>Classificado enviado!</strong><br>
        ${urls.length ? `${urls.length} foto(s) anexada(s).<br>` : ""}
        Ele ficar√° ativo por <strong>30 dias</strong> ap√≥s a confirma√ß√£o do pagamento.<br>
        Voc√™ ser√° levado agora √† tela de pagamento para concluir: <a href="${PAYMENT_URL}" target="_blank" rel="noopener">pagar agora</a>.
      `;
      clsFeedback.classList.remove("d-none");
      clsFeedback.classList.add("alert","alert-success");

      classifiedForm.reset();
      selectedFiles = [];
      renderImgPreviews();
      imgProgressList.innerHTML = "";

      setTimeout(()=>{
        const modal = bootstrap.Modal.getInstance(classifiedModalEl);
        modal?.hide();
        loadAllContent();
        window.location.href = PAYMENT_URL;
      }, 1200);

    } catch (err) {
      console.error(err);
      clsFeedback.textContent = "N√£o foi poss√≠vel enviar seu classificado. Tente novamente.";
      clsFeedback.classList.remove("d-none");
      clsFeedback.classList.add("alert","alert-danger");
    }
  });

  /* ================== Modal de visualiza√ß√£o simples ================== */
  function showViewModal(item){
    const linkPagamento = (item.paymentUrl || PAYMENT_URL);
    const div = document.createElement("div");
    div.className = "modal fade";
    div.tabIndex = -1;
    div.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">${item.title}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            ${carouselHtml(item.images, item.title, "view_"+item.id)}
            <p class="mt-3">${item.description||''}</p>
            <p><strong>Valor:</strong> ${item.price!=null ? 'R$ ' + Number(item.price).toLocaleString('pt-BR') : '‚Äî'}</p>
            <p><strong>Estado:</strong> ${item.approved ? 'Aprovado' : 'Aguardando aprova√ß√£o'} ‚Äî ${item.active ? 'Ativo' : 'Inativo'}</p>
            ${ isPendingPayment(item) ? `
              <div class="alert alert-warning small">
                Seu an√∫ncio est√° com pagamento pendente. Ele ser√° ativado por <strong>30 dias</strong> ap√≥s a confirma√ß√£o.
              </div>` : '' }
            <p class="small text-secondary">Criado em: ${fmtDate(item.createdAt)}</p>
          </div>
          <div class="modal-footer">
            ${ isPendingPayment(item) ? `<a class="btn btn-success" href="${linkPagamento}" target="_blank" rel="noopener">Pagar agora</a>` : '' }
            ${ item.active ? `<button class="btn btn-outline-secondary" id="modalDeactivateBtn">Desativar</button>` : '' }
            <button class="btn btn-danger" id="modalDeleteBtn">Excluir</button>
            <button class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(div);
    const modal = new bootstrap.Modal(div);
    modal.show();

    div.addEventListener('hidden.bs.modal', ()=>{ div.remove(); });

    div.querySelector('#modalDeactivateBtn')?.addEventListener('click', async ()=>{
      if (!confirm("Deseja realmente desativar este an√∫ncio?")) return;
      await deactivateClassified(item.id);
      modal.hide();
    });
    div.querySelector('#modalDeleteBtn')?.addEventListener('click', async ()=>{
      if (!confirm("Excluir o an√∫ncio √© irrevers√≠vel. Deseja continuar?")) return;
      await deleteClassified(item.id);
      modal.hide();
    });
  }

  /* ================== Troca de senha ================== */
  const changePasswordModalEl = document.getElementById("changePasswordModal");
  const changePasswordForm    = document.getElementById("changePasswordForm");
  const cpInfo    = document.getElementById("cpInfo");
  const cpError   = document.getElementById("cpError");
  const cpSuccess = document.getElementById("cpSuccess");

  const groupCurrentPassword = document.getElementById("groupCurrentPassword");
  const currentPassword = document.getElementById("currentPassword");
  const newPassword     = document.getElementById("newPassword");
  const confirmPassword = document.getElementById("confirmPassword");

  const federatedBlock  = document.getElementById("federatedBlock");
  const reauthPopupBtn  = document.getElementById("reauthPopupBtn");
  const savePasswordBtn = document.getElementById("savePasswordBtn");

  let currentUserEmail = "";
  let isPasswordProvider = false;
  let reauthOK = false;

  function clearMsgs() { [cpInfo, cpError, cpSuccess].forEach(el => { el.classList.add("d-none"); el.textContent = ""; }); }
  function senhaForteMin(s) { return typeof s === "string" && s.length >= 6; }

  changePasswordModalEl?.addEventListener("show.bs.modal", () => {
    clearMsgs();
    changePasswordForm.reset();
    reauthOK = false;

    const user = auth.currentUser;
    if (!user) {
      cpError.textContent = "Sess√£o expirada. Fa√ßa login novamente.";
      cpError.classList.remove("d-none");
      return;
    }

    const providers = (user.providerData || []).map(p => p.providerId);
    isPasswordProvider = providers.includes("password");

    if (isPasswordProvider) {
      groupCurrentPassword.classList.remove("d-none");
      federatedBlock.classList.add("d-none");
      cpInfo.textContent = "Informe sua senha atual e a nova senha.";
      cpInfo.classList.remove("d-none");
    } else {
      groupCurrentPassword.classList.add("d-none");
      federatedBlock.classList.remove("d-none");
      cpInfo.textContent = "Revalide sua sess√£o no provedor para definir uma nova senha sem e-mail.";
      cpInfo.classList.remove("d-none");
    }
  });

  reauthPopupBtn?.addEventListener("click", async () => {
    clearMsgs();
    const user = auth.currentUser;
    if (!user) {
      cpError.textContent = "Sess√£o expirada. Fa√ßa login novamente.";
      cpError.classList.remove("d-none");
      return;
    }

    try {
      const p = (user.providerData || [])[0]?.providerId || "";
      let provider;
      if (p === "google.com") provider = new GoogleAuthProvider();
      else if (p === "apple.com") provider = new OAuthProvider("apple.com");
      else provider = new GoogleAuthProvider();

      await reauthenticateWithPopup(user, provider);
      reauthOK = true;
      cpSuccess.textContent = "Sess√£o revalidada com sucesso. Agora defina a nova senha e salve.";
      cpSuccess.classList.remove("d-none");
    } catch (err) {
      cpError.textContent = traduzErroAuth(err);
      cpError.classList.remove("d-none");
    }
  });

  changePasswordForm?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    clearMsgs();

    const user = auth.currentUser;
    if (!user) {
      cpError.textContent = "Sess√£o expirada. Fa√ßa login novamente.";
      cpError.classList.remove("d-none");
      return;
    }

    const nova = newPassword.value.trim();
    const conf = confirmPassword.value.trim();
    if (nova !== conf) {
      cpError.textContent = "A confirma√ß√£o n√£o confere com a nova senha.";
      cpError.classList.remove("d-none");
      return;
    }
    if (!senhaForteMin(nova)) {
      cpError.textContent = "A nova senha precisa ter pelo menos 6 caracteres.";
      cpError.classList.remove("d-none");
      return;
    }

    savePasswordBtn.disabled = true;

    try {
      if (isPasswordProvider) {
        const curr = (currentPassword.value || "").trim();
        if (!curr) throw new Error("auth/missing-current-password");
        const cred = EmailAuthProvider.credential(user.email || "", curr);
        await reauthenticateWithCredential(user, cred);
        await updatePassword(user, nova);
      } else {
        if (!reauthOK) {
          cpInfo.textContent = "Clique em ‚ÄúRevalidar sess√£o‚Äù antes de salvar a nova senha.";
          cpInfo.classList.remove("d-none");
          savePasswordBtn.disabled = false;
          return;
        }
        await updatePassword(user, nova);
      }

      cpSuccess.textContent = "Senha alterada com sucesso!";
      cpSuccess.classList.remove("d-none");
      setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(changePasswordModalEl);
        modal?.hide();
      }, 1500);

    } catch (err) {
      cpError.textContent = traduzErroAuth(err);
      cpError.classList.remove("d-none");
    } finally {
      savePasswordBtn.disabled = false;
    }
  });

  function traduzErroAuth(err) {
    const code = String(err?.code || "").toLowerCase();
    if (code.includes("auth/wrong-password")) return "Senha atual incorreta.";
    if (code.includes("auth/invalid-credential")) return "Credenciais inv√°lidas.";
    if (code.includes("auth/missing-current-password")) return "Informe sua senha atual.";
    if (code.includes("auth/requires-recent-login")) return "Por seguran√ßa, revalide sua sess√£o e tente novamente.";
    if (code.includes("auth/weak-password")) return "A nova senha √© fraca. Use ao menos 6 caracteres.";
    if (code.includes("popup-closed-by-user")) return "Popup fechado antes de concluir a revalida√ß√£o.";
    if (err?.message) return err.message;
    return "Ocorreu um erro. Tente novamente.";
  }
</script>

<!-- MODAL: Novo classificado (associado) -->
<div class="modal fade" id="classifiedModal" tabindex="-1" aria-labelledby="classifiedLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="classifiedForm">
      <div class="modal-header">
        <h5 class="modal-title" id="classifiedLabel">Cadastrar novo classificado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-warning">
          <strong>Aten√ß√£o:</strong> o an√∫ncio tem custo de <strong>R$ 1,00 por dia</strong>, com <strong>m√≠nimo de 30 dias</strong>. Ele ficar√° <strong>ativo por 30 dias ap√≥s a confirma√ß√£o do pagamento</strong>.
        </div>

        <div id="clsFeedback" class="d-none"></div>

        <div class="mb-3">
          <label class="form-label">T√≠tulo <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="clsTitle" required>
        </div>

        <div class="row g-3">
          <div class="col-sm-6">
            <label class="form-label">Valor (R$) <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="clsPrice" required>
          </div>
          <div class="col-sm-6">
            <label class="form-label">Contato (WhatsApp) <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="clsContact" placeholder="DDD+N√∫mero" required>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">Descri√ß√£o (opcional)</label>
          <textarea class="form-control" id="clsDesc" rows="3" placeholder="Detalhes do an√∫ncio"></textarea>
        </div>

        <!-- Fotos -->
        <div class="mt-3">
          <label class="form-label d-flex align-items-center justify-content-between">
            <span>Fotos do an√∫ncio (at√© 3 imagens)</span>
            <small class="text-secondary">JPEG/PNG ¬∑ ~200 KB por foto (comprimido automaticamente)</small>
          </label>

          <div class="d-flex gap-2 mb-2">
            <input type="file" id="clsImages" accept="image/*" multiple class="d-none">
            <button type="button" class="btn btn-outline-primary btn-sm" id="btnPickImgs">Selecionar fotos</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnClearImgs">Limpar</button>
          </div>

          <div id="imgPreviewGrid" class="row g-2"></div>
          <div id="imgProgressList" class="mt-2"></div>

          <div class="form-text">
            Dica: escolha a principal em primeiro lugar. Voc√™ pode remover uma foto clicando no ‚Äúx‚Äù da miniatura.
          </div>
        </div>

        <div class="form-text mt-2">
          Ap√≥s cadastrar, voc√™ ser√° direcionado para a <strong>p√°gina de pagamento</strong> para concluir (Mercado Pago).
        </div>
      </div>

      <div class="modal-footer">
        <a class="btn btn-outline-secondary" href="classificados.html">Ver classificados</a>
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Enviar e ir para pagamento</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Trocar senha -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="changePasswordForm">
      <div class="modal-header">
        <h5 class="modal-title" id="changePasswordLabel">Trocar senha</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <div id="cpInfo" class="alert alert-info d-none small mb-3"></div>
        <div id="cpError" class="alert alert-danger d-none small mb-3"></div>
        <div id="cpSuccess" class="alert alert-success d-none small mb-3"></div>

        <div class="mb-3" id="groupCurrentPassword">
          <label class="form-label">Senha atual</label>
          <input type="password" class="form-control" id="currentPassword" autocomplete="current-password">
        </div>

        <div class="mb-3">
          <label class="form-label">Nova senha</label>
          <input type="password" class="form-control" id="newPassword" autocomplete="new-password" required>
          <div class="form-text">M√≠nimo de 6 caracteres.</div>
        </div>

        <div class="mb-1">
          <label class="form-label">Confirmar nova senha</label>
          <input type="password" class="form-control" id="confirmPassword" autocomplete="new-password" required>
        </div>

        <div class="mt-3 d-none" id="federatedBlock">
          <p class="small text-secondary mb-2">
            Sua conta usa um provedor externo (ex.: Google/Apple). Primeiro vamos revalidar seu login em um popup; em seguida, definiremos a nova senha aqui mesmo, sem e-mail.
          </p>
          <button type="button" class="btn btn-outline-primary btn-sm" id="reauthPopupBtn">Revalidar sess√£o</button>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="savePasswordBtn">Salvar nova senha</button>
      </div>
    </form>
  </div>
</div>
</body>
</html>
