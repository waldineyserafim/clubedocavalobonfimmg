<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Serviços do Associado — Clube do Cavalo - Bonfim MG</title>
  <meta name="description" content="Serviços oferecidos aos associados." />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="icon" type="image/png" href="assets/img/logo_CCBMG.png" />
  <style>
    :root{ --brand:#111279; --accent:#2a9d8f; }
    .bg-primary{ background-color:var(--brand)!important; }
    .btn-primary{ background-color:var(--brand)!important; border-color:var(--brand)!important; }
    .btn-outline-primary{ color:var(--brand)!important; border-color:var(--brand)!important; }
    .text-primary{ color:var(--brand)!important; }
    .brand-logo{ height:36px; width:auto; margin-right:.5rem; filter:brightness(0) invert(1); }
    @media (min-width:992px){ .brand-logo{ height:42px; } }
    header{ padding-top:1.25rem; padding-bottom:1rem; }
    .chip{ border:1px solid rgba(0,0,0,.08); background:#fff; border-radius:999px; padding:.35rem .75rem; font-size:.85rem; display:inline-flex; gap:.5rem; align-items:center; }
    .chip .dot{ width:.5rem; height:.5rem; border-radius:50%; display:inline-block; }
    .dot-ok{ background:#28a745; } .dot-warn{ background:#ffc107; } .dot-bad{ background:#dc3545; }
     .subnav{ position:sticky; top:56px; z-index:1020; background:#fff; border-top:1px solid #e9ecef; border-bottom:1px solid #e9ecef; }
    @media (min-width:992px){ .subnav{ top:64px; } }
    .subnav .btn{ border-radius:999px; }

    /* Cards */
    .card{ border:1px solid rgba(0,0,0,.06); border-radius:14px; overflow:hidden; }
    .card .carousel,
    .card img{ width:100%; height:200px; background:#fff; }
    .card img{ object-fit:contain; }      /* igual Classificados */
    .carousel-indicators [data-bs-target]{ background:#6c757d; }
    .carousel-indicators .active{ background:#212529; }

    .search-wrap{ position:relative; } .search-wrap input{ padding-left:2.25rem; }
    .search-wrap .ico{ position:absolute; left:.75rem; top:50%; transform:translateY(-50%); opacity:.55; }

    /* >>> Ajuste para setas SVG laterais no carrossel */
    .carousel-control-prev, .carousel-control-next{ width:10%; }
    .carousel-control-prev svg, .carousel-control-next svg{
      filter: drop-shadow(0 1px 3px rgba(0,0,0,.3));
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <img class="brand-logo" src="assets/img/logo_CCBMG.png" alt="Logo">
    <a class="navbar-brand fw-bold text-truncate" href="index.html">Clube do Cavalo - Bonfim MG</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
        <li class="nav-item"><a class="nav-link" href="classificados.html">Classificados</a></li>
        <li class="nav-item"><a class="nav-link" href="events.html">Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="partners.html">Parcerias</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html">Fotos</a></li>
        <li class="nav-item"><a class="nav-link" href="board.html">Diretoria</a></li>
        <li class="nav-item"><a class="nav-link" href="sobre.html">Sobre o Clube</a></li>
        <li class="nav-item d-none" id="adminBtn"><a class="btn btn-warning text-dark ms-4" href="admin.html">Painel Admin</a></li>
      </ul>
    </div>
  </div>
</nav>

<header class="bg-light border-bottom">
  <div class="container d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div class="w-100">
      <h1 class="h4 mb-1">Serviços para Associados</h1>
      <div class="text-secondary small">Bem-vindo(a), <strong id="memberName">—</strong></div>
      <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
        <span id="chipPlan" class="chip d-none">Plano: <strong id="chipPlanText" class="ms-1">—</strong></span>
        <span id="chipPayStatus" class="chip d-none"><span id="chipPayDot" class="dot"></span><span id="chipPayText">Situação: —</span></span>
        <span id="chipNextDue" class="chip d-none">Vencimento: <strong id="chipNextDueText" class="ms-1">—</strong></span>
        <a href="pay.html" id="btnRenewPlan" class="btn btn-success btn-sm d-none">Renovar plano</a>
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary" href="pg_associado.html">Área do Associado</a>
      <button id="logoutBtn" class="btn btn-primary">Sair</button>
    </div>
  </div>
</header>

<div class="subnav">
  <div class="container py-2 d-flex gap-2 flex-nowrap" style="overflow:auto">
    <a class="btn btn-sm btn-outline-primary" href="produtos_associado.html">Produtos</a>
    <a class="btn btn-sm btn-primary">Serviços</a>
    <a class="btn btn-sm btn-outline-primary" href="classificados.html">Classificados</a>
  </div>
</div>

<main class="container my-3">
  <div class="row g-2 align-items-center mb-3">
    <div class="col-12 col-md-8">
      <div class="search-wrap">
        <svg class="ico" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="searchInput" type="search" class="form-control" placeholder="Buscar serviços..." autocomplete="off">
      </div>
    </div>
    <div class="col-12 col-md-4 text-md-end small text-secondary">
      <span id="countLabel">0 serviços</span>
    </div>
  </div>

  <div id="listLoading" class="text-center py-4">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 text-secondary small">Carregando…</div>
  </div>
  <div id="grid" class="row g-3 d-none"></div>
  <div id="empty" class="text-center text-muted py-4 d-none">Nenhum serviço encontrado.</div>
  <div id="error" class="alert alert-danger d-none mt-3"></div>
</main>

<footer class="mt-5 py-4 bg-body-tertiary border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div><strong>Clube do Cavalo - Bonfim MG</strong> — Promovendo a cultura equestre.</div>
    <div class="text-secondary small text-center">© 2025 Clube do Cavalo - Bonfim MG. Todos os direitos reservados.<br>
      <span>Sistema de Gestão de Associações Desenvolvido por <u>Serafim Technologies</u></span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { auth, db, getUserProfile, getUserStatus } from "./firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const memberNameEl = document.getElementById("memberName");
  const btnRenewPlan = document.getElementById("btnRenewPlan");
  const chipPlan = document.getElementById("chipPlan");
  const chipPlanText = document.getElementById("chipPlanText");
  const chipPayStatus = document.getElementById("chipPayStatus");
  const chipPayText = document.getElementById("chipPayText");
  const chipPayDot = document.getElementById("chipPayDot");
  const chipNextDue = document.getElementById("chipNextDue");
  const chipNextDueText = document.getElementById("chipNextDueText");
  const adminBtn = document.getElementById("adminBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const listLoading = document.getElementById("listLoading");
  const grid = document.getElementById("grid");
  const empty = document.getElementById("empty");
  const errorBox = document.getElementById("error");
  const searchInput = document.getElementById("searchInput");
  const countLabel = document.getElementById("countLabel");

  const norm = (s)=> (s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();
  const fmtDate = (ts)=> {
    if (!ts) return "—";
    try { const d = ts?.toDate ? ts.toDate() : new Date(ts);
      return new Intl.DateTimeFormat('pt-BR',{dateStyle:'medium'}).format(d);
    } catch { return "—"; }
  };

  function setPayStatusBadge(status){
    const s = String(status||"").toLowerCase();
    chipPayStatus.classList.remove("d-none");
    if (s.includes("em dia")) { chipPayText.textContent="Situação: Em dia"; chipPayDot.className="dot dot-ok"; }
    else if (s.includes("atras")) { chipPayText.textContent="Situação: Atrasada"; chipPayDot.className="dot dot-warn"; btnRenewPlan.classList.remove("d-none"); }
    else { chipPayText.textContent="Situação: Vencida"; chipPayDot.className="dot dot-bad"; btnRenewPlan.classList.remove("d-none"); }
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="login.html"; return; }
    const p = await getUserProfile(user.uid) || {};
    memberNameEl.textContent = p.nome || (user.email?.split("@")[0]) || "associado";
    const role = String(p.role||"").toLowerCase();
    if (/(admin|master)/.test(role)) adminBtn.classList.remove("d-none");

    const st = await getUserStatus(user.uid);
    let planName = p.planName || p.plano || "—";
    let nextDue = p.nextDue || p.vencimento || p.planEnd || p.endDate;
    if (p.finance?.summary?.planName) planName = p.finance.summary.planName;
    if (p.finance?.summary?.nextDue) nextDue = p.finance.summary.nextDue;

    if (planName && planName !== "—"){ chipPlanText.textContent = planName; chipPlan.classList.remove("d-none"); }
    if (nextDue){ chipNextDueText.textContent = fmtDate(nextDue); chipNextDue.classList.remove("d-none"); }
    setPayStatusBadge(st?.pending ? "Atrasada" : (st?.active ? "Em dia" : "Vencida"));
    if (!st?.active){ btnRenewPlan.classList.remove("d-none"); }

    loadServices("");
  });

  logoutBtn?.addEventListener("click", async ()=>{
    try{ await signOut(auth); location.href="login.html"; }
    catch(e){ alert("Não foi possível sair: " + e.message); }
  });

  async function fetchServices(){
    const q = query(collection(db,"memberServices"), where("active","==", true));
    const snap = await getDocs(q);
    const arr = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    arr.sort((a,b)=>{
      const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt? new Date(a.createdAt).getTime():0);
      const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt? new Date(b.createdAt).getTime():0);
      return tb - ta;
    });
    return arr;
  }

  function renderCarousel(imgs, id){
    if (!imgs || !imgs.length) imgs = ["assets/img/placeholder.png"];
    const cid = `car_${id}`;
    const items = imgs.map((src,i)=>`
      <div class="carousel-item ${i===0?'active':''}">
        <img src="${src}" alt="imagem do serviço">
      </div>`).join("");
    const indicators = imgs.length>1
      ? `<div class="carousel-indicators">
           ${imgs.map((_,i)=>`<button type="button" data-bs-target="#${cid}" data-bs-slide-to="${i}" ${i===0?'class="active" aria-current="true"':''}></button>`).join("")}
         </div>`
      : "";
    const controls = imgs.length>1
      ? `
        <button class="carousel-control-prev" type="button" data-bs-target="#${cid}" data-bs-slide="prev" aria-label="Anterior">
          <!-- seta SVG esquerda -->
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 16 16" fill="black">
            <path d="M11 1 3 8l8 7" stroke="black" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#${cid}" data-bs-slide="next" aria-label="Próximo">
          <!-- seta SVG direita -->
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 16 16" fill="black">
            <path d="M5 1l8 7-8 7" stroke="black" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>`
      : "";
    return `
      <div id="${cid}" class="carousel slide" ${imgs.length>1?'data-bs-ride="carousel" data-bs-interval="5000"':''}>
        <div class="carousel-inner">${items}</div>
        ${controls}
        ${indicators}
      </div>`;
  }

  function renderCard(svc){
    const imgs = Array.isArray(svc.imageUrls) && svc.imageUrls.length ? svc.imageUrls : [svc.imageUrl || "assets/img/placeholder.png"];
    const wpp = (svc.whatsapp||"").replace(/\D/g,"");
    const wppUrl = wpp ? `https://wa.me/${wpp}?text=${encodeURIComponent("Vi seu serviço no Clube do Cavalo!")}` : "#";
    return `
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          ${renderCarousel(imgs, svc.id)}
          <div class="card-body">
            <h5 class="card-title mb-1">${svc.title||"Serviço"}</h5>
            ${svc.benefit ? `<div class="small text-success mb-2">${svc.benefit}</div>` : ""}
            <p class="card-text text-secondary">${(svc.description||"").slice(0,160)}${(svc.description||"").length>160?"…":""}</p>
            <div class="d-flex flex-wrap gap-2">
              ${wpp ? `<a class="btn btn-outline-success btn-sm" target="_blank" href="${wppUrl}">WhatsApp</a>` : ""}
            </div>
          </div>
        </div>
      </div>`;
  }

  let allServices = [];
  function loadServices(term){
    listLoading.classList.remove("d-none");
    grid.classList.add("d-none");
    empty.classList.add("d-none");
    errorBox.classList.add("d-none");
    (async ()=>{
      try{
        if (!allServices.length) allServices = await fetchServices();
        const t = norm(term||"");
        const filtered = t ? allServices.filter(s =>
          norm(s.title).includes(t) || norm(s.description).includes(t) || norm(s.benefit).includes(t)
        ) : allServices;
        countLabel.textContent = `${filtered.length} serviço${filtered.length===1?"":"s"}`;
        grid.innerHTML = filtered.map(renderCard).join("");
        listLoading.classList.add("d-none");
        if (!filtered.length) empty.classList.remove("d-none"); else grid.classList.remove("d-none");
      }catch(e){
        console.error(e);
        listLoading.classList.add("d-none");
        errorBox.textContent = "Falha ao carregar serviços."; errorBox.classList.remove("d-none");
      }
    })();
  }

  const deb = (fn,ms=250)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
  searchInput.addEventListener("input", deb(()=> loadServices(searchInput.value), 300));
</script>
</body>
</html>
